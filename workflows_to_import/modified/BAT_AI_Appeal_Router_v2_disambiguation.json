{
  "id": "Flhmu33l0ZhZhr90",
  "name": "BAT AI Appeal Router",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "a0d67898-5410-4cc0-9793-9c4d145f5224",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -2336,
        -304
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  a.*,\n  b.name as brand_name,\n  m.name as model_name,\n  c.phone as client_phone,\n  c.name as client_name,\n  COALESCE(\n    (SELECT json_agg(json_build_object(\n      'timestamp', mh.created_at,\n      'is_client', CASE WHEN mh.message_type = 'client' THEN true ELSE false END,\n      'text', mh.message_text\n    ) ORDER BY mh.created_at ASC)\n    FROM messages_history mh \n    WHERE mh.appeal_id = a.id),\n    '[]'::json\n  ) as messages,\n  COALESCE(\n    (SELECT json_agg(json_build_object(\n      'id', ad.id,\n      'device_index', ad.device_index,\n      'brand_id', ad.brand_id,\n      'brand_name', db.name,\n      'model_id', ad.model_id,\n      'model_name', dm.name,\n      'repairs', (SELECT json_agg(json_build_object(\n        'id', ar.id,\n        'category_id', ar.repair_category_id,\n        'category_name', rc.name\n      )) FROM appeal_repairs ar LEFT JOIN repair_categories rc ON rc.id = ar.repair_category_id WHERE ar.appeal_device_id = ad.id)\n    ) ORDER BY ad.device_index)\n    FROM appeal_devices ad\n    LEFT JOIN brands db ON db.id = ad.brand_id\n    LEFT JOIN models dm ON dm.id = ad.model_id\n    WHERE ad.appeal_id = a.id),\n    '[]'::json\n  ) as devices\nFROM appeals a\nLEFT JOIN brands b ON b.id = a.brand_id AND b.tenant_id = a.tenant_id\nLEFT JOIN models m ON m.id = a.model_id AND m.tenant_id = a.tenant_id\nLEFT JOIN clients c ON c.id = a.client_id AND c.tenant_id = a.tenant_id\nWHERE a.id = '{{ $json.appeal.id }}'::uuid\n  AND a.tenant_id = '{{ $json.tenant_id }}'::uuid;",
        "options": {}
      },
      "id": "50019610-d965-49a5-a2f9-4d6354a98a2f",
      "name": "Load Appeal & Devices",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -2128,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  field_name,\n  is_required,\n  collection_order,\n  tool_name as extraction_prompt\nFROM context_fields_config\nWHERE tenant_id = '{{ $json.tenant_id }}'::uuid\n  AND (deal_type_id IS NULL)\n  AND is_active = true\nORDER BY collection_order ASC;",
        "options": {}
      },
      "id": "2e961b81-e79d-47b0-8340-c08ca681384b",
      "name": "Load Fields Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1904,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare context with device disambiguation\nconst devices = $input.first().json.devices || [];\nconst appeal = $input.first().json.appeal;\nconst history = $input.first().json.history || [];\n\n// Group devices by brand+model\nconst groups = {};\ndevices.forEach(d => {\n  const key = `${d.brand_name || ''} ${d.model_name || ''}`.trim();\n  if (!groups[key]) groups[key] = [];\n  groups[key].push(d);\n});\n\n// Check if disambiguation needed - multiple devices of same type\nlet needsDisambiguation = false;\nlet disambiguationInfo = '';\n\nfor (const [model, devs] of Object.entries(groups)) {\n  if (devs.length > 1) {\n    // Multiple same devices - check if we can distinguish by repairs\n    const withRepairs = devs.filter(d => d.repairs && d.repairs.length > 0);\n    const withoutRepairs = devs.filter(d => !d.repairs || d.repairs.length === 0);\n    \n    if (withoutRepairs.length > 1) {\n      // Multiple same devices without distinct repairs\n      needsDisambiguation = true;\n      disambiguationInfo += `–ù–µ—Å–∫–æ–ª—å–∫–æ ${model} (${devs.length} —à—Ç). `;\n    }\n  }\n}\n\n// Build device list for context\nconst deviceList = devices.map((d, i) => {\n  const repairs = d.repairs?.map(r => r.repair_type).join(', ') || '–Ω–µ—Ç —Ä–µ–º–æ–Ω—Ç–æ–≤';\n  return `#${i}: ${d.brand_name || '?'} ${d.model_name || '?'} - ${repairs}`;\n}).join('\n');\n\nreturn {\n  json: {\n    appeal,\n    devices,\n    deviceList,\n    history,\n    needsDisambiguation,\n    disambiguationInfo,\n    deviceCount: devices.length\n  }\n};"
      },
      "id": "13192c78-f94e-42e1-9e2a-1797b2c9e58d",
      "name": "Prepare Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        -304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "needs-extraction",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              },
              "leftValue": "={{ $json.is_complete }}",
              "rightValue": ""
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "1db104ed-a232-40ae-99fb-53379871d05d",
      "name": "Needs Extraction?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1456,
        -304
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "aEzuOXgpLBTNZ4ie",
          "mode": "list",
          "cachedResultUrl": "/workflow/aEzuOXgpLBTNZ4ie",
          "cachedResultName": "BAT AI Task Dispatcher"
        },
        "options": {}
      },
      "id": "b585369b-aea1-4210-9542-8ed6c99b2a81",
      "name": "Call Task Dispatcher",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [
        -1248,
        -400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Skip extraction - all data already collected\nconst context = $input.item.json;\n\nreturn {\n  action: 'skip_extraction',\n  appeal_id: context.appeal_id,\n  tenant_id: context.tenant_id,\n  extracted_data: {\n    brand: context.current_state.brand,\n    brand_id: context.current_state.brand_id,\n    model: context.current_state.model,\n    model_id: context.current_state.model_id,\n    repair_category: context.current_state.repairs?.[0]?.category_name,\n    repair_category_id: context.current_state.repairs?.[0]?.category_id\n  },\n  total_tasks: 0,\n  completed: 0,\n  elapsed_ms: 0\n};"
      },
      "id": "819b6c8d-5c1a-453d-84aa-f63101c8131a",
      "name": "Skip Extraction",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1248,
        -208
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build AI context string\nconst data = $input.first().json;\nconst { appeal, devices, deviceList, history, needsDisambiguation, disambiguationInfo } = data;\n\nlet context = '';\n\n// If need to clarify which device - focus on MODEL and REPAIRS\nif (needsDisambiguation) {\n  context += `‚ö†Ô∏è –£–¢–û–ß–ù–ò –£–°–¢–†–û–ô–°–¢–í–û: ${disambiguationInfo}–°–ø—Ä–æ—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∫–∞–∫–æ–µ –∏–º–µ–Ω–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±—Å—É–∂–¥–∞–µ–º (–ø–æ –º–æ–¥–µ–ª–∏ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–µ).\n\n`;\n}\n\n// Appeal info\ncontext += `–ó–∞—è–≤–∫–∞ #${appeal.id}\n`;\ncontext += `–ö–∞–Ω–∞–ª: ${appeal.channel}\n`;\nif (appeal.conversation_context) context += `–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${appeal.conversation_context}\n`;\n\n// Devices\ncontext += `\n–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞:\n${deviceList}\n`;\n\n// Recent history\nif (history.length > 0) {\n  const recent = history.slice(-5);\n  context += `\n–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${recent.length}):\n`;\n  recent.forEach(h => {\n    context += `[${h.direction}] ${h.message_text?.substring(0, 100)}...\n`;\n  });\n}\n\nreturn { json: { context, ...data } };"
      },
      "id": "66416666-711d-4d6d-93a1-b0ae34a6b3bf",
      "name": "Build AI Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        -304
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chatInput }}",
        "options": {
          "systemMessage": "–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ —Ä–µ–º–æ–Ω—Ç—É —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤.\n\n–ü–†–ê–í–ò–õ–ê:\n1. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ –ø–æ –¥–µ–ª—É (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)\n2. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown\n3. –ì–æ–≤–æ—Ä–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —è–∑—ã–∫–æ–º\n4. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å\n5. –ï—Å–ª–∏ –≤—Å—ë –∑–∞–ø–æ–ª–Ω–µ–Ω–æ - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å\n6. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é - —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –∫–ª—é—á–µ–≤–æ–µ\n\n–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:\n- \"–ü–æ–Ω—è–ª, —Ä–µ–º–æ–Ω—Ç iPhone 12 Pro. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –ø–æ—á–∏–Ω–∏—Ç—å?\"\n- \"–ó–∞–º–µ–Ω–∞ –¥–∏—Å–ø–ª–µ—è –Ω–∞ iPhone 14, –∑–∞–ø—á–∞—Å—Ç—å –Ω–∞—à–∞. –°–µ–π—á–∞—Å —Ä–∞—Å—Å—á–∏—Ç–∞—é —Å—Ç–æ–∏–º–æ—Å—Ç—å.\"\n- \"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\"\n- \"–≠—Ç–æ –≤—Ç–æ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –∫ –∑–∞—è–≤–∫–µ –∏–ª–∏ –∑–∞–º–µ–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ?\""
        }
      },
      "id": "64f1d086-e385-49d6-9ffc-312062f17dd7",
      "name": "AI Response Generator",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -368,
        -304
      ]
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 300,
          "temperature": 0.7
        }
      },
      "id": "00218086-7cf7-4a2b-8f20-d9f54e906762",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -448,
        -80
      ],
      "credentials": {
        "openAiApi": {
          "id": "ptoy1RvCOn39G0Af",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–†–ê–í–ö–ê –¥–ª—è —É–∑–ª–∞ \"Prepare Response\" –≤ BAT AI Appeal Router (Flhmu33l0ZhZhr90)\r\n// –î–æ–±–∞–≤–ª–µ–Ω–æ: operation_mode –¥–ª—è –≤–µ—Ç–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç/–ø–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç\r\n\r\nconst context = $('Build AI Context').first().json;\r\nconst aiResponse = $input.first().json;\r\n\r\nconst responseText = aiResponse.output || aiResponse.text || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ\r\nlet nextAction = 'continue';\r\nif (context.is_complete) {\r\n  nextAction = 'calculate_cost';\r\n} else if (context.missing_fields.length > 0) {\r\n  nextAction = 'wait_clarification';\r\n}\r\n\r\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î\r\nlet route = 'minimal';\r\nif (context.extracted_data.brand_id && context.extracted_data.model_id && context.extracted_data.repair_category_id) {\r\n  route = 'full';\r\n} else if (context.extracted_data.brand_id || context.extracted_data.model_id) {\r\n  route = 'partial';\r\n}\r\n\r\n// –î–û–ë–ê–í–õ–ï–ù–û: –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã AI (auto = —Å—Ä–∞–∑—É –∫–ª–∏–µ–Ω—Ç—É, assist = –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É)\r\nconst operationMode = context.operation_mode || 'assist';\r\n\r\nreturn {\r\n  appeal_id: context.appeal_id,\r\n  tenant_id: context.tenant_id,\r\n  channel: context.channel,\r\n  external_chat_id: context.external_chat_id,\r\n  client_name: context.client_name,\r\n  response_text: responseText,\r\n  next_action: nextAction,\r\n  route: route,\r\n  extracted_data: context.extracted_data,\r\n  completion_percentage: context.completion_percentage,\r\n  dispatcher_result: context.dispatcher_result,\r\n  devices: context.devices,\r\n  device_count: context.device_count,\r\n\r\n  // –î–û–ë–ê–í–õ–ï–ù–û: –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã\r\n  operation_mode: operationMode,\r\n\r\n  // –î–ª—è Operator Notifier\r\n  approval_data: {\r\n    channel: context.channel,\r\n    external_chat_id: context.external_chat_id,\r\n    appeal_id: context.appeal_id,\r\n    client_name: context.client_name,\r\n    response_text: responseText,\r\n    next_action: nextAction,\r\n    appeal: context.appeal,\r\n    client: context.client || {},\r\n    extracted_data: context.extracted_data,\r\n    operation_mode: operationMode,\r\n    completeness: {\r\n      percentage: context.completion_percentage,\r\n      missing: context.missing_fields\r\n    }\r\n  }\r\n};\r\n"
      },
      "id": "73af9dba-6019-4664-a190-65f3a6c9fcf2",
      "name": "Prepare Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        -304
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "full",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "full"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "partial",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "partial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.route }}",
                    "rightValue": "minimal",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "minimal"
            }
          ]
        },
        "options": {}
      },
      "id": "f4b6bae2-38c7-4c61-831e-6163614b37ea",
      "name": "Route by Completeness",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        384,
        -320
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Full update: appeal_devices + appeal_repairs\nWITH device_upsert AS (\n  INSERT INTO appeal_devices (appeal_id, device_index, brand_id, model_id)\n  VALUES (\n    '{{ $json.appeal_id }}'::uuid,\n    COALESCE((SELECT MAX(device_index) + 1 FROM appeal_devices WHERE appeal_id = '{{ $json.appeal_id }}'::uuid), 0),\n    {{ $json.extracted_data.brand_id ? \"'\" + $json.extracted_data.brand_id + \"'::uuid\" : 'NULL' }},\n    {{ $json.extracted_data.model_id ? \"'\" + $json.extracted_data.model_id + \"'::uuid\" : 'NULL' }}\n  )\n  ON CONFLICT (appeal_id, device_index) \n  DO UPDATE SET \n    brand_id = COALESCE(EXCLUDED.brand_id, appeal_devices.brand_id),\n    model_id = COALESCE(EXCLUDED.model_id, appeal_devices.model_id),\n    updated_at = NOW()\n  RETURNING id\n)\nINSERT INTO appeal_repairs (appeal_device_id, repair_category_id)\nSELECT \n  (SELECT id FROM device_upsert),\n  {{ $json.extracted_data.repair_category_id ? \"'\" + $json.extracted_data.repair_category_id + \"'::uuid\" : 'NULL' }}\nWHERE {{ $json.extracted_data.repair_category_id ? 'true' : 'false' }};\n\nUPDATE appeals \nSET \n  updated_at = NOW(),\n  stage = '–†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏',\n  context_completion_percentage = {{ $json.completion_percentage }}\nWHERE id = '{{ $json.appeal_id }}'::uuid;",
        "options": {}
      },
      "id": "e24f2775-ed8b-4afb-81ed-fd0f6f968d97",
      "name": "Update Full Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        608,
        -480
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  WITH device_upsert AS (\n    INSERT INTO appeal_devices (appeal_id, tenant_id, device_index, brand_id, model_id)\n    VALUES (\n      '{{ $json.appeal_id }}'::uuid,\n      '{{ $json.tenant_id }}'::uuid,\n      COALESCE((SELECT MAX(device_index) + 1 FROM appeal_devices WHERE appeal_id = '{{ $json.appeal_id }}'::uuid), 0),\n      {{ $json.extracted_data.brand_id ? \"'\" + $json.extracted_data.brand_id + \"'::uuid\" : 'NULL' }},\n      {{ $json.extracted_data.model_id ? \"'\" + $json.extracted_data.model_id + \"'::uuid\" : 'NULL' }}\n    )\n    ON CONFLICT (appeal_id, device_index)\n    DO UPDATE SET\n      brand_id = COALESCE(EXCLUDED.brand_id, appeal_devices.brand_id),\n      model_id = COALESCE(EXCLUDED.model_id, appeal_devices.model_id),\n      updated_at = NOW()\n    RETURNING id\n  )\n  SELECT id FROM device_upsert;\n\n  UPDATE appeals\n  SET\n    updated_at = NOW(),\n    context_completion_percentage = {{ $json.completion_percentage }}\n  WHERE id = '{{ $json.appeal_id }}'::uuid;\n",
        "options": {}
      },
      "id": "a0628b7d-95e2-4658-83a4-6cb1ea854bbb",
      "name": "Update Partial Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        608,
        -304
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Minimal update: just timestamp and stage\nUPDATE appeals \nSET \n  updated_at = NOW(),\n  stage = COALESCE(stage, '–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'),\n  context_completion_percentage = {{ $json.completion_percentage }}\nWHERE id = '{{ $json.appeal_id }}'::uuid;",
        "options": {}
      },
      "id": "5e96e5a9-1785-406e-9535-558447b44905",
      "name": "Update Minimal",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        608,
        -128
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO messages_history (tenant_id, appeal_id, message_type, message_text, channel)\n  VALUES (\n    '{{ $('Prepare Context').item.json.tenant_id }}'::uuid,\n    '{{ $('Prepare Response').item.json.appeal_id }}'::uuid,\n    'agent',\n    '{{ $('Prepare Response').item.json.response_text.replace(/'/g, \"''\") }}',\n    '{{ $('Prepare Response').item.json.channel }}'\n  );",
        "options": {}
      },
      "id": "e8549dae-9dab-454e-8b7a-6185979facc2",
      "name": "Save Response",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1504,
        -304
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": "GUeLgLcNnawYfpf9",
        "options": {}
      },
      "id": "7f51871d-380d-4e71-bc29-f28cf4637575",
      "name": "Call Operator Notifier",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        2400,
        -192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"appeal_id\": $('Prepare Response').item.json.appeal_id,\n  \"response_text\": $('Prepare Response').item.json.response_text,\n  \"next_action\": $('Prepare Response').item.json.next_action,\n  \"completion_percentage\": $('Prepare Response').item.json.completion_percentage,\n  \"tasks_completed\": $('Prepare Response').item.json.dispatcher_result?.completed || 0\n} }}",
        "options": {}
      },
      "id": "f94a4294-cd5d-43de-92f5-abb293eb5272",
      "name": "Return Result",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2624,
        -208
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ó–∞–º–µ–Ω–∞ Merge node –Ω–∞ Code node\n// –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª—é–±–æ–≥–æ –≤—Ö–æ–¥–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è\n\nconst items = $input.all();\n\nconsole.log('=== CODE MERGE ===');\nconsole.log('Received items:', items.length);\n\nif (items.length === 0) {\n  console.log('No items received');\n  return [];\n}\n\n// –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π item —Å –¥–∞–Ω–Ω—ã–º–∏\nconst result = items[0].json;\n\nconsole.log('Passing through:', Object.keys(result));\nconsole.log('Appeal ID:', result.appeal?.id);\n\nreturn result;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -944,
        -304
      ],
      "id": "51000434-2676-4ab2-88f0-494e228c738d",
      "name": "Merge Results"
    },
    {
      "parameters": {
        "jsCode": "// Merge After Update - –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Prepare Response\n  // UPDATE –Ω–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é\n\n  let data = null;\n\n  // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Prepare Response\n  try {\n    data = $('Prepare Response').first().json;\n    console.log('Got data from Prepare Response');\n  } catch (e) {\n    console.log('Could not access Prepare Response:', e.message);\n  }\n\n  if (!data || !data.appeal_id) {\n    console.error('No data from Prepare Response!');\n    // Fallback –Ω–∞ input\n    const items = $input.all();\n    if (items.length > 0) {\n      data = items[0].json;\n    }\n  }\n\n  console.log('=== MERGE AFTER UPDATE ===');\n  console.log('Appeal ID:', data?.appeal_id);\n  console.log('Tenant ID:', data?.tenant_id);\n  console.log('Response text:', data?.response_text?.substring(0, 50));\n\n  return data || {};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        -304
      ],
      "id": "7c414cb1-21f3-4c3c-a233-55897771d195",
      "name": "Merge After Update"
    },
    {
      "parameters": {
        "jsCode": "let resp = null;\n  let ctx = null;\n\n  try {\n    resp = $('Prepare Response').first().json;\n  } catch (e) {}\n\n  try {\n    ctx = $('Prepare Context').first().json;\n  } catch (e) {}\n\n  const data = { ...ctx, ...resp };\n\n  console.log('=== PREPARE NOTIFIER DATA ===');\n  console.log('Keys:', Object.keys(data));\n\n  return {\n    // IDs\n    tenant_id: data.tenant_id,\n    appeal_id: data.appeal_id,\n    client_id: data.client?.id || data.client_id,\n\n    // Client info\n    client_name: data.client_name || data.client?.name || '',\n    client_phone: data.client?.phone || data.client_phone || '',\n\n    // Message info\n    channel: data.channel,\n    text: data.message || data.text || '',\n    response_text: data.response_text || '',\n\n    // Media\n    media_type: data.media_type || 'text',\n    media_data: data.media_data || null,\n\n    // Appeal data\n    appeal: data.appeal,\n    current_state: data.current_state,\n    missing_fields: data.missing_fields,\n\n    // External IDs\n    external_chat_id: data.external_chat_id,\n    external_user_id: data.external_user_id\n  };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        -288
      ],
      "id": "6ea3aea5-219d-43cc-9186-7311aad17b6c",
      "name": "Prepare Notifier Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation_mode }}",
                    "rightValue": "auto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "auto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.operation_mode }}",
                    "rightValue": "assist",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "assist"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "23b0b7ee-e5ee-4311-9246-743069f21bb7",
      "name": "Route By Mode",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1728,
        -304
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ö–æ–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É–∑–ª–∞ \"Prepare Auto Send\" –≤ BAT AI Appeal Router\r\n// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–∑–æ–≤–∞ Client Response Sender –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ\r\n\r\nconst data = $input.first().json;\r\nconst context = $('Prepare Context').first().json;\r\nconst appeal = context.appeal || {};\r\n\r\nconsole.log('=== PREPARE AUTO SEND ===');\r\nconsole.log('Appeal ID:', data.appeal_id);\r\nconsole.log('Response text:', data.response_text);\r\nconsole.log('Channel:', data.channel);\r\n\r\n// –ü–æ–ª—É—á–∞–µ–º client_id –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\r\nconst clientId = appeal.client_id || context.client?.id;\r\n\r\nif (!clientId) {\r\n  console.error('‚ùå No client_id found!');\r\n  console.error('Context:', JSON.stringify(context, null, 2));\r\n  throw new Error('client_id not found in appeal data');\r\n}\r\n\r\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Client Response Sender\r\nreturn {\r\n  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\r\n  appeal_id: data.appeal_id,\r\n  client_id: clientId,\r\n  response_to_send: data.response_text,\r\n  channel: data.channel || 'telegram',\r\n\r\n  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ\r\n  response_type: 'text',\r\n  operator_action: 'auto_response',\r\n  operator_name: '–ò–ò-–∞–≥–µ–Ω—Ç',\r\n\r\n  // –î–ª—è Telegram\r\n  client_telegram_id: data.external_chat_id || context.external_chat_id,\r\n\r\n  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\r\n  source_workflow: 'BAT AI Appeal Router (auto)',\r\n\r\n  // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–æ–¥\r\n  extracted_data: data.extracted_data,\r\n  completion_percentage: data.completion_percentage,\r\n  approval_data: data.approval_data,\r\n  operation_mode: data.operation_mode,\r\n  client_name: data.client_name\r\n};\r\n"
      },
      "id": "e8a30b2c-2c28-4015-8bdd-dd96c7d5aafd",
      "name": "Prepare Auto Send",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2112,
        -544
      ]
    },
    {
      "parameters": {
        "workflowId": "Gxd1gIKgk8HxuOya",
        "options": {}
      },
      "id": "46d9eba6-5a0d-481d-9674-e2fdbeedf0b3",
      "name": "Call Client Response Sender",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        2368,
        -544
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ö–æ–¥ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É–∑–ª–∞ \"Prepare Auto Notify\" –≤ BAT AI Appeal Router\r\n// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)\r\n// –û—Ç–≤–µ—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É, –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\r\n\r\nconst data = $input.first().json;\r\n\r\nconst clientName = data.client_name || data.approval_data?.client_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';\r\nconst channel = data.channel || data.approval_data?.channel || 'telegram';\r\nconst responseText = data.response_text || data.approval_data?.response_text || '';\r\nconst appealId = data.appeal_id || data.approval_data?.appeal_id || '';\r\nconst extractedData = data.extracted_data || data.approval_data?.extracted_data || {};\r\nconst completeness = data.approval_data?.completeness || { percentage: 0, missing: [] };\r\n\r\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\r\nconst lines = [];\r\nlines.push('‚úÖ <b>–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</b>\\n');\r\n\r\nlines.push(`<b>üë§ –ö–ª–∏–µ–Ω—Ç:</b> ${clientName}`);\r\nlines.push(`<b>üí¨ –ö–∞–Ω–∞–ª:</b> ${channel}`);\r\n\r\nif (extractedData.brand) lines.push(`<b>üì± –ë—Ä–µ–Ω–¥:</b> ${extractedData.brand}`);\r\nif (extractedData.model) lines.push(`<b>üì± –ú–æ–¥–µ–ª—å:</b> ${extractedData.model}`);\r\nif (extractedData.repair_category) lines.push(`<b>üîß –†–µ–º–æ–Ω—Ç:</b> ${extractedData.repair_category}`);\r\n\r\nlines.push('');\r\nlines.push(`<b>üìä –ó–∞–ø–æ–ª–Ω–µ–Ω–æ:</b> ${completeness.percentage}%`);\r\nif (completeness.missing && completeness.missing.length > 0) {\r\n  lines.push(`<b>‚ùì –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç:</b> ${completeness.missing.join(', ')}`);\r\n}\r\n\r\nlines.push('');\r\nlines.push('<b>ü§ñ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:</b>');\r\nlines.push(`\"${responseText}\"`);\r\n\r\nlines.push('');\r\nlines.push(`<code>${appealId}</code>`);\r\n\r\nreturn {\r\n  ...data,\r\n  auto_sent: true,\r\n  operator_notification: {\r\n    text: lines.join('\\n'),\r\n    short_text: `‚úÖ –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç: ${clientName}`,\r\n    appeal_id: appealId,\r\n    client_name: clientName,\r\n    channel: channel,\r\n    external_chat_id: data.external_chat_id,\r\n    parse_mode: 'HTML',\r\n    disable_web_page_preview: true,\r\n    original_response_text: responseText\r\n  }\r\n};\r\n"
      },
      "id": "6e242c03-f91c-49f2-9728-e72a2286ac70",
      "name": "Prepare Auto Notify",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2704,
        -544
      ]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Load Appeal & Devices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Appeal & Devices": {
      "main": [
        [
          {
            "node": "Load Fields Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Fields Config": {
      "main": [
        [
          {
            "node": "Prepare Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Context": {
      "main": [
        [
          {
            "node": "Needs Extraction?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Extraction?": {
      "main": [
        [
          {
            "node": "Call Task Dispatcher",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip Extraction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Task Dispatcher": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Extraction": {
      "main": [
        [
          {
            "node": "Merge Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Context": {
      "main": [
        [
          {
            "node": "AI Response Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Response Generator",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Response Generator": {
      "main": [
        [
          {
            "node": "Prepare Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response": {
      "main": [
        [
          {
            "node": "Route by Completeness",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Completeness": {
      "main": [
        [
          {
            "node": "Update Full Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Partial Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Minimal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Full Data": {
      "main": [
        [
          {
            "node": "Merge After Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Partial Data": {
      "main": [
        [
          {
            "node": "Merge After Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Minimal": {
      "main": [
        [
          {
            "node": "Merge After Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Response": {
      "main": [
        [
          {
            "node": "Route By Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Operator Notifier": {
      "main": [
        [
          {
            "node": "Return Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Results": {
      "main": [
        [
          {
            "node": "Build AI Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge After Update": {
      "main": [
        [
          {
            "node": "Save Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Notifier Data": {
      "main": [
        [
          {
            "node": "Call Operator Notifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route By Mode": {
      "main": [
        [
          {
            "node": "Prepare Auto Send",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Notifier Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare Notifier Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Auto Send": {
      "main": [
        [
          {
            "node": "Call Client Response Sender",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Client Response Sender": {
      "main": [
        [
          {
            "node": "Prepare Auto Notify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Auto Notify": {
      "main": [
        [
          {
            "node": "Call Operator Notifier",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:04:01.292Z",
      "createdAt": "2025-11-23T04:04:01.292Z",
      "id": "eiI07cPEeFxzR69p",
      "name": "Core"
    }
  ],
  "updatedAt": "2025-12-01T13:52:13.000Z",
  "createdAt": "2025-11-25T14:24:10.715Z"
}