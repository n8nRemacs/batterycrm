{
  "name": "ELO_Queue_Processor",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 5
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 5 Seconds",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-800, 200]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "elo:processor:lock",
        "options": {}
      },
      "id": "check-lock",
      "name": "Check Processor Lock",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [-592, 200],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "lock-free",
              "leftValue": "={{ $json.value }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is-free",
      "name": "Is Processor Free?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-384, 200]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "elo:processor:lock",
        "value": "busy",
        "expire": true,
        "ttl": 60
      },
      "id": "acquire-lock",
      "name": "Acquire Lock",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [-160, 100],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "tail": false,
        "options": {}
      },
      "id": "pop-message-1",
      "name": "Pop Message 1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [64, 100],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "tail": false,
        "options": {}
      },
      "id": "pop-message-2",
      "name": "Pop Message 2",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [64, 200],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "tail": false,
        "options": {}
      },
      "id": "pop-message-3",
      "name": "Pop Message 3",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [64, 300],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "tail": false,
        "options": {}
      },
      "id": "pop-message-4",
      "name": "Pop Message 4",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [64, 400],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "tail": false,
        "options": {}
      },
      "id": "pop-message-5",
      "name": "Pop Message 5",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [64, 500],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Собираем все pop результаты\nconst pops = [\n  $('Pop Message 1').first()?.json?.value,\n  $('Pop Message 2').first()?.json?.value,\n  $('Pop Message 3').first()?.json?.value,\n  $('Pop Message 4').first()?.json?.value,\n  $('Pop Message 5').first()?.json?.value\n].filter(v => v !== null && v !== undefined && v !== '');\n\nif (pops.length === 0) {\n  return { empty: true, messages: [] };\n}\n\n// Парсим JSON и группируем по external_chat_id\nconst messages = pops.map(raw => {\n  try {\n    return typeof raw === 'string' ? JSON.parse(raw) : raw;\n  } catch (e) {\n    return null;\n  }\n}).filter(m => m !== null);\n\n// Группируем по chat_id\nconst grouped = {};\nfor (const msg of messages) {\n  const key = msg.external_chat_id || 'unknown';\n  if (!grouped[key]) {\n    grouped[key] = [];\n  }\n  grouped[key].push(msg);\n}\n\n// Преобразуем в массив батчей\nconst batches = Object.entries(grouped).map(([chatId, msgs]) => ({\n  external_chat_id: chatId,\n  channel: msgs[0].channel,\n  messages: msgs,\n  count: msgs.length\n}));\n\nreturn {\n  empty: false,\n  batch_count: batches.length,\n  batches: batches\n};"
      },
      "id": "collect-messages",
      "name": "Collect and Group",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [288, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "is-empty",
              "leftValue": "={{ $json.empty }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "is-empty",
      "name": "Queue Empty?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [512, 200]
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "elo:processor:lock"
      },
      "id": "release-lock-empty",
      "name": "Release Lock (Empty)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [736, 100],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Разворачиваем батчи в отдельные items для SplitInBatches\nconst data = $input.first().json;\nconst batches = data.batches || [];\n\nreturn batches.map(batch => ({ json: batch }));"
      },
      "id": "split-batches",
      "name": "Split Batches",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [736, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-batches",
      "name": "Loop Over Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [960, 300]
    },
    {
      "parameters": {
        "jsCode": "// Для каждого батча: resolve tenant и подготовить для Batcher\nconst batch = $input.first().json;\nconst firstMsg = batch.messages[0];\n\n// Извлекаем lookup value для tenant\nconst channel = firstMsg.channel;\nlet lookupValue = '';\n\nif (channel === 'telegram' && firstMsg.bot_token) {\n  lookupValue = firstMsg.bot_token;\n} else if (channel === 'vk' && firstMsg.meta?.raw?.group_id) {\n  lookupValue = firstMsg.meta.raw.group_id.toString();\n} else if (channel === 'whatsapp' && firstMsg.meta?.profile_id) {\n  lookupValue = firstMsg.meta.profile_id;\n} else if (channel === 'avito' && firstMsg.meta?.user_id) {\n  lookupValue = firstMsg.meta.user_id.toString();\n} else if (channel === 'max' && firstMsg.meta?.bot_token) {\n  lookupValue = firstMsg.meta.bot_token;\n}\n\nreturn {\n  ...batch,\n  lookup_channel: channel,\n  lookup_value: lookupValue,\n  needs_tenant_lookup: !!lookupValue\n};"
      },
      "id": "prepare-tenant-lookup",
      "name": "Prepare Tenant Lookup",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1184, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  ca.tenant_id,\n  t.name as tenant_name,\n  t.is_active,\n  t.settings as tenant_settings,\n  ca.credentials as channel_config\nFROM elo_channel_accounts ca\nJOIN elo_tenants t ON t.id = ca.tenant_id\nWHERE ca.channel = '{{ $json.lookup_channel }}'\n  AND (\n    ca.account_id = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'bot_token' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'token' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'group_id' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'profile_id' = '{{ $json.lookup_value }}'\n  )\n  AND ca.is_active = true\n  AND t.is_active = true\nLIMIT 1;",
        "options": {}
      },
      "id": "find-tenant",
      "name": "Find Tenant",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [1408, 300],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Объединяем batch data с tenant info\nconst batchData = $('Prepare Tenant Lookup').first().json;\nconst tenantResult = $input.first().json;\n\n// Если tenant найден - используем его, иначе default\nconst tenantId = tenantResult.tenant_id || 'a0000000-0000-0000-0000-000000000001';\nconst tenantName = tenantResult.tenant_name || 'Default Tenant';\nconst tenantSettings = tenantResult.tenant_settings || {};\nconst channelConfig = tenantResult.channel_config || {};\n\n// Добавляем tenant info к каждому сообщению в батче\nconst messagesWithTenant = batchData.messages.map(msg => ({\n  ...msg,\n  tenant_id: tenantId,\n  tenant_name: tenantName,\n  tenant_settings: tenantSettings,\n  channel_config: channelConfig\n}));\n\n// Берём первое сообщение как основу для Batcher\nconst firstMsg = messagesWithTenant[0];\n\nreturn {\n  ...firstMsg,\n  batch_messages: messagesWithTenant,\n  batch_count: messagesWithTenant.length\n};"
      },
      "id": "attach-tenant",
      "name": "Attach Tenant",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1632, 300]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "lmMxcDEJAcverxhC",
          "mode": "id"
        },
        "options": {}
      },
      "id": "call-batcher",
      "name": "Execute Batcher",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [1856, 300]
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "elo:processor:lock"
      },
      "id": "release-lock-done",
      "name": "Release Lock (Done)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2080, 300],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    }
  ],
  "connections": {
    "Every 5 Seconds": {
      "main": [
        [
          {
            "node": "Check Processor Lock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Processor Lock": {
      "main": [
        [
          {
            "node": "Is Processor Free?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Processor Free?": {
      "main": [
        [
          {
            "node": "Acquire Lock",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Acquire Lock": {
      "main": [
        [
          {
            "node": "Pop Message 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 1": {
      "main": [
        [
          {
            "node": "Collect and Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 2": {
      "main": [
        [
          {
            "node": "Collect and Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 3": {
      "main": [
        [
          {
            "node": "Collect and Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 4": {
      "main": [
        [
          {
            "node": "Collect and Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 5": {
      "main": [
        [
          {
            "node": "Collect and Group",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collect and Group": {
      "main": [
        [
          {
            "node": "Queue Empty?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Queue Empty?": {
      "main": [
        [
          {
            "node": "Release Lock (Empty)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Batches": {
      "main": [
        [
          {
            "node": "Loop Over Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Batches": {
      "main": [
        [
          {
            "node": "Prepare Tenant Lookup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Release Lock (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Tenant Lookup": {
      "main": [
        [
          {
            "node": "Find Tenant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Tenant": {
      "main": [
        [
          {
            "node": "Attach Tenant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Tenant": {
      "main": [
        [
          {
            "node": "Execute Batcher",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Batcher": {
      "main": [
        [
          {
            "node": "Loop Over Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "ELO"
    },
    {
      "name": "Core"
    }
  ]
}
