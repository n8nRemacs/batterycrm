{
  "id": "eQ6GSJKSeN5EzaQz",
  "name": "Tool - Определить чья запчасть (AI Agent)",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "a14de897-ba79-4b5c-8973-6d19ec9f7a25",
      "name": "Workflow Tool Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -688,
        1216
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconst text = input.text || '';\nconst conversationHistory = input.conversation_history || 'Первое сообщение';\n\nconsole.log('=== Tool: Определить чья запчасть ===');\nconsole.log('Text:', text);\nconsole.log('History:', conversationHistory);\n\nreturn {\n  text: text,\n  conversation_history: conversationHistory,\n  chatInput: `Текст клиента: ${text}\\n\\nИстория диалога:\\n${conversationHistory}\\n\\nОпредели чья запчасть будет использоваться.`\n};"
      },
      "id": "93626cff-1af6-40f7-83c4-76d5119a1930",
      "name": "Подготовить контекст1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        1216
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Ты - детектор источника запчасти в сервисном центре.\n\nЗАДАЧА: Определить чья запчасть будет использоваться для ремонта.\n\nПРАВИЛО:\n- ПО УМОЛЧАНИЮ всегда \"наша\" (запчасть сервиса)\n- \"клиента\" ТОЛЬКО если клиент ЯВНО указал что принесет/использует свою деталь\n\nВАРИАНТЫ:\n- \"наша\" - запчасть сервисного центра (по умолчанию)\n- \"клиента\" - клиент принесет свою запчасть\n\nПРИМЕРЫ:\n\"Хочу заменить батарею\" → наша (не упомянул свою)\n\"Сколько стоит замена?\" → наша (не упомянул свою)\n\"У меня есть батарея, можете установить?\" → клиента (явно указал)\n\"Я принесу свою деталь\" → клиента (явно указал)\n\"С вашей запчастью\" → наша (явно указал нашу)\n\"Без батареи\" → клиента (подразумевает без нашей)\n\"Только работа\" → клиента (подразумевает свою деталь)\n\nВАЖНО:\n- Если сомневаешься → выбирай \"наша\"\n- \"клиента\" только при явном упоминании\n- Анализируй весь контекст диалога\n\nОТВЕТ СТРОГО В ФОРМАТЕ:\nparts_owner: наша или клиента\nconfidence: число от 0 до 1\nreasoning: краткое объяснение",
        "options": {}
      },
      "id": "df539f05-efc5-4e48-95e2-03a285c46979",
      "name": "AI Agent1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -240,
        1216
      ]
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 300,
          "temperature": 0.1
        }
      },
      "id": "acbea969-7dad-4d82-ac56-f86776b1a1fa",
      "name": "OpenAI Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -240,
        1424
      ],
      "credentials": {
        "openAiApi": {
          "id": "ptoy1RvCOn39G0Af",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\n\nconsole.log('=== AI Response (Parts Owner Detection) ===');\nconsole.log('Raw:', JSON.stringify(aiResponse, null, 2));\n\nlet output = aiResponse.output || aiResponse.text || JSON.stringify(aiResponse);\n\nconsole.log('Output text:', output);\n\n// Парсим ответ\nlet parsed;\ntry {\n  let cleaned = output\n    .replace(/```json\\s*/gi, '')\n    .replace(/```\\s*/g, '')\n    .trim();\n  \n  const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    cleaned = jsonMatch[0];\n  }\n  \n  parsed = JSON.parse(cleaned);\n  console.log('✅ Parsed:', parsed);\n  \n} catch (e) {\n  console.error('❌ Parse error:', e.message);\n  \n  // Fallback парсинг\n  const partsMatch = output.match(/parts_owner[\"']?\\s*:\\s*[\"']?(наша|клиента)[\"']?/i);\n  const confMatch = output.match(/confidence[\"']?\\s*:\\s*([\\d.]+)/i);\n  const reasonMatch = output.match(/reasoning[\"']?\\s*:\\s*[\"']?([^\"'\\n]+)[\"']?/i);\n  \n  parsed = {\n    parts_owner: partsMatch ? partsMatch[1] : 'наша',\n    confidence: confMatch ? parseFloat(confMatch[1]) : 0.9,\n    reasoning: reasonMatch ? reasonMatch[1] : 'По умолчанию используется наша запчасть'\n  };\n  \n  console.log('⚠️ Fallback parsed:', parsed);\n}\n\n// Валидация\nconst validOwners = ['наша', 'клиента'];\nif (!validOwners.includes(parsed.parts_owner)) {\n  console.warn('⚠️ Invalid parts_owner:', parsed.parts_owner);\n  parsed.parts_owner = 'наша';\n}\n\nconsole.log('✅ Final result:', parsed);\n\n// ✅ ВОЗВРАЩАЕМ ОБЪЕКТ (для n8n), а не строку!\nreturn [{\n  json: {\n    parts_owner: parsed.parts_owner,\n    confidence: parsed.confidence || 0.9,\n    reasoning: parsed.reasoning || 'По умолчанию используется наша запчасть'\n  }\n}];"
      },
      "id": "8378cfc3-b2a9-4e48-9fc3-e3ccfa9dd6f1",
      "name": "Обработать ответ1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        1216
      ]
    }
  ],
  "connections": {
    "Workflow Tool Trigger": {
      "main": [
        [
          {
            "node": "Подготовить контекст1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Подготовить контекст1": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Обработать ответ1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:02:03.765Z",
      "createdAt": "2025-11-23T04:02:03.765Z",
      "id": "JkzPlhYcdcsJtFGG",
      "name": "Tool"
    }
  ],
  "updatedAt": "2025-12-03T12:22:17.000Z",
  "createdAt": "2025-10-18T13:02:53.236Z"
}