{
  "id": "d1iaZhn3BqJPxhLI",
  "name": "API_Android_Send_Response",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "android/appeals/:id/send",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "56ac55f9-958b-44dd-8f7c-69ca31a1d5ca",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -720,
        -176
      ],
      "webhookId": "android-send-response"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.body.operator_id }}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{ $json.body.response_text || $json.body.media_data }}",
              "operation": "isNotEmpty"
            }
          ]
        },
        "options": {}
      },
      "id": "c3381b35-362e-466b-8f92-439e5a068304",
      "name": "Validate Params",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -512,
        -176
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  SELECT\n    a.id,\n    a.ad_channel as channel,\n    a.tenant_id,\n    a.client_id,\n    c.telegram_id,\n    c.vk_id,\n    c.whatsapp_id,\n    c.avito_id,\n    c.phone\n  FROM appeals a\n  LEFT JOIN clients c ON a.client_id = c.id\n  WHERE a.id = '{{ $json.params.id }}'::uuid",
        "options": {}
      },
      "id": "945738a7-79a7-422d-bac3-7a099f61dbab",
      "name": "Get Appeal",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -224,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const appeal = $input.first().json;\nconst body = $('Webhook').first().json.body;\n\nreturn {\n  json: {\n    appeal_id: appeal.id,\n    channel: appeal.channel,\n    tenant_id: appeal.tenant_id,\n    operator_id: body.operator_id,\n    telegram_chat_id: appeal.telegram_chat_id,\n    vk_user_id: appeal.vk_user_id,\n    whatsapp_phone: appeal.whatsapp_phone,\n    avito_user_id: appeal.avito_user_id,\n    phone: appeal.phone,\n    response_text: body.response_text,\n    media_type: body.media_type || null,\n    media_data: body.media_data || null,\n    action_source: 'android'\n  }\n};"
      },
      "id": "a701318c-9216-4991-b585-8798fcd95639",
      "name": "Prepare Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        -176
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "pWb4n4ko3L8NvtXW",
          "mode": "list",
          "cachedResultUrl": "/workflow/pWb4n4ko3L8NvtXW",
          "cachedResultName": "BAT Client Response Sender"
        },
        "options": {}
      },
      "id": "c4296d10-705d-42ee-800b-975816678fc2",
      "name": "Execute Client Response Sender",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [
        176,
        -176
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  INSERT INTO operator_actions (\n    tenant_id,\n    operator_id,\n    context_appeal_id,\n    action_type,\n    details\n  ) VALUES (\n    '{{ $json.tenant_id }}'::uuid,\n    '{{ $('Webhook').first().json.body.operator_id }}'::uuid,\n    '{{ $('Webhook').first().json.params.id }}'::uuid,\n    'send_response',\n    '{\"source\": \"android\"}'::jsonb\n  )\n  RETURNING id;\n",
        "options": {}
      },
      "id": "2a525c85-27b1-4b73-be78-67f792feda3e",
      "name": "Log Action",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        384,
        -176
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"appeal_id\": $json.appeal_id } }}",
        "options": {}
      },
      "id": "f11d28a4-7109-43f4-ad2b-1552f4e8cf47",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        576,
        -176
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": false, \"error\": \"Missing required parameters\" } }}",
        "options": {}
      },
      "id": "a85310e4-3617-4bc0-bb4a-e9469364e2d8",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -304,
        32
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validate Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Params": {
      "main": [
        [
          {
            "node": "Get Appeal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Appeal": {
      "main": [
        [
          {
            "node": "Prepare Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data": {
      "main": [
        [
          {
            "node": "Execute Client Response Sender",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Client Response Sender": {
      "main": [
        [
          {
            "node": "Log Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Action": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:58:34.844Z",
      "createdAt": "2025-11-23T03:58:34.844Z",
      "id": "0yzk30hhaSzkl8bF",
      "name": "API"
    },
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    }
  ],
  "updatedAt": "2025-12-02T07:54:11.000Z",
  "createdAt": "2025-11-11T09:11:00.854Z"
}