{
  "id": "z8rmWHMWZROfH1Nl",
  "name": "Tool - Определить тип ремонта (AI Agent)",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "0b573e56-a3e5-4dd5-9b53-e419cb3bd58a",
      "name": "Workflow Tool Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -656,
        288
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconst text = input.text || '';\nconst conversationHistory = input.conversation_history || 'Первое сообщение';\nconst repairTypes = input.available_repair_types || [];\n\nconsole.log('=== Tool: Определить тип ремонта ===');\nconsole.log('Text:', text);\nconsole.log('Repair types count:', repairTypes.length);\n\n// Форматируем список типов ремонта\nconst repairTypesList = repairTypes.map(rt => {\n  return `${rt.name} - ${rt.description} (ID: ${rt.id})`;\n}).join('\\n');\n\nconst systemPrompt = `Ты - эксперт по диагностике проблем с iPhone.\n\nЗАДАЧА: Определи тип ремонта на основе описания проблемы клиента.\n\nПРАВИЛА:\n1. Ищи ключевые слова: \"дисплей\", \"батарея\", \"зарядка\", \"камера\" и т.д.\n2. Учитывай синонимы: \"экран\" = дисплей, \"аккумулятор\" = батарея\n3. Если нашел - ОБЯЗАТЕЛЬНО верни found: true и ID типа ремонта\n4. Если НЕ нашел - верни found: false\n\nДОСТУПНЫЕ ТИПЫ РЕМОНТА:\n${repairTypesList}\n\nФОРМАТ ОТВЕТА (строго JSON без markdown):\n{{\n  \"found\": true,\n  \"repair_type\": \"Дисплей\",\n  \"repair_type_id\": \"9e1fa155-7982-42f3-9a2b-c625c0e899aa\",\n  \"confidence\": 0.95,\n  \"reasoning\": \"Клиент упомянул 'дисплей'\"\n}}\n\nПРИМЕРЫ:\n\"Замена дисплея\" → found: true, repair_type: \"Дисплей\"\n\"Не держит батарея\" → found: true, repair_type: \"Батарея\"\n\"Экран разбит\" → found: true, repair_type: \"Дисплей\"\n\"Не заряжается\" → found: true, repair_type: \"Зарядка\"\n\"Здравствуйте\" → found: false\n\n---\n\nТЕКСТ КЛИЕНТА:\n${text}\n\nИСТОРИЯ ДИАЛОГА:\n${conversationHistory}\n\n---\n\nОпредели тип ремонта и верни JSON.`;\n\nreturn {\n  text: text,\n  conversation_history: conversationHistory,\n  repair_types_list: repairTypesList,\n  available_repair_types: repairTypes,\n  chatInput: systemPrompt\n};"
      },
      "id": "568dc1f7-3ecc-49a4-8fa3-a1a9023ed7f4",
      "name": "Подготовить контекст",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        288
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "25009928-77bf-4996-a186-be1dc131ce7e",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.2,
      "position": [
        -256,
        288
      ]
    },
    {
      "parameters": {
        "options": {
          "maxTokens": 500,
          "temperature": 0.2
        }
      },
      "id": "ecb36361-4c1f-48f2-99af-4d2d234b04fc",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -256,
        464
      ],
      "credentials": {
        "openAiApi": {
          "id": "ptoy1RvCOn39G0Af",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const aiResponse = $input.first().json;\n\nconsole.log('=== AI Response (Repair Type Detection) ===');\nconsole.log('Raw:', JSON.stringify(aiResponse, null, 2));\n\nlet output = aiResponse.output || aiResponse.text || JSON.stringify(aiResponse);\n\nconsole.log('Output text:', output);\n\nlet parsed;\ntry {\n  let cleaned = output.replace(/```json\\s*/gi, '').replace(/```\\s*/g, '').trim();\n  const jsonMatch = cleaned.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) cleaned = jsonMatch[0];\n  parsed = JSON.parse(cleaned);\n  console.log('✅ Parsed:', parsed);\n} catch (e) {\n  console.error('❌ Parse error:', e.message);\n  return [{\n    json: {\n      repair_type: null,\n      repair_type_id: null,\n      found: false,\n      confidence: 0,\n      message: 'Не удалось распарсить ответ AI'\n    }\n  }];\n}\n\nif (!parsed.found || !parsed.repair_type) {\n  console.log('⚠️ Repair type not found');\n  return [{\n    json: {\n      repair_type: null,\n      repair_type_id: null,\n      found: false,\n      confidence: 0,\n      message: 'Тип ремонта не определен'\n    }\n  }];\n}\n\nconsole.log('✅ Repair type found:', parsed.repair_type);\n\nreturn [{\n  json: {\n    repair_type: parsed.repair_type,\n    repair_type_id: parsed.repair_type_id,\n    found: true,\n    confidence: parsed.confidence || 0.9,\n    reasoning: parsed.reasoning || 'Определено автоматически'\n  }\n}];"
      },
      "id": "9be86d97-d628-4379-bf5e-6f96dad7d3d4",
      "name": "Обработать ответ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        288
      ]
    }
  ],
  "connections": {
    "Workflow Tool Trigger": {
      "main": [
        [
          {
            "node": "Подготовить контекст",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Подготовить контекст": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Обработать ответ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:02:03.765Z",
      "createdAt": "2025-11-23T04:02:03.765Z",
      "id": "JkzPlhYcdcsJtFGG",
      "name": "Tool"
    }
  ],
  "updatedAt": "2025-12-03T12:22:17.000Z",
  "createdAt": "2025-10-18T13:00:21.819Z"
}