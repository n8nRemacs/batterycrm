{
  "id": "WiDRlsmHntaD6PM0",
  "name": "Tool - Build Appeal Meta",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -832,
        -32
      ],
      "id": "51bab5e3-e68f-4558-9f48-a20605bb9204",
      "name": "Execute Workflow Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH appeal_data AS (\n  SELECT\n    a.id,\n    a.stage,\n    a.estimated_cost,\n    a.estimated_time,\n    a.parts_owner,\n    a.created_at,\n    c.name AS client_name,\n    c.phone AS client_phone,\n    c.has_telegram,\n    c.has_whatsapp,\n    c.has_phone,\n    c.has_yandex,\n    c.has_google,\n    c.has_instagram,\n    c.has_avito,\n    b.name AS brand_name,\n    m.name AS model_name,\n    dt.name AS deal_type_name,\n    rt.name AS repair_type_name,\n    NULL AS sales_channel_name,\n    NULL AS lead_source_name,\n    NULL AS issue_type_name,\n    NULL AS issue_name\n  FROM appeals a\n  LEFT JOIN clients c ON c.id = a.client_id AND c.tenant_id = a.tenant_id\n  LEFT JOIN brands b ON b.id = a.brand_id AND b.tenant_id = a.tenant_id\n  LEFT JOIN models m ON m.id = a.model_id AND m.tenant_id = a.tenant_id\n  LEFT JOIN deal_types dt ON dt.id = a.deal_type_id\n  LEFT JOIN repair_types rt ON rt.id = a.repair_type_id AND rt.tenant_id = a.tenant_id\n  WHERE a.id = '{{ $json.appeal_id }}'::uuid\n    AND a.tenant_id = '{{ $json.tenant_id }}'::uuid\n  LIMIT 1\n)\nSELECT * FROM appeal_data;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -576,
        -160
      ],
      "id": "8dcc363d-798d-4cac-a6b4-d641d096efa0",
      "name": "Fetch Appeal Data",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH appeal_info AS (\n  SELECT a.deal_type_id\n  FROM appeals a\n  WHERE a.id = '{{ $json.appeal_id }}'::uuid\n    AND a.tenant_id = '{{ $json.tenant_id }}'::uuid\n  LIMIT 1\n)\nSELECT \n  amc.id, \n  amc.label, \n  amc.\"group\", \n  amc.\"order\", \n  amc.source_field, \n  amc.format_type\nFROM appeal_meta_config amc\nLEFT JOIN appeal_meta_visibility amv \n  ON amv.config_id = amc.id \n  AND amv.deal_type_id = (SELECT deal_type_id FROM appeal_info)\n  AND amv.tenant_id = '{{ $json.tenant_id }}'::uuid\nWHERE amc.is_active = true\n  AND (amv.is_visible IS NULL OR amv.is_visible = true)\nORDER BY amc.\"order\" ASC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -576,
        80
      ],
      "id": "65ab6ec5-c3ca-4524-b173-8be3ab22d515",
      "name": "Fetch Meta Config",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const appealData = $input.first()?.json;\nconst configItems = $input.all().slice(1); // Пропустить первый элемент (appeal data)\n\nif (!appealData || !appealData.id) {\n  return [{ meta: [] }];\n}\n\nconst formatValue = (value, formatType) => {\n  if (value === null || value === undefined || value === '') return null;\n  \n  switch (formatType) {\n    case 'date':\n      const d = new Date(value);\n      const day = String(d.getDate()).padStart(2, '0');\n      const month = String(d.getMonth() + 1).padStart(2, '0');\n      const year = d.getFullYear();\n      return `${day}.${month}.${year}`;\n    \n    case 'duration':\n      return `${value} минут`;\n    \n    case 'currency':\n      const num = Number(value);\n      if (isNaN(num)) return null;\n      return num.toLocaleString('ru-RU') + ' ₽';\n    \n    case 'text':\n    default:\n      return String(value);\n  }\n};\n\nconst extractValue = (sourceField, data) => {\n  if (sourceField.includes('||')) {\n    const parts = sourceField.split('||').map(s => s.trim());\n    const values = parts.map(p => {\n      const field = p.split('.')[1];\n      return data[field + '_name'] || null;\n    }).filter(v => v);\n    return values.length > 0 ? values.join(' ') : null;\n  }\n  \n  if (sourceField === 'client.has_*') {\n    const channels = [];\n    if (data.has_telegram) channels.push('Telegram');\n    if (data.has_whatsapp) channels.push('WhatsApp');\n    if (data.has_phone) channels.push('Телефон');\n    if (data.has_yandex) channels.push('Яндекс');\n    if (data.has_google) channels.push('Google');\n    if (data.has_instagram) channels.push('Instagram');\n    if (data.has_avito) channels.push('Avito');\n    return channels.length > 0 ? channels.join(', ') : null;\n  }\n  \n  const field = sourceField.split('.')[1];\n  \n  if (['deal_type', 'sales_channel', 'lead_source', 'brand', 'model', 'issue_type', 'issue', 'repair_type'].includes(field)) {\n    return data[field + '_name'] || null;\n  }\n  \n  return data[field] || null;\n};\n\nconst meta = [];\n\nfor (const item of configItems) {\n  const config = item.json;\n  const rawValue = extractValue(config.source_field, appealData);\n  \n  if (rawValue === null) continue;\n  \n  const formattedValue = formatValue(rawValue, config.format_type);\n  \n  if (formattedValue === null) continue;\n  \n  meta.push({\n    id: config.id,\n    label: config.label,\n    value: formattedValue,\n    group: config.group,\n    order: config.order\n  });\n}\n\nreturn [{ meta }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        -48
      ],
      "id": "f153855a-44af-4e02-8e0c-0859f194fb32",
      "name": "Build Meta Array"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -336,
        -48
      ],
      "id": "4719da9d-59b7-4e1c-93fa-53ff58a8a470",
      "name": "Merge Data"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Fetch Appeal Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Meta Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Appeal Data": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Meta Config": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Build Meta Array",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:02:03.765Z",
      "createdAt": "2025-11-23T04:02:03.765Z",
      "id": "JkzPlhYcdcsJtFGG",
      "name": "Tool"
    }
  ],
  "updatedAt": "2025-11-23T04:02:12.000Z",
  "createdAt": "2025-11-20T18:51:36.744Z"
}