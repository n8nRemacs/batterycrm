{
  "name": "API_Operator_Reject",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/operator/appeals/:id/reject",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "c2f4550b-2dbe-4f65-9d47-1210e2505ae0",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1136,
        -16
      ],
      "webhookId": "api-operator-reject"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json || {};\nconst headers = data.headers || {};\nlet token = null;\nconst auth = headers.authorization || headers.Authorization || '';\nif (auth.toLowerCase().startsWith('bearer ')) {\n  token = auth.slice(7);\n}\nif (!token) {\n  token = headers['x-session-token'] || headers['X-Session-Token'] || null;\n}\nconst body = data.body || {};\nif (!token && body.session_token) {\n  token = body.session_token;\n}\nreturn { ...data, session_token: token || null };\n"
      },
      "id": "2f01e85b-de94-4bf5-9603-ae9f1db13f51",
      "name": "Extract Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -912,
        -16
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json || {};\nconst params = data.params || {};\nconst body = data.body || {};\nconst query = data.query || {};\nconst sessionToken = data.session_token || body.session_token || query.session_token || null;\nreturn {\n  appeal_id: params.id || null,\n  reject_reason: body.reject_reason || null,\n  session_token: sessionToken\n};"
      },
      "id": "948e86e3-36fb-4ed8-96d1-3c56d3015aaf",
      "name": "Parse Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        -16
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  od.operator_id,\n  od.tenant_id\nFROM operator_devices od\nJOIN operators o ON o.id = od.operator_id\nWHERE od.session_token = '{{ $json.session_token }}'\n  AND od.device_type = 'mobile'\n  AND o.is_active = true\nLIMIT 1;",
        "options": {}
      },
      "id": "eecf9b14-2960-471a-8c39-de53cd52b82e",
      "name": "Validate Token",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -480,
        -16
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const tokenData = $json || {};\nconst params = $('Parse Params').first()?.json || {};\nreturn {\n  tenant_id: tokenData.tenant_id || null,\n  operator_id: tokenData.operator_id || null,\n  appeal_id: params.appeal_id || null,\n  reject_reason: params.reject_reason || null,\n  session_token: params.session_token || null\n};"
      },
      "id": "00cd7d3b-ecb6-4ba3-9cc7-af2b0610feff",
      "name": "Normalize Tenant",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        -16
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.tenant_id }}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{ $json.operator_id }}",
              "operation": "isNotEmpty"
            },
            {
              "value1": "={{ $json.appeal_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "a45fab20-5c95-4b0d-94d6-826102d1eaa0",
      "name": "Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -48,
        -16
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT\n    '{{ $json.tenant_id }}'::uuid AS tenant_id,\n    '{{ $json.operator_id }}'::uuid AS operator_id,\n    '{{ $json.appeal_id }}'::uuid AS appeal_id,\n    '{{ $json.reject_reason || \"\" }}' AS reject_reason\n)\nINSERT INTO operator_actions (\n  tenant_id,\n  operator_id,\n  operator_telegram_id,\n  action_type,\n  action_source,\n  context_appeal_id,\n  details\n)\nSELECT\n  tenant_id,\n  operator_id,\n  NULL,\n  'reject_appeal',\n  'mini_app',\n  appeal_id,\n  jsonb_build_object(\n    'appeal_id', appeal_id,\n    'reject_reason', reject_reason\n  )\nFROM vals\nRETURNING *;",
        "options": {}
      },
      "id": "3325668b-b30a-44f3-aef2-351763a7c2da",
      "name": "Log Action",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        176,
        -144
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT\n    '{{ $('Normalize Tenant').item.json.tenant_id }}'::uuid AS tenant_id,\n    '{{ $('Normalize Tenant').item.json.operator_id }}'::uuid AS operator_id,\n    '{{ $('Normalize Tenant').item.json.appeal_id }}'::uuid AS appeal_id\n)\nINSERT INTO operator_appeal_status (\n  tenant_id,\n  operator_id,\n  appeal_id,\n  status\n)\nSELECT\n  tenant_id,\n  operator_id,\n  appeal_id,\n  'rejected'\nFROM vals\nON CONFLICT (tenant_id, appeal_id, operator_id)\nDO UPDATE SET\n  status = 'rejected',\n  updated_at = NOW()\nRETURNING *;",
        "options": {}
      },
      "id": "31697af0-aab0-4e23-adfe-4c7024dd1ae9",
      "name": "Update Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        400,
        -144
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return {\n  success: true,\n  message: 'Appeal rejected'\n};"
      },
      "id": "0f25a83a-44e9-44d4-81d1-3bb077b604ef",
      "name": "Format Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        -144
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "21a0547c-d6d7-4fd1-b174-d5a3eeba8ea6",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        848,
        -16
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": false, \"error\": \"unauthorized\" } }}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "8358affa-7302-4bf6-b3ac-65e53cb1cdb6",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        176,
        96
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extract Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Token": {
      "main": [
        [
          {
            "node": "Parse Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Params": {
      "main": [
        [
          {
            "node": "Validate Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Token": {
      "main": [
        [
          {
            "node": "Normalize Tenant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Tenant": {
      "main": [
        [
          {
            "node": "Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid?": {
      "main": [
        [
          {
            "node": "Log Action",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Action": {
      "main": [
        [
          {
            "node": "Update Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Status": {
      "main": [
        [
          {
            "node": "Format Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Success": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null
}