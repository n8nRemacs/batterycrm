{
  "id": "0t7CnDCcHA4MnmTp",
  "name": "API_Android_Appeals_List",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "path": "api/operator/appeals/list",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1120,
        -80
      ],
      "id": "3a93ea19-8f72-472e-a3a2-2153e857fb1b",
      "name": "Webhook",
      "webhookId": "dbc87d6b-d3a8-4613-a2d8-b591d5533210"
    },
    {
      "parameters": {
        "jsCode": "const q = $json.query || {};\nconst status = (q.status || '').trim();\nconst limit = Math.max(1, Math.min(parseInt(q.limit || '20', 10) || 20, 100));\nconst session_token = $json.headers['x-session-token'] || $json.headers['X-Session-Token'] || '';\n\nreturn { \n  status, \n  limit, \n  session_token \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -864,
        -80
      ],
      "id": "0a30cacd-1dc6-47ed-b3e5-3ba33d88fd5b",
      "name": "Parse Query"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: false, error: 'unauthorized_or_operator_not_found' } }}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        96,
        160
      ],
      "id": "cbfd9b65-0098-4c96-bddf-e8a13171f92c",
      "name": "Respond 401"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT\n    '{{ $json.tenant_id || \"\" }}'      AS tenant_id_text,\n    '{{ $json.status || \"\" }}'         AS status_text,\n    '{{ $json.limit  || \"20\" }}'       AS limit_text\n),\nvalidated AS (\n  SELECT\n    CASE\n      WHEN tenant_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n        THEN tenant_id_text::uuid\n      ELSE NULL\n    END AS tenant_id,\n    CASE status_text\n      WHEN 'new'         THEN 'ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚'\n      WHEN 'in_progress' THEN 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ðµ'\n      WHEN 'completed'   THEN 'Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾'\n      ELSE NULL\n    END AS stage_filter,\n    CASE\n      WHEN limit_text ~ '^[0-9]+$' THEN LEAST(GREATEST(limit_text::int, 1), 100)\n      ELSE 20\n    END AS lim\n  FROM vals\n)\nSELECT\n  a.id,\n  a.stage,\n  a.updated_at,\n  c.name  AS client_name,\n  c.phone AS client_phone,\n  b.name  AS brand_name,\n  m.name  AS model_name,\n  a.phone_model,\n  a.parts_owner,\n  a.estimated_cost,\n  a.estimated_time,\n  (\n    SELECT mh.message_text\n    FROM messages_history mh\n    WHERE mh.appeal_id = a.id\n    ORDER BY mh.created_at DESC\n    LIMIT 1\n  ) AS last_message\nFROM validated v\nJOIN appeals a\n  ON v.tenant_id IS NOT NULL\n AND a.tenant_id = v.tenant_id\nJOIN clients c\n  ON c.id = a.client_id AND c.tenant_id = a.tenant_id\nLEFT JOIN brands b\n  ON b.id = a.brand_id AND b.tenant_id = a.tenant_id\nLEFT JOIN models m\n  ON m.id = a.model_id AND m.tenant_id = a.tenant_id\nWHERE (v.stage_filter IS NULL OR a.stage = v.stage_filter)\nORDER BY a.updated_at DESC\nLIMIT (SELECT lim FROM validated);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        288,
        16
      ],
      "id": "9975fa1d-373b-40e1-851f-595ff7a97d87",
      "name": "Fetch Appeals",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT '{{ $json.tenant_id || \"\" }}' AS tenant_id_text\n),\nvalidated AS (\n  SELECT CASE\n           WHEN tenant_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n             THEN tenant_id_text::uuid\n           ELSE NULL\n         END AS tenant_id\n  FROM vals\n)\nSELECT\n  COALESCE(SUM((a.stage = 'ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚')::int), 0) AS new,\n  COALESCE(SUM((a.stage = 'Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ðµ')::int), 0) AS in_progress,\n  COALESCE(SUM((a.stage = 'Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾')::int), 0) AS completed\nFROM validated v\nLEFT JOIN appeals a\n  ON v.tenant_id IS NOT NULL\n AND a.tenant_id = v.tenant_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        288,
        -160
      ],
      "id": "55619512-29e2-42ba-820f-4376c96b6683",
      "name": "Fetch Counts",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "25665eda-b041-468b-a221-8c03ac28972c",
              "leftValue": "={{ $json.tenant_id }}",
              "rightValue": "=null",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "1408f01a-b297-476a-a42a-8c10f5b649d7",
              "leftValue": "={{ $json.tenant_id }}",
              "rightValue": "null",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -176,
        -80
      ],
      "id": "60de4592-bb75-49b1-a541-0af78ce0f6a8",
      "name": "Tenant Found?"
    },
    {
      "parameters": {
        "jsCode": "const r = $input.first()?.json;\nconst row = Array.isArray(r) ? r[0] : r;\nreturn { tenant_id: row?.tenant_id || null, ...($json || {}) };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        -80
      ],
      "id": "c18140d8-6e5c-450a-bfe6-ea968be63950",
      "name": "Normalize Tenant Result"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "join",
              "field2": "__join"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1008,
        -64
      ],
      "id": "042a5a6a-f1dd-48c9-b6f4-9261ab1e36ff",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "322ab37d-3745-4f95-a7c2-5c2ddd7744a7",
              "name": "join",
              "value": 1,
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        -160
      ],
      "id": "4b96ffef-5c92-4838-bd58-514b09aa3fb1",
      "name": "Edit Fields (ÐºÐ°ÑƒÐ½Ñ‚Ñ‹)"
    },
    {
      "parameters": {
        "jsCode": "const listRows = Array.isArray($json.appeals_raw) ? $json.appeals_raw : [];\nconst counts = {\n  new: Number($json.new || 0),\n  in_progress: Number($json.in_progress || 0),\n  completed: Number($json.completed || 0),\n};\nconst appeals = listRows.map(r => ({\n  id: r.id,\n  client: { name: r.client_name ?? null, phone: r.client_phone ?? null },\n  device: { model: r.model_name ?? r.phone_model ?? null, brand: r.brand_name ?? null },\n  problem: r.parts_owner ? `Ð—Ð°Ð¿Ñ‡Ð°ÑÑ‚ÑŒ: ${r.parts_owner}` : null,\n  status: r.stage,\n  last_message: r.last_message || '',\n  updated_at: r.updated_at,\n}));\nreturn [{ success: true, appeals, counts }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        -64
      ],
      "id": "d14a5088-af26-4e74-bd52-815dbe7f55c5",
      "name": "Format Response"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1424,
        -64
      ],
      "id": "08f9f054-18f9-48d0-a20a-7bf48a259c3a",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": " const items = $input.all().map(i => i.json);\n  return { __join: 1, appeals_raw: items };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        512,
        16
      ],
      "id": "29f83fea-53be-482a-b0f1-563b502e6d15",
      "name": "Pack Appeals"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  od.operator_id,\n  od.tenant_id,\n  od.device_type\nFROM operator_devices od\nJOIN operators o ON o.id = od.operator_id\nWHERE od.session_token = '{{ $json.session_token }}'\n  AND od.device_type = 'mobile'\n  AND o.is_active = true\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -608,
        -80
      ],
      "id": "61dda237-5ec6-4ec5-81aa-22e0f1a99d24",
      "name": "Get Tenant Ð¿Ð¾ operator_id",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Parse Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Query": {
      "main": [
        [
          {
            "node": "Get Tenant Ð¿Ð¾ operator_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Appeals": {
      "main": [
        [
          {
            "node": "Pack Appeals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Counts": {
      "main": [
        [
          {
            "node": "Edit Fields (ÐºÐ°ÑƒÐ½Ñ‚Ñ‹)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tenant Found?": {
      "main": [
        [
          {
            "node": "Fetch Appeals",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Counts",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond 401",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Tenant Result": {
      "main": [
        [
          {
            "node": "Tenant Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields (ÐºÐ°ÑƒÐ½Ñ‚Ñ‹)": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pack Appeals": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Tenant Ð¿Ð¾ operator_id": {
      "main": [
        [
          {
            "node": "Normalize Tenant Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:58:34.844Z",
      "createdAt": "2025-11-23T03:58:34.844Z",
      "id": "0yzk30hhaSzkl8bF",
      "name": "API"
    },
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    }
  ],
  "updatedAt": "2025-12-01T08:48:33.000Z",
  "createdAt": "2025-11-05T11:29:30.334Z"
}