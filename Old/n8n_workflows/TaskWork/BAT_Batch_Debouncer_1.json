{
  "id": "JlCa9RquhbDicbPG",
  "name": "BAT Batch Debouncer 1",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Получаем данные о батче из входа\n  const raw = $input.first().json;\n  const input = raw.value || raw;\n\n  return {\n    batch_key: input.batch_key,\n    channel: input.channel,\n    external_chat_id: input.external_chat_id,\n    queue_key: input.queue_key || `queue:batch:${input.batch_key}`,\n    lock_key: input.lock_key || `lock:batch:${input.batch_key}`,\n    last_seen_key: input.last_seen_key || `last_seen:${input.batch_key}`,\n    debounce_seconds: 20,\n    max_wait_seconds: 300,\n    start_time: new Date().toISOString()\n  };\n"
      },
      "id": "bc2e7bc7-6ca6-4ef6-9486-08ebac4dd8a7",
      "name": "Init Debouncer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        -256
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $('Init Debouncer').item.json.last_seen_key }}",
        "options": {}
      },
      "id": "d154ec98-38c4-4255-ae3b-c1b510618887",
      "name": "Get Last Seen",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -720,
        -256
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const lastSeenStr = $json.value;\nconst initData = $('Init Debouncer').first().json;\nconst debounceMs = initData.debounce_seconds * 1000;\nconst maxWaitMs = initData.max_wait_seconds * 1000;\nconst startTime = new Date(initData.start_time).getTime();\nconst now = Date.now();\n\n// Проверяем прошло ли достаточно времени с последнего сообщения\nlet lastSeenTime = 0;\nif (lastSeenStr) {\n  lastSeenTime = new Date(lastSeenStr).getTime();\n}\n\nconst silenceDuration = now - lastSeenTime;\nconst totalWaitDuration = now - startTime;\n\n// Условия для сбора батча:\n// 1. Тишина >= debounce_seconds\n// 2. ИЛИ общее время ожидания >= max_wait_seconds (защита от бесконечного ожидания)\nconst silenceReached = silenceDuration >= debounceMs;\nconst maxWaitReached = totalWaitDuration >= maxWaitMs;\nconst readyToProcess = silenceReached || maxWaitReached;\n\nreturn {\n  ...initData,\n  last_seen: lastSeenStr,\n  last_seen_time: lastSeenTime,\n  silence_duration_ms: silenceDuration,\n  total_wait_duration_ms: totalWaitDuration,\n  silence_reached: silenceReached,\n  max_wait_reached: maxWaitReached,\n  ready_to_process: readyToProcess,\n  reason: maxWaitReached ? 'max_wait_timeout' : (silenceReached ? 'silence_reached' : 'still_active')\n};"
      },
      "id": "eabfa0fe-d682-4476-9eeb-1dd09f0ef356",
      "name": "Check Silence Duration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        -256
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ready-check",
              "leftValue": "={{ $json.ready_to_process }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "14cfa0f0-f3ee-449b-829c-6900f00bfd0f",
      "name": "Ready to Process?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -272,
        -256
      ]
    },
    {
      "parameters": {
        "jsCode": "// Передаём queue_key для POP операций\nconst data = $('Check Silence Duration').first().json;\nreturn { queue_key: data.queue_key };"
      },
      "id": "8e184789-60a7-4f18-9473-ea76b54efea9",
      "name": "Prepare Pop",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        -256
      ]
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "f99e1ac6-dac8-4eff-a502-70003bc42ea0",
      "name": "Pop Message 1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -736
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "b44cb293-f3b0-45b6-b5f9-e7acc46a8c1d",
      "name": "Pop Message 2",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -608
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "ef49995c-2c91-43a1-b4f0-68be972ac5e8",
      "name": "Pop Message 3",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -480
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "3d12bf4b-be74-4c63-9511-a3d48d751755",
      "name": "Pop Message 4",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -352
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "b1b14fd4-5494-446c-8a36-7b671e73d077",
      "name": "Pop Message 5",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -224
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "8dce02f2-5a89-435f-9d24-c63ea02fa9aa",
      "name": "Pop Message 6",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        -96
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "d47fe7bc-b5b0-49b8-ab01-7c3d85ada64b",
      "name": "Pop Message 7",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        32
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "2867d49f-853c-4330-bc49-7aff47dca721",
      "name": "Pop Message 8",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        160
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "d9cdf418-7037-4588-bc0c-8e3a8c96ef5d",
      "name": "Pop Message 9",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        288
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "={{ $('Prepare Pop').item.json.queue_key }}",
        "propertyName": "value",
        "options": {}
      },
      "id": "135da577-5e48-4d02-a163-db3ca2174580",
      "name": "Pop Message 10",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        416
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Собираем все сообщения из POP операций\nconst allItems = $input.all();\nconst initData = $('Check Silence Duration').first().json;\nconst messages = [];\n\nfor (const item of allItems) {\n  const val = item.json?.value;\n  if (val && val !== null && val !== 'null' && val !== '') {\n    try {\n      // Проверяем, содержит ли строка сепаратор\n      if (typeof val === 'string' && val.includes('|||SEPARATOR|||')) {\n        const parts = val.split('|||SEPARATOR|||');\n        for (const part of parts) {\n          if (part.trim()) {\n            messages.push(JSON.parse(part));\n          }\n        }\n      } else {\n        const parsed = typeof val === 'string' ? JSON.parse(val) : val;\n        messages.push(parsed);\n      }\n    } catch (e) {\n      console.error('Failed to parse message:', val, e);\n    }\n  }\n}\n\nif (messages.length === 0) {\n  return {\n    empty: true,\n    batch_key: initData.batch_key\n  };\n}\n\n// Сортируем по timestamp\nconst toTs = (m) => {\n  const t = m.timestamp ? Date.parse(m.timestamp) : NaN;\n  return Number.isFinite(t) ? t : Number.MAX_SAFE_INTEGER;\n};\nmessages.sort((a, b) => toTs(a) - toTs(b));\n\n// Собираем тексты\nconst texts = messages\n  .map(m => m.media?.voice_transcribed_text\n    ? `[Голосовое]: ${m.media.voice_transcribed_text}`\n    : (m.text || ''))\n  .filter(t => t.trim());\n\nconst combinedText = texts.join('\\n\\n');\n\n// Берём первое сообщение как базу\nconst base = messages[0];\n\n// Находим последнее с raw\nconst lastWithRaw = [...messages].reverse().find(m => m?.meta?.raw);\n\nreturn {\n  empty: false,\n  batch_key: initData.batch_key,\n  channel: base.channel,\n  external_user_id: base.external_user_id,\n  external_chat_id: base.external_chat_id,\n  text: combinedText,\n  timestamp: base.timestamp,\n  client_phone: base.client_phone,\n  client_name: base.client_name,\n  client_email: base.client_email,\n  client_username: base.client_username,\n  tenant_id: base.tenant_id,\n  media: base.media,\n  meta: {\n    ...base.meta,\n    ...(lastWithRaw?.meta?.raw ? { raw: lastWithRaw.meta.raw } : {}),\n    batched: true,\n    batch_size: messages.length,\n    batch_wait_time: initData.debounce_seconds,\n    batch_reason: initData.reason,\n    original_messages: messages.map(m => ({\n      timestamp: m.timestamp,\n      type: m.meta?.original_media_type || 'text',\n      text_length: (m.text || '').length\n    })),\n    combined_at: new Date().toISOString()\n  },\n  prefilled_data: base.prefilled_data\n};"
      },
      "id": "3b2db5d9-644f-4dd8-b1be-5f485725fab8",
      "name": "Combine Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        -256
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "empty-check",
              "leftValue": "={{ $json.empty }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "de69ca37-5ce4-4b75-b27f-36ace68c6526",
      "name": "Is Batch Empty?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        672,
        -256
      ]
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Check Silence Duration').item.json.queue_key }}"
      },
      "id": "efcd7386-4cf5-47f1-9fd6-69c3a4955cb7",
      "name": "Delete Queue (Empty)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        896,
        -368
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Check Silence Duration').item.json.lock_key }}"
      },
      "id": "0bcecd8c-1752-482e-8bdf-73f8f95b23c1",
      "name": "Release Lock (Empty)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1120,
        -368
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Check Silence Duration').item.json.lock_key }}"
      },
      "id": "b1dffba4-3196-4ee6-a450-f0563389dca4",
      "name": "Release Lock",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        896,
        -144
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": "OUjTFzd7k4tdoAjh",
        "options": {}
      },
      "id": "c2eac45e-ee53-4458-af02-0ccbb67b912c",
      "name": "→ Client Resolver",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        1120,
        -144
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 5
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -1600,
        -256
      ],
      "id": "acd1dd2c-d238-4b52-a986-f961c42b384d",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:debounce:pending",
        "propertyName": "value",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1392,
        -256
      ],
      "id": "9e6d7333-496d-44e5-9a21-676dd7bd43e6",
      "name": "Pop Batch Job",
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "id": "da8b3643-1e72-45cf-b710-4c8218a52755",
      "name": "Wait 10s (Debounce)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -928,
        -256
      ],
      "webhookId": "batch-debouncer-wait"
    }
  ],
  "connections": {
    "Init Debouncer": {
      "main": [
        [
          {
            "node": "Wait 10s (Debounce)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Last Seen": {
      "main": [
        [
          {
            "node": "Check Silence Duration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Silence Duration": {
      "main": [
        [
          {
            "node": "Ready to Process?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ready to Process?": {
      "main": [
        [
          {
            "node": "Prepare Pop",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait 10s (Debounce)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Pop": {
      "main": [
        [
          {
            "node": "Pop Message 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 6",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 7",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 8",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 9",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pop Message 10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 1": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 2": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 3": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 4": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 5": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 6": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 7": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 8": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 9": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message 10": {
      "main": [
        [
          {
            "node": "Combine Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Messages": {
      "main": [
        [
          {
            "node": "Is Batch Empty?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Batch Empty?": {
      "main": [
        [
          {
            "node": "Delete Queue (Empty)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Release Lock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Queue (Empty)": {
      "main": [
        [
          {
            "node": "Release Lock (Empty)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Release Lock": {
      "main": [
        [
          {
            "node": "→ Client Resolver",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Pop Batch Job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Batch Job": {
      "main": [
        [
          {
            "node": "Init Debouncer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 10s (Debounce)": {
      "main": [
        [
          {
            "node": "Get Last Seen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-25T13:52:16.776Z",
      "createdAt": "2025-11-25T13:52:16.776Z",
      "id": "KZWHB14qNi4HvGro",
      "name": "TaskWork"
    }
  ],
  "updatedAt": "2025-12-08T08:06:04.000Z",
  "createdAt": "2025-12-03T12:11:19.541Z"
}