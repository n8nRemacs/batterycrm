# BatteryCRM - Техническое задание: Обзор системы

**Версия:** 2.0
**Дата:** 2025-11-23
**Статус:** Актуальная спецификация

---

## Содержание

1. [Общее описание](#общее-описание)
2. [Архитектура системы](#архитектура-системы)
3. [Основные компоненты](#основные-компоненты)
4. [Функциональные модули](#функциональные-модули)
5. [Технологический стек](#технологический-стек)
6. [Безопасность и доступ](#безопасность-и-доступ)
7. [Производительность и масштабируемость](#производительность-и-масштабируемость)

---

## Общее описание

### Назначение системы

**BatteryCRM** — это интеллектуальная CRM-система для сервисных центров по ремонту электроники, обеспечивающая:
- Автоматизированный приём обращений из множественных каналов
- AI-обработку сообщений с извлечением структурированных данных
- Управление полным циклом обработки заявки (от обращения до завершения ремонта)
- Multi-tenant архитектуру для работы с несколькими сервисными центрами
- Интеграции с внешними CRM-системами и рекламными платформами

### Целевая аудитория

- **Сервисные центры** — ремонт мобильных телефонов, планшетов, ноутбуков
- **Операторы контакт-центров** — обработка входящих обращений
- **Мастера** — приём устройств, выполнение ремонтов
- **Менеджеры** — аналитика, управление процессами
- **Администраторы тенантов** — настройка системы под конкретный сервисный центр

### Ключевые преимущества

1. **Омниканальность** — единый интерфейс для 8+ каналов коммуникации
2. **AI-автоматизация** — автоматическое извлечение сущностей из сообщений
3. **Мультизаявки** — поддержка нескольких устройств и неисправностей в одной заявке
4. **Голосовые интерфейсы** — транскрибация, запись звонков, голосовые ответы оператора
5. **Автоматизация маркетинга** — промо-материалы, UTM-трекинг, ремаркетинг
6. **Гибкая интеграция** — LiveSklad, RemOnline, рекламные платформы

---

## Архитектура системы

### Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    ВХОДЯЩИЕ КАНАЛЫ                              │
│  WhatsApp │ Telegram │ VK │ Avito │ Instagram │ Звонки │ Формы  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   n8n WORKFLOWS (Микросервисы)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ BAT Message  │  │ BAT Appeal   │  │ BAT Universal│          │
│  │   Router     │  │   Router     │  │   Batcher    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  AI Processing: Claude AI (4 Tools для извлечения сущностей)    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   PostgreSQL DATABASE                           │
│  37 таблиц + 10 новых таблиц (мультизаявки, промо, прайсы)     │
│  Multi-Tenant изоляция через tenant_id                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    ПРИЛОЖЕНИЯ ОПЕРАТОРОВ                        │
│  ┌──────────────────────┐   ┌──────────────────────┐           │
│  │  Android Mobile App  │   │  Desktop App         │           │
│  │  - Голосовые ответы  │   │  - Полный функционал │           │
│  │  - Запись звонков    │   │  - Аналитика         │           │
│  │  - QR-сканирование   │   │  - Массовые операции │           │
│  │  - Push-уведомления  │   │  - Админка           │           │
│  └──────────────────────┘   └──────────────────────┘           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   ИСХОДЯЩИЕ ИНТЕГРАЦИИ                          │
│  WhatsApp │ Telegram │ VK │ Avito │ Instagram │ FCM             │
│  LiveSklad │ RemOnline │ Яндекс.Директ │ VK Ads │ Google Ads   │
└─────────────────────────────────────────────────────────────────┘
```

### Принципы архитектуры

1. **Event-Driven Architecture** — обработка событий через n8n workflows
2. **Microservices Pattern** — независимые workflows для разных задач
3. **Multi-Tenant Isolation** — полная изоляция данных на уровне БД (tenant_id)
4. **AI-First Approach** — AI на всех этапах обработки данных
5. **API-Centric** — все взаимодействие через REST API
6. **Stateless Operations** — сессии через JWT, состояние в БД

---

## Основные компоненты

### 1. n8n Workflows (Backend)

**Роль:** Микросервисная архитектура обработки событий

**Основные workflows:**

#### BAT Message Router
- **Назначение:** Маршрутизация всех входящих/исходящих сообщений
- **Функции:**
  - Приём сообщений из всех каналов
  - Определение типа сообщения (текст, медиа, голос)
  - Роутинг по типу обращения (новое/существующее)
  - Сохранение в `messages_history`
  - Отправка Push-уведомлений операторам

#### BAT Appeal Router
- **Назначение:** Управление жизненным циклом заявок
- **Функции:**
  - AI-обработка сообщений (извлечение сущностей)
  - Создание/обновление заявок
  - Управление переходами по воронке
  - Триггеры для промо-материалов
  - Синхронизация с CRM (LiveSklad, RemOnline)

#### BAT Universal Batcher
- **Назначение:** Батчинг и оптимизация нагрузки
- **Функции:**
  - Группировка однотипных операций
  - Отложенные задачи (scheduled jobs)
  - Массовые операции (bulk updates)
  - Оптимизация AI-запросов

#### BAT AI Tools (4 инструмента Claude AI)

**AI Tool 1: Appeal Type Classifier**
- Определение типа обращения:
  - `repair` — ремонт
  - `consultation` — консультация
  - `sale` — продажа
  - `purchase` — покупка/скупка
  - `spam` — спам

**AI Tool 2: Device Extractor**
- Извлечение данных устройства:
  - Бренд (brand_id)
  - Модель (model_id)
  - Тип устройства (device_type_id)
  - Цвет, состояние, комплектация

**AI Tool 3: Issue Extractor**
- Извлечение данных о неисправности:
  - Категория ремонта (repair_category_id)
  - Тип неисправности (issue_type_id)
  - Симптомы
  - Возможные причины

**AI Tool 4: Multi-Entity Extractor** *(НОВЫЙ)*
- Извлечение **множественных** устройств и неисправностей:
  - Массив устройств
  - Массив неисправностей для каждого устройства
  - Структура: `appeal → devices[] → repairs[]`

### 2. PostgreSQL Database

**Роль:** Центральное хранилище всех данных

**Структура:**
- **37 существующих таблиц** — текущая реализация
- **~10 новых таблиц** — мультизаявки, промо, прайсы, этапы воронки

**Ключевые характеристики:**
- Multi-Tenant изоляция через `tenant_id`
- Row-Level Security (RLS) политики
- Полная нормализация (3NF)
- Индексы на все внешние ключи
- JSON поля для динамических параметров
- TTL политики для архивации старых данных

**Основные таблицы:**
- `tenants` — сервисные центры
- `clients` — клиенты
- `appeals` — заявки
- `appeal_devices` — устройства в заявке (НОВАЯ)
- `appeal_repairs` — неисправности устройств (НОВАЯ)
- `operators` — операторы
- `operator_devices` — устройства операторов (multi-device sessions)
- `messages_history` — история сообщений
- `appeal_stages` — этапы воронки (НОВАЯ)
- `promo_materials` — промо-материалы (НОВАЯ)
- `price_lists` — прайсы поставщиков (НОВАЯ)

### 3. Android Mobile Application

**Роль:** Основное рабочее приложение операторов

**Технологии:**
- Kotlin
- Jetpack Compose
- FCM (Push-уведомления)
- Android SpeechRecognizer API
- InCallService API (запись звонков)
- CameraX (QR-сканирование)

**Функциональность:**
- Обработка всех входящих сообщений
- Просмотр и редактирование сущностей заявок
- Отправка текстовых сообщений, фото, видео
- **Голосовые ответы** (SpeechRecognizer → AI оформление → отправка)
- **Запись звонков** (InCallService + Whisper транскрибация)
- **QR-сканирование** (приём устройств на визит)
- Выставление стоимости ремонта
- Запись клиента на визит
- Просмотр промо-материалов
- Push-уведомления в реальном времени

**Multi-Device Session Management:**
- 1 мобильная сессия + 1 desktop сессия
- Авторизация на новом устройстве завершает старую сессию того же типа
- JWT токены с привязкой к `device_id`

### 4. Desktop Application

**Роль:** Расширенный функционал для операторов на ПК

**Технологии:**
- Electron (или Tauri)
- React / Vue.js
- REST API

**Функциональность:**
- Весь функционал Android-приложения (кроме voice/calls)
- Расширенная аналитика
- Админка тенанта
- Массовые операции
- Детальные отчёты
- Управление промо-материалами
- Загрузка прайс-листов
- Настройка воронки

### 5. FCM Push Notification Service

**Роль:** Мгновенные уведомления операторам

**Технологии:**
- Firebase Cloud Messaging (FCM)
- JWT аутентификация

**События:**
- Новое сообщение от клиента
- Новая заявка
- Переход заявки на следующий этап
- Клиент пришёл на визит (QR сканирован мастером)
- Завершение ремонта в CRM

---

## Функциональные модули

### Модуль 1: Омниканальная коммуникация

**Входящие каналы:**
1. **WhatsApp** — текст, фото, видео, голосовые сообщения
2. **Telegram** — текст, медиа, голосовые, файлы
3. **VK** — сообщения, вложения, голосовые
4. **Avito** — сообщения из чатов
5. **Instagram** — Direct-сообщения
6. **Лид-формы и сайт** — веб-формы, кнопки, лендинги
7. **Телефонные звонки** — запись, транскрибация
8. **Голосовые сообщения** — конвертация в текст

**Исходящие каналы:**
- Те же, что и входящие
- Единый интерфейс отправки в приложении оператора

### Модуль 2: AI-обработка обращений

**Цель:** Автоматическое извлечение структурированных данных из неструктурированного текста

**Процесс:**
1. Клиент отправляет сообщение (текст/голос)
2. Голосовые конвертируются в текст (Whisper API)
3. AI Tool 1 определяет тип обращения
4. AI Tool 2 извлекает данные устройства
5. AI Tool 3 извлекает данные неисправности
6. AI Tool 4 извлекает множественные сущности (если есть)
7. Данные сохраняются в БД
8. Оператор видит структурированную заявку

**Особенности:**
- Контекстная обработка (учёт истории диалога)
- Уточняющие вопросы клиенту при неполных данных
- Оператор может исправить AI-результаты

### Модуль 3: Мультизаявки

**Проблема:** Клиент может принести несколько устройств с разными неисправностями

**Решение:**
```
appeal (заявка)
├── appeal_devices[] (устройства)
│   ├── device 1
│   │   ├── repair 1
│   │   ├── repair 2
│   │   └── repair 3
│   └── device 2
│       ├── repair 1
│       └── repair 2
```

**Структура БД:**
- `appeals` — основная заявка
- `appeal_devices` — устройства в заявке (1:N)
- `appeal_repairs` — неисправности устройства (1:N)

**Гибридный подход:**
- Простые заявки (1 устройство, 1 неисправность) — старая структура
- Сложные заявки — новая структура
- Автоматическое определение типа

### Модуль 4: Детальная воронка (9 этапов)

**Цель:** Точное отслеживание пути клиента от обращения до завершения

**Этапы:**

| # | Название этапа | Группа | Описание |
|---|---|---|---|
| 1 | New Empty | initial | Минимальные данные, клиент проявил интерес |
| 2 | Сбор информации | initial | Уточнение модели, поломки, деталей |
| 3 | Информация собрана | processing | Все обязательные поля заполнены |
| 4 | Цена отправлена | processing | Предложение отправлено клиенту |
| 5 | Клиент подтвердил | confirmed | Клиент согласился на ремонт |
| 6 | QR-код отправлен | confirmed | Клиент получил код для визита |
| 7 | Клиент пришёл | confirmed | Мастер отсканировал QR |
| 8 | Ремонт выполнен | completed | Ремонт завершён |
| 9 | Отказ/невыкуп/спам | cancelled | Заявка закрыта |

**Миграция:**
- Текущие 5 этапов маппятся на новые 9
- Обратная совместимость сохраняется

### Модуль 5: Голосовые ответы оператора

**Цель:** Ускорить работу оператора, убрав необходимость печатать

**Процесс:**
1. Оператор нажимает кнопку микрофона в Android-приложении
2. Android SpeechRecognizer распознаёт речь → `rawText`
3. `rawText` отправляется на backend endpoint `/format-voice-response`
4. AI (Claude) оформляет текст:
   - Исправляет грамматику
   - Приводит к стилю сервиса
   - Добавляет вежливые формулировки
5. Оформленный текст отправляется клиенту через нужный канал

**Важно:**
- Только Android (НЕ Desktop)
- Транскрибация: Android SpeechRecognizer (НЕ Whisper)
- Оформление: AI через новый endpoint

### Модуль 6: Запись и транскрибация звонков

**Цель:** Сохранить всю информацию из телефонных разговоров

**Технология:**
- **Android 10+:** InCallService API / CallScreeningService API
- **НЕ через провайдера телефонии**
- Запись прямо из телефона оператора

**Процесс:**
1. Входящий/исходящий звонок
2. InCallService начинает запись
3. Звонок завершён → аудио сохраняется локально
4. Аудио отправляется на backend
5. Whisper API транскрибирует аудио → текст
6. AI извлекает сущности из транскрипта
7. Данные добавляются к заявке

**Хранение:**
- Аудио: S3 / облачное хранилище
- Транскрипт: `messages_history.content`
- Извлечённые сущности: таблицы `appeal_devices`, `appeal_repairs`

### Модуль 7: QR-код заявки

**Цель:** Быстрая идентификация клиента при визите в сервис

**Процесс:**
1. Клиент подтверждает ремонт
2. Система генерирует уникальный QR-код с `appeal_id`
3. QR-код отправляется клиенту (WhatsApp/Telegram/и т.д.)
4. Клиент приходит в сервис
5. Мастер сканирует QR-код (Android-приложение)
6. Заявка автоматически переводится на этап "Клиент пришёл"
7. Данные синхронизируются с CRM (LiveSklad/RemOnline)

**Структура QR:**
```json
{
  "appeal_id": "uuid",
  "tenant_id": "uuid",
  "timestamp": "ISO8601"
}
```

### Модуль 8: Полуавтоматический расчёт стоимости

**Цель:** Ускорить выставление цен, сохранив контроль оператора

**Компоненты:**
1. **Загрузка прайсов:**
   - CSV/Excel от поставщиков
   - Парсинг и нормализация
   - Сохранение в `price_lists`

2. **Привязка деталей:**
   - Автоматическое сопоставление:
     - brand_id
     - model_id
     - repair_category_id
     - issue_type_id
   - Ручное уточнение при неоднозначности

3. **Подсказка оператору:**
   - Список подходящих деталей
   - Цены поставщиков
   - Рекомендуемая розничная цена

4. **Выставление цены:**
   - Оператор выбирает деталь
   - Оператор корректирует цену (при необходимости)
   - Цена сохраняется в `appeal_repairs.estimated_cost`

**Таблицы БД:**
- `price_lists` — прайсы поставщиков
- `price_list_items` — позиции в прайсах
- `price_mappings` — привязка к брендам/моделям

### Модуль 9: Автоматические промо-материалы

**Цель:** Автоматическая отправка релевантных материалов клиенту

**Триггеры отправки:**
- После отправки цены
- После отправки QR-кода
- При подтверждении клиентом
- При определённых комбинациях модели и поломки

**Контекстный подбор:**
```
IF (brand_id = "Apple" AND repair_category = "Дисплей")
   → отправить видео "Как происходит замена дисплея на iPhone"

IF (appeal_stage = "QR-код отправлен")
   → отправить PDF "Схема прохода к сервису"

IF (issue_type = "Не включается")
   → отправить текст "Рекомендации перед визитом"
```

**Типы материалов:**
- Видео (YouTube, прямые ссылки)
- PDF (инструкции, схемы)
- Изображения (баннеры, карты)
- Текстовые подсказки

**Структура БД:**
- `promo_materials` — библиотека материалов
- `promo_triggers` — правила отправки
- `promo_history` — история отправок

### Модуль 10: Интеграции с CRM

**LiveSklad (Лайфсклад):**
- Создание заказа при переходе на этап "Клиент пришёл"
- Передача данных:
  - Устройство (brand, model, device_type)
  - Неисправности (issue_type, repair_category)
  - Стоимость (estimated_cost)
  - Контакты клиента
- Получение результата:
  - Фактическая стоимость
  - Типы выполненных работ
  - Статус ремонта

**RemOnline:**
- Аналогично LiveSklad
- Поддержка API v2
- Синхронизация статусов

**Таблицы БД:**
- `crm_integrations` — настройки интеграций
- `crm_sync_history` — история синхронизаций
- `crm_mappings` — маппинг сущностей

### Модуль 11: Маркетинг и UTM

**Источники:**
- Яндекс.Директ
- РСЯ
- VK Реклама
- Google Ads
- Avito Ads
- Instagram Ads
- UTM-метки сайта

**Функции:**
1. **Трекинг источников:**
   - Привязка заявки к рекламному источнику
   - Привязка к конкретному объявлению
   - Сохранение UTM-меток

2. **Формирование аудиторий:**
   - Успешные ремонты → аудитория "Постоянные клиенты"
   - Отказы → аудитория "Не дошедшие"
   - Этап "Цена отправлена" → аудитория "Ремаркетинг"

3. **Автоматическая выгрузка:**
   - API Яндекс.Директ
   - API VK Реклама
   - API Google Ads

**Таблицы БД:**
- `utm_sources` — рекламные источники
- `utm_campaigns` — кампании
- `utm_ads` — объявления
- `remarketing_audiences` — аудитории

### Модуль 12: Аналитика

**Метрики:**
- Конверсия по этапам воронки
- Статистика источников обращений
- Статистика по операторам
- Статистика по устройствам и поломкам
- Успешные/неуспешные ремонты
- Средний чек
- Время обработки заявки
- Загруженность сервиса

**Дашборды:**
- Реальное время (real-time)
- Ежедневные отчёты
- Еженедельные отчёты
- Месячные отчёты

---

## Технологический стек

### Backend
- **n8n** — Workflow automation (микросервисы)
- **PostgreSQL** — База данных (v14+)
- **OpenAI API** — Claude AI для извлечения сущностей
- **Whisper API** — Транскрибация аудио
- **JWT** — Аутентификация и авторизация
- **REST API** — Все взаимодействия

### Frontend
- **Android:** Kotlin, Jetpack Compose, FCM
- **Desktop:** Electron/Tauri, React/Vue.js
- **Push:** Firebase Cloud Messaging (FCM)

### Интеграции
- **WhatsApp:** Meta Business API / Twilio
- **Telegram:** Telegram Bot API
- **VK:** VK API
- **Avito:** Avito API
- **Instagram:** Instagram Graph API
- **LiveSklad:** API v1
- **RemOnline:** API v2

### Инфраструктура
- **Сервер:** VPS/Dedicated (n8n)
- **База данных:** PostgreSQL (managed или self-hosted)
- **Файловое хранилище:** S3-совместимое (аудио, медиа)
- **Push-сервис:** Firebase Cloud Messaging

---

## Безопасность и доступ

### Multi-Tenant Isolation

**Уровень БД:**
- Все таблицы содержат `tenant_id`
- Row-Level Security (RLS) политики:
  ```sql
  CREATE POLICY tenant_isolation ON appeals
  FOR ALL USING (tenant_id = current_setting('app.current_tenant')::uuid);
  ```

**Уровень приложения:**
- JWT токен содержит `tenant_id`
- Все запросы фильтруются по `tenant_id`
- Операторы видят только данные своего тенанта

### Аутентификация

**Операторы:**
- Логин/пароль
- JWT токены с TTL = 7 дней
- Привязка к `device_id` (multi-device sessions)

**Мастера:**
- Те же механизмы
- Дополнительно: QR-сканирование (доступ к заявкам)

### Авторизация

**Роли:**
- `admin` — администратор тенанта (все права)
- `operator` — оператор (обработка заявок)
- `master` — мастер (QR-сканирование, просмотр заявок)
- `manager` — менеджер (только аналитика)

**Разрешения:**
- Таблица `role_permissions`
- Проверка на уровне API

### Шифрование

- HTTPS для всех API
- Шифрование JWT токенов
- Шифрование чувствительных данных в БД (опционально)

---

## Производительность и масштабируемость

### Требования к производительности

| Метрика | Целевое значение |
|---------|-----------------|
| API response time | < 200ms (95th percentile) |
| Push-уведомления | < 1 sec (доставка) |
| AI-обработка сообщения | < 3 sec |
| Транскрибация голосовых | < 5 sec (30 sec аудио) |
| Конкурентные операторы | 100+ одновременно |
| Сообщений в день | 10 000+ |

### Оптимизации

1. **Батчинг AI-запросов** — группировка в BAT Universal Batcher
2. **Индексы БД** — на все FK и часто фильтруемые поля
3. **Кэширование** — справочники (brands, models, issue_types)
4. **Пагинация** — все списки с лимитами
5. **Lazy loading** — подгрузка истории сообщений по требованию

### Масштабируемость

- **Горизонтальное масштабирование n8n** — добавление worker-нод
- **Read replicas PostgreSQL** — чтение с реплик
- **CDN для медиа** — статика через S3 + CDN
- **Multi-Tenant** — изоляция позволяет добавлять тенанты без изменений архитектуры

---

## Связанные документы

- [02_DATABASE_SCHEMA_EXTENDED.md](02_DATABASE_SCHEMA_EXTENDED.md) — Полная схема БД
- [03_WORKFLOWS_COMPLETE.md](03_WORKFLOWS_COMPLETE.md) — Детальное описание workflows
- [04_API_SPECIFICATION.md](04_API_SPECIFICATION.md) — REST API спецификация
- [05_ANDROID_APP_SPEC.md](05_ANDROID_APP_SPEC.md) — Спецификация Android-приложения
- [06_DESKTOP_APP_SPEC.md](06_DESKTOP_APP_SPEC.md) — Спецификация Desktop-приложения
- [07_INTEGRATIONS.md](07_INTEGRATIONS.md) — Детали всех интеграций
- [08_DEPLOYMENT_GUIDE.md](08_DEPLOYMENT_GUIDE.md) — Руководство по развёртыванию

---

**Архив старых ТЗ:** [../archive/](../archive/)
