# Логика обработки сообщений

> Спецификация алгоритма обработки входящих сообщений с извлечением сущностей, матчингом с графом и управлением фокусом диалога.

**Создано:** 2025-12-08
**Статус:** В разработке

---

## 1. Общий принцип

```
ЗАПИСАТЬ → ВЫТАЩИТЬ → АНАЛИЗИРОВАТЬ
```

1. **ЗАПИСАТЬ** — сохранить сообщение как Touchpoint в граф
2. **ВЫТАЩИТЬ** — получить полный контекст клиента из графа
3. **АНАЛИЗИРОВАТЬ** — определить чего не хватает, сгенерировать ответ

---

## 2. Приоритет сбора данных

| Приоритет | Поле | Обязательно | Источник |
|-----------|------|-------------|----------|
| 1 | Клиент | Да | Автоматически из канала |
| 2 | Модель | Да | Спросить если не указано |
| 3 | Владелец | Нет | Записать если упомянул, иначе "свой" |
| 4 | Поломка | Да | Спросить после модели |

---

## 3. Фокус диалога

### 3.1. Структура фокуса

```
ФОКУС = {
  device_id: UUID,      // текущее устройство
  problem_id: UUID,     // текущая поломка
  updated_at: timestamp // когда обновлён
}
```

### 3.2. Правила фокуса

- Фокус держится пока клиент не переключится явно
- Новая поломка → обновить `problem_id`, оставить `device_id`
- Новое устройство → обновить оба
- Возврат "к первому телефону" → восстановить предыдущий фокус

---

## 4. Извлечение сущностей из сообщения

### 4.1. Типы сущностей

| Сущность | Примеры | Слот |
|----------|---------|------|
| Бренд | Apple, Samsung, Xiaomi | `brand` |
| Модель | iPhone 14 Pro, Galaxy S23 | `model` |
| Владелец | мой, сына, жены, друга | `owner_label` |
| Поломка | экран, батарея, зарядка | `problem_type` |
| Действие | починить, заменить, проверить | `action` |

### 4.2. Примеры извлечения

**Сообщение:** "iPhone 14 Pro это телефон сына можно починить?"

```json
{
  "brand": "Apple",
  "model": "iPhone 14 Pro",
  "owner_label": "сына",
  "problem_type": null,
  "action": "repair"
}
```

**Сообщение:** "Экран разбит"

```json
{
  "brand": null,
  "model": null,
  "owner_label": null,
  "problem_type": "display",
  "action": null
}
```

**Сообщение:** "Ок"

```json
{
  "brand": null,
  "model": null,
  "owner_label": null,
  "problem_type": null,
  "action": null
}
// Пустое → интерпретировать как подтверждение
```

---

## 5. Типы сообщений по содержанию

| Тип | Содержит | Пример | Действие |
|-----|----------|--------|----------|
| `empty` | ничего | "Ок", "Да" | подтверждение |
| `device_only` | brand/model | "iPhone 14 Pro" | создать/найти устройство |
| `problem_only` | problem | "Экран разбит" | добавить к фокусу |
| `device+problem` | оба | "iPhone экран разбит" | устройство + поломка |
| `owner_only` | owner | "Это телефон сына" | уточнить owner |
| `question` | вопрос | "Сколько стоит?" | ответить |
| `full` | всё | "iPhone 14 Pro сына экран" | полный контекст |

---

## 6. Матчинг с графом

### 6.1. Алгоритм

```
[Извлечённые сущности]
        ↓
[Запрос в граф: что есть у клиента?]
        ↓
[Сравнение: извлечённое vs существующее]
        │
        ├── Полное совпадение → переключить фокус
        ├── Частичное совпадение → дополнить
        └── Нет совпадений → создать новое
```

### 6.2. Матчинг устройств

| Извлечено | В графе | Результат |
|-----------|---------|-----------|
| Samsung + жены | Samsung + жены | Найдено → фокус |
| Samsung + жены | Samsung (без owner) | Уточнить: "Это тот Samsung?" |
| Samsung + жены | iPhone + жены | Другое → создать новое |
| Samsung (без owner) | Samsung + жены, Samsung + свой | Уточнить: "Какой Samsung?" |

### 6.3. Матчинг поломок

| Извлечено | У устройства | Результат |
|-----------|--------------|-----------|
| экран | экран | Найдено → фокус |
| экран | батарея | Новая → добавить |
| экран | (пусто) | Первая → добавить |

---

## 7. Полный алгоритм обработки

```
Сообщение пришло
        ↓
[1. Извлечь сущности из текста]
    → brand? model? owner? problem?
        ↓
[2. Запрос в граф]
    → Все устройства клиента
    → Все поломки по устройствам
        ↓
[3. Матчинг]
    Если есть brand/model:
        → Сравнить с существующими устройствами
        → Найдено? → фокус на существующее
        → Не найдено? → создать новое

    Если есть problem:
        → Сравнить с поломками текущего устройства
        → Найдено? → фокус на эту поломку
        → Не найдено? → добавить новую

    Если есть owner:
        → Применить к текущему устройству

    Если пусто:
        → Интерпретировать как реакцию
        ↓
[4. Записать в граф]
    → Touchpoint с связями
    → Новые сущности если созданы
        ↓
[5. Обновить фокус]
    → (device_id, problem_id)
        ↓
[6. Проверить полноту]
    → Нет модели? → спросить
    → Нет поломки? → спросить
    → Всё есть? → расчёт
        ↓
[7. Сгенерировать ответ]
```

---

## 8. Жизненный цикл устройства

### 8.1. Создание (один раз)

```
Первое упоминание устройства
        ↓
Создать Device:
    - brand (неизменно)
    - model (неизменно)
    - owner_label (неизменно после установки)
```

### 8.2. Дополнение

```
Последующие сообщения
        ↓
Добавлять Problem к Device:
    - Первая поломка
    - Вторая поломка
    - И т.д.
```

### 8.3. Что НЕ меняется

- brand/model устройства
- owner_label после первого указания

### 8.4. Что меняется

- Список поломок (добавляются новые)
- Фокус (переключается между устройствами/поломками)

---

## 9. Пример диалога

```
Бот: "Здравствуйте! Какое устройство нужно починить?"
ФОКУС: (null, null)

К: "iPhone 14 Pro"
   extracted: {brand: Apple, model: iPhone 14 Pro}
   → Запрос в граф: есть iPhone 14 Pro? → Нет
   → Создать device_1
   ФОКУС: (device_1, null)

Бот: "Что нужно починить?"

К: "Экран"
   extracted: {problem: display}
   → Добавить problem_1 к device_1
   ФОКУС: (device_1, problem_1)

Бот: "Замена экрана. Чей телефон?"

К: "Сына"
   extracted: {owner: сына}
   → Обновить device_1.owner_label = "сына"
   ФОКУС: (device_1, problem_1)

Бот: "iPhone 14 Pro сына, замена экрана. Верно?"

К: "И батарея ещё"
   extracted: {problem: battery}
   → Добавить problem_2 к device_1
   ФОКУС: (device_1, problem_2)

Бот: "Добавил батарею. Итого: экран + батарея."

К: "А у жены тоже iPhone 14 Pro"
   extracted: {brand: Apple, model: iPhone 14 Pro, owner: жены}
   → Запрос в граф: есть iPhone 14 Pro owner=жены? → Нет
   → Создать device_2
   ФОКУС: (device_2, null)

Бот: "iPhone 14 Pro жены. Что с ним?"

К: "Зарядка не работает"
   extracted: {problem: charging}
   → Добавить problem_3 к device_2
   ФОКУС: (device_2, problem_3)

К: "А что там по телефону сына?"
   extracted: {} + reference to "сына"
   → Запрос в граф: найти устройство owner=сына
   → Переключить фокус
   ФОКУС: (device_1, problem_2)

Бот: "iPhone 14 Pro сына: экран + батарея. Продолжаем?"
```

---

## 10. Cypher запросы для графа

### 10.1. Получить устройства клиента

```cypher
MATCH (c:Client {id: $client_id})-[:OWNS]->(d:Device)
OPTIONAL MATCH (d)-[:HAS_PROBLEM]->(p:Problem)
RETURN d, collect(p) as problems
```

### 10.2. Найти устройство по параметрам

```cypher
MATCH (c:Client {id: $client_id})-[:OWNS]->(d:Device)
WHERE d.brand = $brand
  AND d.model = $model
  AND (d.owner_label = $owner_label OR $owner_label IS NULL)
RETURN d
```

### 10.3. Найти поломку у устройства

```cypher
MATCH (d:Device {id: $device_id})-[:HAS_PROBLEM]->(p:Problem)
WHERE p.type = $problem_type
RETURN p
```

---

## 11. Следующие шаги реализации

1. [ ] Обновить Task Dispatcher — добавить извлечение сущностей
2. [ ] Создать workflow "Entity Matcher" — матчинг с графом
3. [ ] Обновить BAT_AI_Appeal_Router — логика фокуса
4. [ ] Исправить SQL — не создавать дубли устройств
5. [ ] Тестирование на реальных диалогах

---

*Связанные документы:*
- [Eldoleado_Мультичат_ТЗ_v2.md](../../Plans/Eldoleado_Мультичат_ТЗ_v2.md)
- [Eldoleado_Спецификация_Графа.md](../../Plans/Eldoleado_Спецификация_Графа.md)
