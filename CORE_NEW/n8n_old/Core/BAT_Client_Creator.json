{
  "id": "vkQwat1iZhJJj7C9",
  "name": "BAT Client Creator",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "3a851a11-46ca-4944-95d9-8f9c5948efbb",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        384,
        816
      ]
    },
    {
      "parameters": {
        "workflowId": "=laevudT8uPlXjpap",
        "options": {}
      },
      "id": "a7f27735-6b8f-4e52-b98c-c28a8bf07341",
      "name": "Execute Appeal Manager",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        1760,
        816
      ]
    },
    {
      "parameters": {
        "jsCode": "const inMessage = $('Execute Workflow Trigger').first()?.json || {};\n// –Ø–≤–Ω–æ —á–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥ –∏–∑ –Ω–æ–¥—ã 'Create Client' (Postgres)\nconst items = $items('Create Client');\nconst row = items.length ? (items[0].json || {}) : ($input.first()?.json || {});\n\nconst clientId = row.id ?? row.client_id ?? row.rows?.[0]?.id ?? row.data?.[0]?.id ?? null;\n\nconst out = {\n  ...inMessage,\n  client: {\n    id: clientId,\n    phone: row.phone ?? inMessage.client?.phone ?? null,\n    name: row.name ?? inMessage.client?.name ?? null,\n    telegram_id: row.telegram_id ?? inMessage.client?.telegram_id ?? null,\n    vk_id: row.vk_id ?? inMessage.client?.vk_id ?? null,\n    whatsapp_id: row.whatsapp_id ?? inMessage.client?.whatsapp_id ?? null,\n    avito_id: row.avito_id ?? inMessage.client?.avito_id ?? null,\n    created_now: true\n  },\n  client_found: Boolean(clientId)\n};\n\nreturn [{ json: out }];"
      },
      "id": "74610595-472b-4afc-84b8-3ab45455a618",
      "name": "Merge New Client1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        816
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first()?.json || {};\nconst sqlResult = $input.first()?.json;\n\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('üÜï CLIENT CREATED - SQL RESULT');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('SQL Result:', JSON.stringify(sqlResult, null, 2));\n\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nlet clientRow = sqlResult;\nif (Array.isArray(sqlResult)) {\n  console.log('SQL returned array with length:', sqlResult.length);\n  clientRow = sqlResult[0];\n}\n\nconsole.log('clientRow:', JSON.stringify(clientRow, null, 2));\n\nif (!clientRow || !clientRow.id) {\n  console.error('‚ùå ERROR: Client Creator SQL did not return ID!');\n  throw new Error('Client creation failed - no ID returned');\n}\n\nconsole.log('‚úÖ Client created with ID:', clientRow.id);\n\n// –ü–æ–ª—É—á–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Client Resolver\nconst sourceData = $('Execute Workflow Trigger').first()?.json || {};\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥\nconst output = {\n  ...sourceData,\n  client: {\n    id: clientRow.id,\n    phone: clientRow.phone || null,\n    name: clientRow.name || null,\n    telegram_id: clientRow.telegram_id || null,\n    vk_id: clientRow.vk_id || null,\n    whatsapp_id: clientRow.whatsapp_id || null,\n    avito_id: clientRow.avito_id || null,\n    was_merged: false\n  },\n  client_found: true\n};\n\nconsole.log('=== CLIENT CREATOR OUTPUT ===');\nconsole.log('client.id:', output.client.id);\n\nreturn output;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        816
      ],
      "id": "1d536096-4359-4de3-89f7-e64d7e6ed2e3",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH input_data AS (\n  SELECT\n    '{{ $json.tenant_id }}'::uuid as tenant_id,\n    CASE \n      WHEN '{{ $json.client_phone }}' IN ('', 'null', 'undefined', 'None') THEN NULL \n      ELSE '{{ $json.client_phone }}' \n    END as phone,\n    CASE \n      WHEN '{{ $json.client_name }}' IN ('', 'null', 'undefined', 'None') THEN NULL \n      ELSE '{{ $json.client_name }}' \n    END as name,\n    CASE \n      WHEN '{{ $json.channel }}' = 'telegram' THEN NULLIF('{{ $json.external_user_id }}', '') \n      ELSE NULL \n    END as telegram_id,\n    CASE \n      WHEN '{{ $json.channel }}' = 'vk' THEN NULLIF('{{ $json.external_user_id }}', '') \n      ELSE NULL \n    END as vk_id,\n    CASE \n      WHEN '{{ $json.channel }}' = 'whatsapp' THEN NULLIF('{{ $json.external_user_id }}', '') \n      ELSE NULL \n    END as whatsapp_id,\n    CASE \n      WHEN '{{ $json.channel }}' = 'avito' THEN NULLIF('{{ $json.external_user_id }}', '') \n      ELSE NULL \n    END as avito_id\n),\nexisting_client AS (\n  SELECT c.* \n  FROM clients c, input_data i\n  WHERE c.tenant_id = i.tenant_id\n    AND (\n      (i.phone IS NOT NULL AND c.phone = i.phone)\n      OR (i.telegram_id IS NOT NULL AND c.telegram_id = i.telegram_id)\n      OR (i.vk_id IS NOT NULL AND c.vk_id = i.vk_id)\n      OR (i.whatsapp_id IS NOT NULL AND c.whatsapp_id = i.whatsapp_id)\n      OR (i.avito_id IS NOT NULL AND c.avito_id = i.avito_id)\n    )\n  LIMIT 1\n),\ninserted AS (\n  INSERT INTO clients (tenant_id, phone, name, telegram_id, vk_id, whatsapp_id, avito_id)\n  SELECT tenant_id, phone, name, telegram_id, vk_id, whatsapp_id, avito_id\n  FROM input_data\n  WHERE NOT EXISTS (SELECT 1 FROM existing_client)\n  RETURNING *\n),\nupdated AS (\n  UPDATE clients c\n  SET\n    name = COALESCE(i.name, c.name),\n    phone = COALESCE(i.phone, c.phone),\n    telegram_id = COALESCE(i.telegram_id, c.telegram_id),\n    vk_id = COALESCE(i.vk_id, c.vk_id),\n    whatsapp_id = COALESCE(i.whatsapp_id, c.whatsapp_id),\n    avito_id = COALESCE(i.avito_id, c.avito_id),\n    updated_at = NOW()\n  FROM input_data i, existing_client ec\n  WHERE c.id = ec.id\n    AND c.tenant_id = i.tenant_id\n    AND EXISTS (SELECT 1 FROM existing_client)\n  RETURNING c.*\n)\nSELECT * FROM inserted\nUNION ALL\nSELECT * FROM updated;",
        "options": {}
      },
      "id": "ab430f58-d6a6-4cc3-abc4-acb8345dfa5d",
      "name": "Create Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        624,
        816
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Create Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge New Client1": {
      "main": [
        [
          {
            "node": "Execute Appeal Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Merge New Client1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Client": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:04:01.292Z",
      "createdAt": "2025-11-23T04:04:01.292Z",
      "id": "eiI07cPEeFxzR69p",
      "name": "Core"
    }
  ],
  "updatedAt": "2025-11-23T04:08:46.000Z",
  "createdAt": "2025-10-14T06:53:42.794Z"
}