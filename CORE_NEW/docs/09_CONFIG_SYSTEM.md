# ELDOLEADO: Система конфигураций

## Обзор

Система управления настройками с версионированием, обменом между пользователями и маркетплейсом. Снижает нагрузку на поддержку, создаёт сетевой эффект и дополнительную монетизацию.

---

## Бизнес-ценность

### Проблема

```
Традиционная поддержка:
──────────────────────
Клиент: "Как настроить автоответы?"
Поддержка: Объясняет 15 минут
Клиент: "А как сделать как у Васи?"
Поддержка: Ещё 15 минут

100 клиентов = 50+ часов поддержки в месяц
```

### Решение

```
С системой конфигов:
────────────────────
Клиент: "Как настроить автоответы?"
Другой клиент в чате: "Держи мой конфиг"
Клиент: Импортировал → работает

100 клиентов = 5 часов поддержки в месяц
```

### Выгоды

| Аспект | Эффект |
|--------|--------|
| **Снижение поддержки** | -90% обращений типа "как настроить" |
| **Онбординг** | Новичок за 5 минут получает рабочую систему |
| **Сетевой эффект** | Чем больше конфигов — тем ценнее платформа |
| **Монетизация** | Маркетплейс конфигов (комиссия 30%) |
| **Sticky** | Мои конфиги тут — уходить не хочется |
| **Community** | Пользователи помогают друг другу |

---

## Архитектура

### Структура настроек

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   TENANT                                                        │
│      │                                                          │
│      ├── CONFIG BLOCK: Автоответы                              │
│      │      ├── Ревизия #12 (текущая)                          │
│      │      ├── Ревизия #11                                    │
│      │      ├── Ревизия #10                                    │
│      │      └── ...                                            │
│      │                                                          │
│      ├── CONFIG BLOCK: Рабочие часы                            │
│      │      ├── Ревизия #5 (текущая)                           │
│      │      └── ...                                            │
│      │                                                          │
│      ├── CONFIG BLOCK: Шаблоны цен                             │
│      │      └── ...                                            │
│      │                                                          │
│      └── CONFIG BLOCK: Шаблоны сообщений                       │
│             └── ...                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Типы блоков настроек

```yaml
auto_replies:              # Автоответы
  rules:
    - trigger: "цена"
      match_type: "contains"
      response: "Диагностика бесплатно, ремонт от 1500₽"
    - trigger: "адрес"
      match_type: "contains"
      response: "ул. Пушкина, 10, вход со двора"
    - trigger: "когда"
      match_type: "contains"
      response: "Работаем ПН-СБ 10:00-20:00"

working_hours:             # Рабочее время
  timezone: "Europe/Moscow"
  schedule:
    monday:    { start: "10:00", end: "20:00" }
    tuesday:   { start: "10:00", end: "20:00" }
    wednesday: { start: "10:00", end: "20:00" }
    thursday:  { start: "10:00", end: "20:00" }
    friday:    { start: "10:00", end: "20:00" }
    saturday:  { start: "10:00", end: "16:00" }
    sunday:    null  # выходной
  holidays:
    - date: "2025-01-01"
      name: "Новый год"
    - date: "2025-01-07"
      name: "Рождество"

notifications:             # Уведомления
  channels:
    new_message:
      telegram: true
      email: false
      push: true
    no_reply_1h:
      telegram: true
      email: false
    daily_summary:
      telegram: false
      email: true
      time: "09:00"

intake_questions:          # Вопросы при приёмке
  categories:
    charging:
      - code: "other_cable_tried"
        question: "Другой кабель пробовали?"
        ask_order: 1
      - code: "wireless_works"
        question: "Беспроводная зарядка работает?"
        ask_order: 2
    display:
      - code: "touch_works"
        question: "Тачскрин работает?"
        ask_order: 1

price_templates:           # Шаблоны цен
  categories:
    display:
      iphone_14_pro:
        name: "Дисплей iPhone 14 Pro"
        price_min: 12000
        price_max: 18000
        time_minutes: 60
      iphone_14:
        name: "Дисплей iPhone 14"
        price_min: 8000
        price_max: 12000
        time_minutes: 45
    battery:
      iphone_14_pro:
        name: "Батарея iPhone 14 Pro"
        price_min: 3500
        price_max: 5000
        time_minutes: 30

message_templates:         # Шаблоны сообщений
  templates:
    ready_pickup:
      name: "Готов к выдаче"
      text: "Ваш {device} готов! Забрать можно по адресу: {address}. Работаем до {closing_time}."
    diagnostic_done:
      name: "Диагностика завершена"
      text: "Диагностика {device} завершена. Проблема: {diagnosis}. Стоимость ремонта: {price}₽. Срок: {time}."
    reminder_pickup:
      name: "Напоминание о выдаче"
      text: "Напоминаем: ваш {device} готов и ждёт вас! Храним бесплатно ещё {days} дней."

ai_prompts:                # Настройки AI (приватные, не экспортируются)
  tone: "friendly"
  language: "ru"
  signature: "С уважением, Сервис iPhone Pro"
```

---

## Версионирование (Git-like)

### Концепция

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   Каждое изменение = новая ревизия                             │
│   Можно откатиться на любую предыдущую версию                  │
│                                                                 │
│   CONFIG BLOCK: Автоответы                                     │
│   ─────────────────────────                                    │
│                                                                 │
│   #12 ← ТЕКУЩАЯ                                                │
│    │   "Добавил ответ про гарантию"                            │
│    │   Сегодня 14:30                                           │
│    │                                                            │
│   #11                                                          │
│    │   "Изменил цены на дисплеи"                               │
│    │   Вчера 18:45                                             │
│    │                                                            │
│   #10                                                          │
│    │   "Добавил выходные дни"                                  │
│    │   15 декабря                                              │
│    │                                                            │
│   ...                                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Операции

```
СОХРАНЕНИЕ
──────────
1. Текущий конфиг → создаётся ревизия (снапшот)
2. Новый конфиг → становится текущим
3. Номер ревизии +1

ОТКАТ
─────
1. Выбрать ревизию #N
2. Текущий конфиг → новая ревизия (чтобы можно было вернуть)
3. Конфиг из ревизии #N → становится текущим
4. Summary: "Откат к ревизии #N"

СРАВНЕНИЕ
─────────
Diff между любыми двумя ревизиями
Показывает что добавлено/удалено/изменено
```

### UI: История ревизий

```
┌─────────────────────────────────────────────────────────────────┐
│  АВТООТВЕТЫ                                    [Сохранить]      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ... редактор автоответов ...                                  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  ИСТОРИЯ ИЗМЕНЕНИЙ                              [Показать все]  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ #12  Сегодня 14:30                                      │   │
│  │      "Добавил ответ про гарантию"                       │   │
│  │      Изменено: +1 правило                               │   │
│  │                                      [Сравнить] [Откат] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ #11  Вчера 18:45                                        │   │
│  │      "Изменил цены на дисплеи"                          │   │
│  │      Изменено: 3 правила                                │   │
│  │                                      [Сравнить] [Откат] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ #10  15 декабря                                         │   │
│  │      "Добавил выходные дни"                             │   │
│  │      Изменено: +5 правил                                │   │
│  │                                      [Сравнить] [Откат] │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  💡 Храним 30 последних ревизий                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Модель доступа

### Четыре типа доступа

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   🔒 PRIVATE (приватный)                                       │
│   ──────────────────────                                       │
│   Только владелец видит конфиг                                 │
│   По умолчанию для всех новых конфигов                         │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🌍 PUBLIC (публичный)                                        │
│   ─────────────────────                                        │
│   Все пользователи видят бесплатно                             │
│   Можно копировать себе                                        │
│   Владелец тоже видит все публичные конфиги других             │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🤝 MUTUAL (взаимный)                                         │
│   ────────────────────                                         │
│   A открывает для B + B открывает для A = оба видят            │
│   Баш на баш — бесплатный обмен между равными                  │
│   Если один отзывает — оба теряют доступ                       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🎁 ONE-WAY (односторонний)                                   │
│   ──────────────────────────                                   │
│   A открывает для B — B видит, A ничего не получает            │
│   Сценарии:                                                    │
│   • 💰 Продажа — B заплатил, получил доступ навсегда           │
│   • 🎁 Подарок — A хочет поделиться бесплатно                  │
│   • 👨‍🏫 Менторство — A помогает новичку B                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Матрица доступов

| Тип | Кто видит | Взаимность | Оплата | Отзыв |
|-----|-----------|------------|--------|-------|
| 🔒 Private | Только я | — | — | — |
| 🌍 Public | Все | Нет | Бесплатно | Cooldown 7 дней |
| 🤝 Mutual | Конкретный user | Да, обязательно | Бесплатно | Cooldown 7 дней, оба теряют |
| 🎁 One-way | Конкретный user | Нет | Бесплатно | Cooldown 7 дней |
| 💰 Purchased | Конкретный user | Нет | Разовая | Нельзя отозвать |
| 🔄 Subscription | Конкретный user | Нет | Ежемесячно | Автоматически при неоплате |

### Логика взаимного доступа

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   СЦЕНАРИЙ: Взаимный обмен                                     │
│                                                                 │
│   User A                              User B                    │
│   ──────                              ──────                    │
│                                                                 │
│   1. Открывает доступ для B ─────────► Получает запрос         │
│      Статус: PENDING                                           │
│      A не видит конфиги B                                      │
│                                                                 │
│   2.                          ◄─────── Открывает доступ для A  │
│      Статус: ACTIVE                    Статус: ACTIVE          │
│                                                                 │
│   3. Видит конфиги B          ◄──────► Видит конфиги A         │
│                                                                 │
│   ─────────────────────────────────────────────────────────────│
│                                                                 │
│   ОТЗЫВ:                                                       │
│                                                                 │
│   4. A отзывает доступ ──────────────► B теряет доступ к A     │
│      A теряет доступ к B      ◄──────  (автоматически)         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Статусы доступа

```
NONE ──────► PENDING ──────► MUTUAL (active)
                │                   │
                │                   │
                ▼                   ▼
            DECLINED            REVOKED
            (отклонён)          (отозван)
```

---

## Защита от злоупотреблений

### Cooldown (период ожидания)

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   ПРАВИЛО: 7 дней между изменениями доступа                    │
│                                                                 │
│   Понедельник: Открыл доступ @user_a                           │
│                                                                 │
│   Вторник-воскресенье: Нельзя отозвать/изменить                │
│                                                                 │
│   Следующий понедельник: Можно изменить                        │
│                                                                 │
│   ─────────────────────────────────────────────────────────────│
│                                                                 │
│   ЭКСТРЕННЫЙ ОТЗЫВ: 1 раз в месяц                              │
│                                                                 │
│   Если очень нужно отозвать до истечения cooldown —            │
│   можно использовать экстренный отзыв (лимит 1/месяц)          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Зачем cooldown

```
Проблема без cooldown:
──────────────────────
1. Запросил доступ к крутому конфигу
2. Скопировал себе
3. Сразу отозвал свой доступ
4. Халява!

С cooldown:
───────────
1. Запросил доступ
2. Открыл свой конфиг взамен
3. 7 дней оба видят конфиги друг друга
4. Честный обмен
```

### Репутация

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ                                         │
│                                                                 │
│   @master_ivan                                                 │
│   ⭐ 4.8 · 234 копирования · 45 взаимных доступов              │
│                                                                 │
│   📊 Статистика:                                               │
│   • Отзывов доступа: 2 (за всё время)                          │
│   • Экстренных отзывов: 0                                      │
│   • Жалоб: 0                                                   │
│                                                                 │
│   ✅ Надёжный партнёр для обмена                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   @suspicious_user                                             │
│   ⭐ 2.1 · 5 копирований · 12 взаимных доступов                │
│                                                                 │
│   📊 Статистика:                                               │
│   • Отзывов доступа: 15 (за 2 месяца)                          │
│   • Экстренных отзывов: 4                                      │
│   • Жалоб: 3                                                   │
│                                                                 │
│   ⚠️ Осторожно: часто отзывает доступ                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Экспорт / Импорт

### Формат файла

```json
{
    "version": "1.0",
    "exported_at": "2025-12-10T14:30:00Z",
    "block_type": "auto_replies",
    "block_name": "Автоответы для мастера iPhone",
    "author": "@master_ivan",
    "checksum": "sha256:abc123...",
    
    "config": {
        "rules": [
            {
                "trigger": "цена",
                "match_type": "contains",
                "response": "Диагностика бесплатно, ремонт от 1500₽"
            },
            {
                "trigger": "адрес",
                "match_type": "contains", 
                "response": "ул. Пушкина, 10"
            }
        ]
    }
}
```

### Санитизация при экспорте

```python
# Приватные поля — НЕ экспортируются
PRIVATE_FIELDS = [
    "api_keys",
    "tokens",
    "passwords",
    "phone_numbers",
    "email_addresses",
    "client_names",
    "client_ids",
    "payment_info",
    "personal_address",
    "bank_details"
]

def sanitize_config(config: dict) -> dict:
    """Удаляет приватные данные перед экспортом"""
    sanitized = deep_copy(config)
    
    for field in PRIVATE_FIELDS:
        remove_field_recursive(sanitized, field)
    
    # Заменяем конкретные адреса на плейсхолдеры
    sanitized = replace_patterns(sanitized, {
        r'\+7\d{10}': '{phone}',
        r'ул\. .+, \d+': '{address}',
        r'\S+@\S+\.\S+': '{email}'
    })
    
    return sanitized
```

### Валидация при импорте

```python
def validate_import(config: dict, target_tenant_id: str) -> ValidationResult:
    errors = []
    warnings = []
    
    # 1. Проверка схемы
    if not is_valid_schema(config):
        errors.append("Неверный формат конфигурации")
        return ValidationResult(valid=False, errors=errors)
    
    # 2. Проверка размера
    if len(json.dumps(config)) > MAX_CONFIG_SIZE:
        errors.append(f"Конфиг слишком большой (макс. {MAX_CONFIG_SIZE} байт)")
    
    # 3. Проверка на инъекции
    if contains_scripts(config):
        errors.append("Обнаружен подозрительный код")
    
    # 4. Проверка совместимости версий
    if config.get("version") != CURRENT_VERSION:
        warnings.append("Конфиг создан в другой версии, возможны несовместимости")
    
    # 5. Проверка плейсхолдеров (нужно заполнить)
    placeholders = find_placeholders(config)
    if placeholders:
        warnings.append(f"Нужно заполнить: {', '.join(placeholders)}")
    
    return ValidationResult(
        valid=len(errors) == 0,
        errors=errors,
        warnings=warnings,
        placeholders=placeholders
    )
```

### UI: Импорт конфига

```
┌─────────────────────────────────────────────────────────────────┐
│  ИМПОРТ КОНФИГУРАЦИИ                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📄 Файл: autoreplies_iphone_master.json                       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  Тип: Автоответы                                               │
│  Автор: @master_ivan                                           │
│  Создан: 10 декабря 2025                                       │
│  Содержит: 25 правил автоответов                               │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ⚠️ ТРЕБУЕТ ЗАПОЛНЕНИЯ:                                        │
│                                                                 │
│  {address}  →  [ул. Ленина, 15_____________]                   │
│  {phone}    →  [+7 999 123-45-67___________]                   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  РЕЖИМ ИМПОРТА:                                                │
│                                                                 │
│  ○ Заменить полностью (удалить мои правила)                    │
│  ● Добавить к существующим                                     │
│  ○ Только просмотреть (не применять)                           │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  💡 Текущие настройки будут сохранены в историю ревизий.       │
│     Вы сможете откатиться в любой момент.                      │
│                                                                 │
│                              [Отмена]  [Импортировать]         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Маркетплейс

### Типы листингов

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   🌍 БЕСПЛАТНЫЙ                                                │
│   ─────────────                                                │
│   Доступен всем                                                │
│   Автор получает: репутацию, благодарности                     │
│   Платформа получает: контент, лояльность                      │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   💰 РАЗОВАЯ ПОКУПКА                                           │
│   ──────────────────                                           │
│   Цена: 100-5000₽                                              │
│   Покупатель получает: текущую версию навсегда                 │
│   Автор получает: 70% от цены                                  │
│   Платформа получает: 30% комиссия                             │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   🔄 ПОДПИСКА                                                  │
│   ───────────                                                  │
│   Цена: 50-500₽/месяц                                          │
│   Покупатель получает: всегда актуальную версию                │
│   Автор получает: 70% ежемесячно                               │
│   Платформа получает: 30% ежемесячно                           │
│   При отмене: остаётся последняя версия                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   📦 ПАКЕТ                                                     │
│   ───────                                                      │
│   Несколько конфигов со скидкой                                │
│   Пример: Автоответы + Цены + Воронка = 1200₽ (вместо 1800₽)   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### UI: Маркетплейс

```
┌─────────────────────────────────────────────────────────────────┐
│  МАРКЕТПЛЕЙС КОНФИГОВ                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [🌍 Бесплатные]  [💰 Платные]  [🔄 Подписки]  [📦 Пакеты]     │
│                                                                 │
│  Категория: [Ремонт телефонов ▼]    Сортировка: [Популярные ▼] │
│  Поиск: [____________________________] 🔍                       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  ⭐ РЕКОМЕНДУЕМЫЕ                                               │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💎 PRO: Полный комплект мастерской               1200₽  │   │
│  │    @service_guru · ⭐ 4.9 · 156 продаж                  │   │
│  │                                                          │   │
│  │    ✓ Автоответы (30 правил)                             │   │
│  │    ✓ Шаблоны цен iPhone/Samsung                         │   │
│  │    ✓ Воронка продаж                                     │   │
│  │    ✓ Шаблоны сообщений                                  │   │
│  │                                                          │   │
│  │    🏷️ Экономия 600₽ от покупки по отдельности           │   │
│  │                                                          │   │
│  │    [Подробнее]                          [Купить 1200₽]  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  🌍 БЕСПЛАТНЫЕ                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🌍 Стартовый набор автоответов               БЕСПЛАТНО  │   │
│  │    @helpful_master · ⭐ 4.7 · 892 копирования           │   │
│  │    10 базовых правил для начинающих мастеров            │   │
│  │                                         [Скопировать]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  💰 ПЛАТНЫЕ                                                    │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 💰 Автоответы iPhone мастера                      500₽  │   │
│  │    @iphone_expert · ⭐ 4.9 · 89 продаж                  │   │
│  │    25 правил, конверсия в запись +40%                   │   │
│  │                                         [Купить 500₽]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔄 Актуальные цены на запчасти              100₽/мес   │   │
│  │    @price_tracker · ⭐ 4.6 · 234 подписчика             │   │
│  │    Обновляется 2 раза в неделю                          │   │
│  │                                       [Подписаться]     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### UI: Карточка товара

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Назад                                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💰 Автоответы iPhone мастера                                  │
│  ─────────────────────────────                                 │
│                                                                 │
│  @iphone_expert · ⭐ 4.9 (67 отзывов) · 89 продаж              │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ОПИСАНИЕ                                                      │
│                                                                 │
│  25 готовых правил автоответов для мастера по ремонту iPhone:  │
│                                                                 │
│  • Ответы на вопросы о ценах (12 правил)                       │
│  • График работы и адрес (5 правил)                            │
│  • Гарантия и сроки (5 правил)                                 │
│  • Акции и скидки (3 правила)                                  │
│                                                                 │
│  Настраивал 2 года на реальных клиентах.                       │
│  Конверсия в запись выросла на 40%.                            │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  СОДЕРЖИМОЕ (превью)                                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • "сколько стоит" → "Диагностика бесплатно..."         │   │
│  │ • "цена дисплей" → "Замена дисплея iPhone..."          │   │
│  │ • "адрес" → "Мы находимся по адресу..."                │   │
│  │ • ... и ещё 22 правила                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ОТЗЫВЫ                                                        │
│                                                                 │
│  ⭐⭐⭐⭐⭐ @master_sergey · 3 дня назад                         │
│  "Отличные автоответы! Сэкономил кучу времени."                │
│                                                                 │
│  ⭐⭐⭐⭐☆ @newbie_repair · неделю назад                         │
│  "Хорошо, но пришлось адаптировать под свои цены."             │
│                                                                 │
│  [Показать все 67 отзывов]                                     │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  500₽                                                          │
│  Разовая покупка · Доступ навсегда                             │
│                                                                 │
│                                            [Купить за 500₽]    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Экономика маркетплейса

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   РАСПРЕДЕЛЕНИЕ ДОХОДА                                         │
│                                                                 │
│   Покупатель платит: 500₽                                      │
│            │                                                    │
│            ├──► Автор: 350₽ (70%)                              │
│            │                                                    │
│            └──► Eldoleado: 150₽ (30%)                          │
│                                                                 │
│   ─────────────────────────────────────────────────────────────│
│                                                                 │
│   ПРИМЕР МЕСЯЧНОГО ДОХОДА АВТОРА                               │
│                                                                 │
│   Конфиг "Автоответы PRO" — 500₽                               │
│   Продаж в месяц: 30                                           │
│   Доход автора: 30 × 350₽ = 10,500₽/месяц                      │
│                                                                 │
│   ─────────────────────────────────────────────────────────────│
│                                                                 │
│   ПРИМЕР ДЛЯ ELDOLEADO                                         │
│                                                                 │
│   100 активных продавцов                                       │
│   Средний оборот: 5,000₽/месяц каждый                          │
│   Комиссия: 500,000₽ × 30% = 150,000₽/месяц                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Программа для топ-авторов

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   🏆 ЭКСПЕРТ ELDOLEADO                                         │
│                                                                 │
│   Требования:                                                  │
│   • 50+ продаж                                                 │
│   • Рейтинг 4.5+                                               │
│   • Нет жалоб                                                  │
│                                                                 │
│   Бонусы:                                                      │
│   • Комиссия снижена до 20% (вместо 30%)                       │
│   • Бейдж "Эксперт" в профиле                                  │
│   • Приоритет в выдаче маркетплейса                            │
│   • Бесплатный Pro-аккаунт                                     │
│   • Доступ к закрытому чату экспертов                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## UI: Управление доступом

### Настройка доступа к конфигу

```
┌─────────────────────────────────────────────────────────────────┐
│  АВТООТВЕТЫ — НАСТРОЙКИ ДОСТУПА                    [Сохранить] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ТИП ДОСТУПА                                                   │
│                                                                 │
│  ○ 🔒 Приватный                                                │
│       Только я вижу этот конфиг                                │
│                                                                 │
│  ○ 🌍 Публичный                                                │
│       Все пользователи видят бесплатно                         │
│                                                                 │
│  ● 🤝 Взаимный                                                 │
│       Обмен: я вижу их конфиги, они видят мой                  │
│                                                                 │
│  ○ 🎁 Односторонний                                            │
│       Открываю конкретным людям, ничего взамен не нужно        │
│                                                                 │
│  ○ 💰 Продажа                                                  │
│       Выставить в маркетплейс за деньги                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ДОСТУП ОТКРЫТ ДЛЯ                              [+ Добавить]   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @master_ivan        🤝 Взаимный                         │   │
│  │ Активен с 5 дек     Изменить можно через 2 дня          │   │
│  │                                          [Отозвать ❌]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @phone_service      ⏳ Ожидает взаимности               │   │
│  │ Запрос 8 дек        Ждём пока откроет свой конфиг       │   │
│  │                                          [Отозвать ❌]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @newbie_user        🎁 Подарок                          │   │
│  │ Активен с 1 дек     Изменить можно через 5 дней         │   │
│  │                                          [Отозвать ❌]   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @buyer_123          💰 Куплено                          │   │
│  │ Куплен 15 ноя       Доступ навсегда                     │   │
│  │                                          Нельзя отозвать │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ВХОДЯЩИЕ ЗАПРОСЫ (2)                                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @repair_pro хочет видеть ваш конфиг                     │   │
│  │ Чтобы увидеть его конфиги — откройте взаимный доступ    │   │
│  │                                                          │   │
│  │            [Открыть взаимный 🤝]  [Отклонить ❌]         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @another_user хочет видеть ваш конфиг                   │   │
│  │                                                          │   │
│  │            [Открыть взаимный 🤝]  [Отклонить ❌]         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Обзор доступных конфигов

```
┌─────────────────────────────────────────────────────────────────┐
│  ДОСТУПНЫЕ КОНФИГИ                                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [🌍 Публичные]  [🤝 Взаимные]  [💰 Купленные]  [📤 Мои]       │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  🤝 ВЗАИМНЫЙ ДОСТУП (3 пользователя)                           │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @master_ivan                                            │   │
│  │ Обмен с 5 декабря                                       │   │
│  │                                                          │   │
│  │ 📄 Автоответы (25 правил)              [Смотреть]       │   │
│  │ 📄 Шаблоны цен iPhone                  [Смотреть]       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ @repair_pro                                             │   │
│  │ Обмен с 1 декабря                                       │   │
│  │                                                          │   │
│  │ 📄 Воронка продаж                      [Смотреть]       │   │
│  │ 📄 Автоответы Samsung                  [Смотреть]       │   │
│  │ 📄 Рабочие часы                        [Смотреть]       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│  💰 КУПЛЕННЫЕ (2)                                              │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 📄 PRO: Полный комплект мастерской                      │   │
│  │    @service_guru · Куплено 15 ноября                    │   │
│  │                                        [Смотреть]       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🔄 Актуальные цены на запчасти                         │   │
│  │    @price_tracker · Подписка до 10 янв                  │   │
│  │    Последнее обновление: сегодня                        │   │
│  │                                        [Смотреть]       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Схема базы данных

### Таблицы

```sql
-- ═══════════════════════════════════════════════════════════════
-- БЛОКИ КОНФИГУРАЦИЙ
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_config_blocks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    
    -- Тип и название
    block_type VARCHAR(50) NOT NULL,
    block_name VARCHAR(255),
    
    -- Содержимое
    config JSONB NOT NULL,
    
    -- Версионирование
    revision_count INTEGER DEFAULT 0,
    
    -- Статус
    is_active BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_config_blocks_tenant ON elo_config_blocks(tenant_id);
CREATE INDEX idx_config_blocks_type ON elo_config_blocks(block_type);

-- ═══════════════════════════════════════════════════════════════
-- РЕВИЗИИ (ИСТОРИЯ ИЗМЕНЕНИЙ)
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_config_revisions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_block_id UUID NOT NULL REFERENCES elo_config_blocks(id) ON DELETE CASCADE,
    
    -- Номер ревизии
    revision_number INTEGER NOT NULL,
    
    -- Снапшот конфига
    config JSONB NOT NULL,
    
    -- Мета
    change_summary VARCHAR(500),
    changed_by UUID REFERENCES elo_users(id),
    
    -- Timestamp
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_config_revisions_block ON elo_config_revisions(config_block_id);
CREATE INDEX idx_config_revisions_number ON elo_config_revisions(config_block_id, revision_number DESC);

-- ═══════════════════════════════════════════════════════════════
-- ДОСТУПЫ К КОНФИГАМ
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_config_access (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Кто даёт доступ
    grantor_tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    config_block_id UUID NOT NULL REFERENCES elo_config_blocks(id),
    
    -- Кому (NULL = public)
    grantee_tenant_id UUID REFERENCES elo_tenants(id),
    
    -- Тип доступа
    access_type VARCHAR(20) NOT NULL,
    -- 'public'       — всем бесплатно
    -- 'mutual'       — взаимный обмен
    -- 'one_way'      — односторонний (подарок)
    -- 'purchased'    — куплено
    -- 'subscription' — подписка
    
    -- Статус
    status VARCHAR(20) DEFAULT 'active',
    -- 'pending'  — ожидает взаимности
    -- 'active'   — действует
    -- 'declined' — отклонён
    -- 'revoked'  — отозван
    -- 'expired'  — истекла подписка
    
    -- Для продаж
    purchase_id UUID REFERENCES elo_config_purchases(id),
    
    -- Для подписок
    subscription_expires_at TIMESTAMPTZ,
    
    -- Cooldown
    last_changed_at TIMESTAMPTZ DEFAULT NOW(),
    next_change_allowed_at TIMESTAMPTZ DEFAULT NOW() + INTERVAL '7 days',
    emergency_revokes_this_month INTEGER DEFAULT 0,
    emergency_revokes_reset_at TIMESTAMPTZ DEFAULT date_trunc('month', NOW()) + INTERVAL '1 month',
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_config_access_unique 
ON elo_config_access(grantor_tenant_id, config_block_id, grantee_tenant_id)
WHERE grantee_tenant_id IS NOT NULL;

CREATE UNIQUE INDEX idx_config_access_public 
ON elo_config_access(grantor_tenant_id, config_block_id)
WHERE grantee_tenant_id IS NULL AND access_type = 'public';

-- ═══════════════════════════════════════════════════════════════
-- МАРКЕТПЛЕЙС: ЛИСТИНГИ
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_marketplace_listings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Продавец и конфиг
    seller_tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    config_block_id UUID NOT NULL REFERENCES elo_config_blocks(id),
    
    -- Информация
    title VARCHAR(255) NOT NULL,
    description TEXT,
    preview JSONB,  -- превью содержимого
    
    -- Категория
    category VARCHAR(50),
    tags VARCHAR(50)[],
    
    -- Тип и цена
    listing_type VARCHAR(20) NOT NULL,  -- 'free', 'one_time', 'subscription'
    price_cents INTEGER DEFAULT 0,
    subscription_period_days INTEGER,
    
    -- Статистика
    copies_count INTEGER DEFAULT 0,      -- для бесплатных
    sales_count INTEGER DEFAULT 0,       -- для платных
    active_subscriptions INTEGER DEFAULT 0,
    
    -- Рейтинг
    rating_sum INTEGER DEFAULT 0,
    rating_count INTEGER DEFAULT 0,
    
    -- Модерация
    moderation_status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'approved', 'rejected'
    is_featured BOOLEAN DEFAULT false,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    published_at TIMESTAMPTZ
);

CREATE INDEX idx_marketplace_category ON elo_marketplace_listings(category);
CREATE INDEX idx_marketplace_type ON elo_marketplace_listings(listing_type);
CREATE INDEX idx_marketplace_featured ON elo_marketplace_listings(is_featured) WHERE is_featured = true;

-- ═══════════════════════════════════════════════════════════════
-- МАРКЕТПЛЕЙС: ПОКУПКИ
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_config_purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Связи
    listing_id UUID NOT NULL REFERENCES elo_marketplace_listings(id),
    buyer_tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    seller_tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    
    -- Финансы (в копейках)
    price_cents INTEGER NOT NULL,
    seller_payout_cents INTEGER NOT NULL,   -- 70%
    platform_fee_cents INTEGER NOT NULL,    -- 30%
    
    -- Статус
    status VARCHAR(20) DEFAULT 'completed',
    -- 'pending', 'completed', 'refunded', 'disputed'
    
    -- Для подписок
    subscription_started_at TIMESTAMPTZ,
    subscription_expires_at TIMESTAMPTZ,
    subscription_cancelled_at TIMESTAMPTZ,
    subscription_renewal_count INTEGER DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_purchases_buyer ON elo_config_purchases(buyer_tenant_id);
CREATE INDEX idx_purchases_seller ON elo_config_purchases(seller_tenant_id);

-- ═══════════════════════════════════════════════════════════════
-- МАРКЕТПЛЕЙС: ОТЗЫВЫ
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE elo_marketplace_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    listing_id UUID NOT NULL REFERENCES elo_marketplace_listings(id),
    purchase_id UUID NOT NULL REFERENCES elo_config_purchases(id),
    reviewer_tenant_id UUID NOT NULL REFERENCES elo_tenants(id),
    
    -- Отзыв
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    review_text TEXT,
    
    -- Модерация
    is_visible BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_reviews_unique ON elo_marketplace_reviews(listing_id, reviewer_tenant_id);
```

### Функции

```sql
-- ═══════════════════════════════════════════════════════════════
-- СОХРАНЕНИЕ КОНФИГА С РЕВИЗИЕЙ
-- ═══════════════════════════════════════════════════════════════

CREATE OR REPLACE FUNCTION save_config_with_revision(
    p_block_id UUID,
    p_new_config JSONB,
    p_user_id UUID,
    p_summary VARCHAR(500)
) RETURNS UUID AS $$
DECLARE
    v_current_config JSONB;
    v_revision_number INTEGER;
    v_revision_id UUID;
BEGIN
    -- Получить текущий конфиг
    SELECT config, revision_count 
    INTO v_current_config, v_revision_number
    FROM elo_config_blocks 
    WHERE id = p_block_id
    FOR UPDATE;
    
    -- Создать ревизию (снапшот старого конфига)
    INSERT INTO elo_config_revisions (
        config_block_id, 
        revision_number, 
        config, 
        change_summary,
        changed_by
    ) VALUES (
        p_block_id,
        v_revision_number + 1,
        v_current_config,
        p_summary,
        p_user_id
    ) RETURNING id INTO v_revision_id;
    
    -- Обновить текущий конфиг
    UPDATE elo_config_blocks 
    SET config = p_new_config,
        revision_count = v_revision_number + 1,
        updated_at = NOW()
    WHERE id = p_block_id;
    
    RETURN v_revision_id;
END;
$$ LANGUAGE plpgsql;

-- ═══════════════════════════════════════════════════════════════
-- ОТКАТ К РЕВИЗИИ
-- ═══════════════════════════════════════════════════════════════

CREATE OR REPLACE FUNCTION rollback_to_revision(
    p_block_id UUID,
    p_revision_number INTEGER,
    p_user_id UUID
) RETURNS UUID AS $$
DECLARE
    v_old_config JSONB;
BEGIN
    -- Получить конфиг из ревизии
    SELECT config INTO v_old_config
    FROM elo_config_revisions
    WHERE config_block_id = p_block_id
      AND revision_number = p_revision_number;
    
    IF v_old_config IS NULL THEN
        RAISE EXCEPTION 'Ревизия не найдена';
    END IF;
    
    -- Сохранить с созданием новой ревизии
    RETURN save_config_with_revision(
        p_block_id,
        v_old_config,
        p_user_id,
        format('Откат к ревизии #%s', p_revision_number)
    );
END;
$$ LANGUAGE plpgsql;

-- ═══════════════════════════════════════════════════════════════
-- ПРОВЕРКА ВЗАИМНОГО ДОСТУПА
-- ═══════════════════════════════════════════════════════════════

CREATE OR REPLACE FUNCTION check_mutual_access(
    p_viewer_tenant_id UUID,
    p_config_block_id UUID
) RETURNS BOOLEAN AS $$
DECLARE
    v_owner_tenant_id UUID;
    v_has_access BOOLEAN := false;
BEGIN
    -- Получить владельца конфига
    SELECT tenant_id INTO v_owner_tenant_id
    FROM elo_config_blocks
    WHERE id = p_config_block_id;
    
    -- Свой конфиг — всегда доступен
    IF p_viewer_tenant_id = v_owner_tenant_id THEN
        RETURN true;
    END IF;
    
    -- Проверить публичный доступ
    IF EXISTS (
        SELECT 1 FROM elo_config_access
        WHERE config_block_id = p_config_block_id
          AND access_type = 'public'
          AND status = 'active'
          AND grantee_tenant_id IS NULL
    ) THEN
        RETURN true;
    END IF;
    
    -- Проверить прямой доступ (purchased, one_way)
    IF EXISTS (
        SELECT 1 FROM elo_config_access
        WHERE config_block_id = p_config_block_id
          AND grantee_tenant_id = p_viewer_tenant_id
          AND access_type IN ('purchased', 'one_way')
          AND status = 'active'
    ) THEN
        RETURN true;
    END IF;
    
    -- Проверить взаимный доступ
    -- Владелец открыл для viewer
    IF EXISTS (
        SELECT 1 FROM elo_config_access
        WHERE grantor_tenant_id = v_owner_tenant_id
          AND grantee_tenant_id = p_viewer_tenant_id
          AND access_type = 'mutual'
          AND status = 'active'
    ) THEN
        -- Viewer открыл что-то для владельца
        IF EXISTS (
            SELECT 1 FROM elo_config_access
            WHERE grantor_tenant_id = p_viewer_tenant_id
              AND grantee_tenant_id = v_owner_tenant_id
              AND access_type = 'mutual'
              AND status = 'active'
        ) THEN
            RETURN true;
        END IF;
    END IF;
    
    RETURN false;
END;
$$ LANGUAGE plpgsql;
```

---

## Граф-схема (Neo4j)

```cypher
// ═══════════════════════════════════════════════════════════════
// УЗЛЫ
// ═══════════════════════════════════════════════════════════════

// Блок конфигурации
(:ELO_ConfigBlock {
    id: "uuid",
    tenant_id: "uuid",
    block_type: "auto_replies",
    block_name: "Мои автоответы",
    revision_count: 12,
    is_active: true,
    created_at: datetime,
    updated_at: datetime
})

// Ревизия
(:ELO_ConfigRevision {
    id: "uuid",
    revision_number: 11,
    config: {json_snapshot},
    change_summary: "Добавил ответ про гарантию",
    created_at: datetime
})

// Листинг в маркетплейсе
(:ELO_MarketplaceListing {
    id: "uuid",
    title: "PRO: Автоответы iPhone мастера",
    description: "25 правил...",
    listing_type: "one_time",
    price_cents: 50000,
    sales_count: 89,
    rating: 4.9,
    is_featured: true,
    created_at: datetime
})

// Покупка
(:ELO_ConfigPurchase {
    id: "uuid",
    price_cents: 50000,
    seller_payout_cents: 35000,
    platform_fee_cents: 15000,
    status: "completed",
    created_at: datetime
})

// ═══════════════════════════════════════════════════════════════
// СВЯЗИ
// ═══════════════════════════════════════════════════════════════

// Владение конфигом
(:ELO_Tenant)-[:OWNS_CONFIG]->(:ELO_ConfigBlock)

// История ревизий
(:ELO_ConfigBlock)-[:HAS_REVISION {number: 11}]->(:ELO_ConfigRevision)

// Доступы
(:ELO_Tenant)-[:GRANTS_ACCESS {
    access_type: "mutual",
    status: "active",
    created_at: datetime
}]->(:ELO_ConfigBlock)

(:ELO_ConfigBlock)-[:ACCESSIBLE_BY {
    access_type: "mutual",
    status: "active"
}]->(:ELO_Tenant)

// Маркетплейс
(:ELO_Tenant)-[:SELLS]->(:ELO_MarketplaceListing)
(:ELO_MarketplaceListing)-[:LISTING_FOR]->(:ELO_ConfigBlock)

// Покупки
(:ELO_Tenant)-[:PURCHASED]->(:ELO_ConfigPurchase)
(:ELO_ConfigPurchase)-[:PURCHASE_OF]->(:ELO_MarketplaceListing)
(:ELO_ConfigPurchase)-[:SOLD_BY]->(:ELO_Tenant)

// ═══════════════════════════════════════════════════════════════
// ЗАПРОСЫ
// ═══════════════════════════════════════════════════════════════

// Получить все доступные конфиги для tenant
MATCH (viewer:ELO_Tenant {id: $viewerTenantId})

// Свои конфиги
OPTIONAL MATCH (viewer)-[:OWNS_CONFIG]->(own:ELO_ConfigBlock)

// Публичные конфиги
OPTIONAL MATCH (public:ELO_ConfigBlock)<-[:GRANTS_ACCESS {access_type: 'public', status: 'active'}]-()

// Купленные конфиги
OPTIONAL MATCH (viewer)-[:PURCHASED]->(purchase:ELO_ConfigPurchase)-[:PURCHASE_OF]->(listing:ELO_MarketplaceListing)-[:LISTING_FOR]->(purchased:ELO_ConfigBlock)
WHERE purchase.status = 'completed'

// Взаимные доступы
OPTIONAL MATCH (viewer)-[:GRANTS_ACCESS {access_type: 'mutual', status: 'active'}]->(myConfig:ELO_ConfigBlock)
OPTIONAL MATCH (other:ELO_Tenant)-[:GRANTS_ACCESS {access_type: 'mutual', status: 'active'}]->(theirConfig:ELO_ConfigBlock)
WHERE (other)-[:OWNS_CONFIG]->(theirConfig)
  AND (theirConfig)-[:ACCESSIBLE_BY {access_type: 'mutual', status: 'active'}]->(viewer)

RETURN own, public, purchased, theirConfig
```

---

## Реализация по этапам

### Этап 1: MVP (2-3 недели)

```
Минимальная версия:
───────────────────
☐ Таблица elo_config_blocks
☐ Таблица elo_config_revisions
☐ UI редактора настроек
☐ История ревизий (последние 10)
☐ Кнопка "Откатить"
☐ Экспорт в JSON-файл
☐ Импорт из JSON-файла
☐ Санитизация при экспорте
```

### Этап 2: Обмен (2-3 недели)

```
Взаимный доступ:
────────────────
☐ Таблица elo_config_access
☐ UI настройки доступа
☐ Публичные конфиги
☐ Взаимный доступ (pending → active)
☐ Уведомления о запросах
☐ Cooldown 7 дней
☐ Экстренный отзыв
```

### Этап 3: Галерея (1-2 недели)

```
Бесплатный маркетплейс:
───────────────────────
☐ Галерея публичных конфигов
☐ Категории и поиск
☐ Рейтинги и отзывы
☐ "Скопировать себе" в 1 клик
☐ Счётчик копирований
```

### Этап 4: Монетизация (3-4 недели)

```
Платный маркетплейс:
────────────────────
☐ Таблицы listings, purchases, reviews
☐ Выставление на продажу
☐ Интеграция платежей
☐ Разовые покупки
☐ Подписки
☐ Выплаты авторам (70%)
☐ Пакеты конфигов
☐ Программа экспертов
```

---

## Метрики успеха

### KPI системы

| Метрика | Цель | Как измерять |
|---------|------|--------------|
| Снижение тикетов поддержки | -50% | Тикеты "как настроить" до/после |
| Активность обмена | 30% пользователей | Кол-во с mutual access |
| Конверсия в покупку | 5% просмотров | Покупки / просмотры листинга |
| Retention авторов | 80% | Активные продавцы month-over-month |
| GMV маркетплейса | 100K₽/месяц | Сумма всех покупок |

### Дашборд

```
┌─────────────────────────────────────────────────────────────────┐
│  АНАЛИТИКА КОНФИГОВ                              Декабрь 2025  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  АКТИВНОСТЬ                                                    │
│  ───────────                                                   │
│  Всего конфигов: 1,234                                         │
│  Публичных: 156 (12%)                                          │
│  Взаимных доступов: 892                                        │
│  Ревизий за месяц: 3,456                                       │
│                                                                 │
│  МАРКЕТПЛЕЙС                                                   │
│  ────────────                                                  │
│  Листингов: 89                                                 │
│  Продаж за месяц: 234                                          │
│  GMV: 87,500₽                                                  │
│  Комиссия: 26,250₽                                             │
│                                                                 │
│  ТОП АВТОРЫ                                                    │
│  ──────────                                                    │
│  1. @service_guru — 45 продаж, 22,500₽                         │
│  2. @iphone_expert — 38 продаж, 19,000₽                        │
│  3. @price_tracker — 156 подписчиков, 15,600₽                  │
│                                                                 │
│  ВЛИЯНИЕ НА ПОДДЕРЖКУ                                          │
│  ─────────────────────                                         │
│  Тикетов "как настроить": 23 (-67% vs прошлый месяц)           │
│  Среднее время онбординга: 12 мин (-45%)                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Итоги

### Ключевые принципы

1. **Версионирование** — каждое изменение сохраняется, можно откатить
2. **Взаимность** — хочешь видеть чужое = открой своё
3. **Cooldown** — защита от злоупотреблений (7 дней)
4. **Монетизация** — эксперты зарабатывают, платформа получает комиссию
5. **Сообщество** — пользователи помогают друг другу настройками

### Бизнес-эффект

```
БЕЗ СИСТЕМЫ КОНФИГОВ          С СИСТЕМОЙ КОНФИГОВ
───────────────────           ─────────────────────

Поддержка: 50 ч/мес           Поддержка: 5 ч/мес
Онбординг: 30 мин             Онбординг: 5 мин
Доп. доход: 0                 Доп. доход: 30K₽/мес (комиссия)
Sticky: низкий                Sticky: высокий (мои конфиги тут)
Network effect: нет           Network effect: да
```

---

**Документ:** 05_CONFIG_SYSTEM.md
**Версия:** 1.0
**Создан:** 2025-12-10 11:15 UTC
**Автор:** Dmitry + Claude
**Проект:** Eldoleado
