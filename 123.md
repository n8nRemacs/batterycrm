# Eldoleado — Avito Channel Implementation Report

**Дата:** 2025-12-24
**Сессия:** Avito WebSocket через Android WebView + sender_name

---

## 1. Что было сделано

### 1.1 Android — AvitoSetupActivity

Создана Activity для авторизации в Avito через WebView:

**Файл:** `app/src/main/java/com/eldoleado/app/channels/setup/AvitoSetupActivity.kt`

**Принцип работы:**
1. Пользователь открывает WebView с `https://m.avito.ru/login`
2. Вводит логин/пароль в форму Avito
3. После успешного входа извлекаем `sessid` из cookies
4. Отправляем sessid на сервер через n8n webhook
5. Показываем экран успеха

**Ключевые методы:**
- `checkAndExtractSessid()` — извлечение sessid из cookies
- `verifySessid()` — проверка через `/api/1/profile/short`
- `sendToServer()` — отправка на n8n webhook

---

### 1.2 n8n Workflows

Созданы 4 workflow для Avito:

| Файл | Назначение | Endpoint/Trigger |
|------|------------|------------------|
| `ELO_API_Channel_Avito_Auth.json` | Сохранение sessid | POST `/android/channels/avito/auth` |
| `ELO_In_Avito_User.json` | Приём сообщений | POST `/avito/incoming` |
| `ELO_Out_Avito_User.json` | Отправка сообщений | Schedule 5s + Redis queue |
| `n8n_avito_session_refresh.json` | Рефреш сессий | Daily 10:00 |

**Расположение:** `NEW/workflows/Channel Contour/`

---

### 1.3 avito-listener — Python WebSocket Service

Создан Python сервис для real-time получения сообщений через WebSocket:

**Расположение:** `NEW/services/avito-listener/`

**Файлы:**
- `avito_ws_listener.py` — основной сервис
- `requirements.txt` — зависимости
- `.env.example` — шаблон конфигурации

**Что делает:**
1. Подключается к PostgreSQL, получает список активных Avito аккаунтов
2. Для каждого аккаунта открывает WebSocket к `socket.avito.ru`
3. Слушает события `type: "Message"` (новые сообщения)
4. Форвардит на n8n webhook `/avito/incoming`

**WebSocket URL формат:**
```
wss://socket.avito.ru/?use_seq=true&seq={seq}&id_version=v2&my_hash_id={hash}&app_name=web&app_version=7.456.1
```

**Формат входящего сообщения:**
```json
{
  "seq": "7728",
  "type": "Message",
  "type_v2": "messenger.Message",
  "value": {
    "id": "2e1a5822184cb34901c5313bb3dab19e",
    "channelId": "u2i-PJIRB81Ps9iX81CSTNUgPw",
    "fromUid": "b5b928d9b300d15526cf829b93962213",
    "body": { "text": "12345" },
    "type": "text",
    "created": 17665157548977498
  }
}
```

---

### 1.4 Android APK

Собран debug APK:

**Путь:** `app/build/outputs/apk/debug/app-debug.apk`

**Команда сборки:**
```bash
export JAVA_HOME="/c/Program Files/Android/Android Studio/jbr"
./gradlew.bat :app:assembleDebug
```

---

## 2. Серверы и доступы

### 2.1 Messenger Server (155.212.221.189 / 217.114.14.17)

**SSH:**
```bash
ssh root@155.212.221.189
# Пароль: Mi31415926pSss!
```

**Сервисы:**

| Сервис | Порт | Статус | Описание |
|--------|------|--------|----------|
| mcp-telegram | 8767 | ✅ | Telegram Bot API |
| mcp-whatsapp | 8766 | ✅ | WhatsApp Baileys |
| mcp-avito | 8765 | ✅ | Avito Messenger API |
| mcp-avito-official | 8790 | ✅ | Avito Official API |
| mcp-vk | 8767 | ✅ | VK Community API |
| mcp-max | 8768 | ✅ | MAX Bot API |
| redis | 6379 | ✅ | MCP cache |

---

### 2.2 n8n Server (185.221.214.83)

**SSH:**
```bash
ssh root@185.221.214.83
# Пароль: Mi31415926pS
```

**Сервисы:**

| Сервис | Порт | Описание |
|--------|------|----------|
| n8n | 5678 | https://n8n.n8nsrv.ru |
| PostgreSQL | 6544 | Основная БД |
| Redis | 6379 | n8n cache |

**PostgreSQL доступ:**
```bash
# Локально (через docker):
ssh root@185.221.214.83 "docker exec supabase-db psql -U supabase_admin -c 'SELECT 1'"

# Удалённо (с других серверов):
postgresql://postgres:eldoleado@185.221.214.83:6544/postgres
```

**Таблицы ELO:**
- `elo_t_channel_accounts` — аккаунты каналов
- `elo_t_events` — события
- `elo_t_dialogs` — диалоги

---

## 3. Архитектура Avito Channel

```
┌─────────────────────────────────────────────────────────────────────┐
│                         AVITO CHANNEL                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐                                               │
│  │  Android App     │                                               │
│  │  WebView Login   │                                               │
│  │  → Extract sessid│                                               │
│  └────────┬─────────┘                                               │
│           │                                                         │
│           │ POST /android/channels/avito/auth                       │
│           ▼                                                         │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │               n8n (185.221.214.83)                             │ │
│  │  ELO_API_Channel_Avito_Auth → elo_t_channel_accounts           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│           │                                                         │
│           │ avito-listener читает из PostgreSQL                     │
│           ▼                                                         │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │          avito-listener (155.212.221.189:8775)                 │ │
│  │  WebSocket → wss://socket.avito.ru/                            │ │
│  │  Слушает type="Message" события                                │ │
│  └────────┬───────────────────────────────────────────────────────┘ │
│           │                                                         │
│           │ POST /avito/incoming                                    │
│           ▼                                                         │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │               n8n Workflows                                    │ │
│  │  ELO_In_Avito_User  → queue:incoming:universal                 │ │
│  │  ELO_Out_Avito_User ← queue:outgoing:avito                     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Сессия 2025-12-24: Android WebView WebSocket

### Проблема
Python avito-listener на сервере блокируется QRATOR (Avito anti-bot). Нужен мобильный IP для TLS fingerprint.

### Решение
Перенесли WebSocket подключение в Android WebView:
- WebSocket создаётся через JavaScript в WebView
- Используется мобильный IP телефона (не VPN!)
- QRATOR пропускает мобильные устройства

### Ключевой файл
`app/src/main/java/com/eldoleado/app/channels/avito/AvitoWebViewClient.kt`

**Новые методы:**
- `fetchContactName(channelId)` — получает имя контакта через `getChannels` API
- `channelNameCache` — кэш имён для избежания повторных запросов
- JavaScript injection для WebSocket → форвард в n8n webhook

### Формат webhook payload (работает!)
```json
{
  "channel_account_id": "default",
  "tenant_id": "11111111-1111-1111-1111-111111111111",
  "channel_type": "avito",
  "external_chat_id": "u2i-PJIRB81Ps9iX81CSTNUgPw",
  "external_message_id": "be83190f7db4b85b8b53dc281f91eb96",
  "message_type": "text",
  "message_text": "Здравствуйте",
  "sender_id": "b5b928d9b300d15526cf829b93962213",
  "sender_name": "Дмитрий",
  "source": "android_webview"
}
```

### Важно!
- **VPN ОТКЛЮЧИТЬ** — QRATOR блокирует VPN трафик
- `sender_id` — уникальный хэш пользователя (для БД lookup)
- `sender_name` — имя для отображения (может повторяться)

---

## TODO: n8n доработки (ВЫПОЛНЕНО 2025-12-24)

### 1. ELO_In_Avito_User → Normalize Message
```javascript
// Добавлено:
external_user_id: body.sender_id || msg.fromUid,
client_name: body.sender_name || rawMsg.userName || null,
```

### 2. ELO_Client_Resolve → Validate Input
```javascript
// Убрали 'text' из required (может быть пустым для медиа)
const required = ['channel', 'external_chat_id'];

// Исправили credential для avito
case 'avito': credential = input.profile_id || input.user_id || input.meta?.raw?.userId; break;

// Добавили fallback
if (!credential) credential = 'default';
```

### 3. ELO_Client_Resolve → Prepare Client Cache Key
```javascript
const clientExternalId = data.external_user_id || data.external_chat_id;
return { ...data, client_cache_key, client_external_id: clientExternalId };
```

### 4. ELO_Client_Resolve → DB queries
- Используют `client_external_id` вместо `external_chat_id`

---

## 4. Что нужно сделать дальше

### 4.1 Тестирование Avito

- [ ] Установить APK на телефон
- [ ] Войти в Avito через WebView
- [ ] Проверить что sessid сохранился в PostgreSQL:
  ```sql
  SELECT * FROM elo_t_channel_accounts WHERE channel_id = 3;
  ```
- [ ] Проверить что avito-listener подхватил аккаунт:
  ```bash
  curl http://155.212.221.189:8775/health
  ```
- [ ] Отправить тестовое сообщение с другого Avito аккаунта
- [ ] Проверить что сообщение пришло в n8n

### 4.2 Другие каналы (из Start.md)

- [ ] **MAX** — QR авторизация (User API opcode 20)
- [ ] **Telegram Bot** — ввод токена от @BotFather
- [ ] **Telegram User** — SMS авторизация (требует api_id/api_hash)

### 4.3 Доработки

- [ ] Добавить алерты при истечении сессии (Telegram уведомления)
- [ ] Добавить обработку медиа-сообщений (изображения, голос, видео)
- [ ] Тесты для avito-listener

---

## 5. Полезные команды

### Проверка всех сервисов

```bash
# MessagerOne (155.212.221.189)
ssh root@155.212.221.189 "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"

# avito-listener
curl http://155.212.221.189:8775/health

# Перезагрузить аккаунты в avito-listener
curl -X POST http://155.212.221.189:8775/reload
```

### Логи

```bash
# avito-listener
ssh root@155.212.221.189 "journalctl -u avito-listener -n 50"

# WhatsApp
ssh root@155.212.221.189 "docker logs mcp-whatsapp-arceos --tail 50"

# n8n workflows
# Смотреть в UI: https://n8n.n8nsrv.ru
```

### PostgreSQL

```bash
# Проверить Avito аккаунты
ssh root@185.221.214.83 "docker exec supabase-db psql -U supabase_admin -c \"SELECT id, tenant_id, session_status, credentials->>'sessid' as sessid FROM elo_t_channel_accounts WHERE channel_id = 3;\""

# Все elo_ таблицы
ssh root@185.221.214.83 "docker exec supabase-db psql -U supabase_admin -c \"SELECT tablename FROM pg_tables WHERE tablename LIKE 'elo_%';\""
```

### Android сборка

```bash
cd C:/Users/User/Eldoleado
export JAVA_HOME="/c/Program Files/Android/Android Studio/jbr"
./gradlew.bat :app:assembleDebug
# APK: app/build/outputs/apk/debug/app-debug.apk
```

---

## 6. Файловая структура проекта

```
Eldoleado/
├── app/                              # Android приложение
│   └── src/main/java/.../channels/
│       ├── setup/
│       │   ├── AvitoSetupActivity.kt    # ✅ WebView авторизация Avito
│       │   ├── WhatsAppSetupActivity.kt
│       │   ├── TelegramSetupActivity.kt
│       │   └── MaxSetupActivity.kt
│       ├── ChannelCredentialsManager.kt
│       └── ChannelMonitorService.kt
│
├── NEW/
│   ├── services/
│   │   └── avito-listener/              # ✅ Python WebSocket сервис
│   │       ├── avito_ws_listener.py
│   │       ├── requirements.txt
│   │       └── .env.example
│   │
│   └── workflows/
│       └── Channel Contour/
│           ├── ELO_API_Channel_Avito_Auth.json    # ✅ Auth webhook
│           ├── n8n_avito_session_refresh.json     # ✅ Session refresh
│           ├── ELO_In/
│           │   └── ELO_In_Avito_User.json         # ✅ Incoming webhook
│           └── ELO_Out/
│               └── ELO_Out_Avito_User.json        # ✅ Outgoing sender
│
├── MCP/
│   └── mcp-ssh/
│       └── servers.json                 # SSH credentials
│
├── CLAUDE.md                            # Основной контекст
├── Start.md                             # План на сессию
├── Stop.md                              # Итоги сессии
└── 123.md                               # Этот файл
```

---

## 7. Пароли и credentials

| Сервер | IP | User | Password |
|--------|-----|------|----------|
| Messenger | 155.212.221.189 | root | Mi31415926pSss! |
| n8n | 185.221.214.83 | root | Mi31415926pS |

| База данных | Host | Port | User | Password |
|-------------|------|------|------|----------|
| PostgreSQL | 185.221.214.83 | 6544 | postgres | eldoleado |
| PostgreSQL | 185.221.214.83 | 6544 | supabase_admin | (trust auth local) |

---

## 8. Итоги сессии

### 2025-12-23:
1. ✅ AvitoSetupActivity — WebView авторизация с извлечением sessid
2. ✅ 4 n8n workflows для Avito (auth, in, out, refresh)
3. ✅ avito-listener — Python сервис с WebSocket real-time
4. ✅ Развёрнут avito-listener на 155.212.221.189:8775

### 2025-12-24:
1. ✅ **AvitoWebViewClient** — WebSocket через Android WebView (обход QRATOR)
2. ✅ **sender_name** — получение имени контакта через getChannels API
3. ✅ **channelNameCache** — кэширование имён
4. ✅ **WakeLock** — предотвращение disconnect при sleep телефона
5. ✅ Полный цикл работает: WebSocket → Android → n8n webhook
6. ✅ n8n: Normalize Message → добавлен external_user_id, client_name
7. ✅ n8n: Validate Input → убран text из required, исправлен credential
8. ✅ n8n: ELO_Client_Resolve → client_external_id для поиска клиента

### Осталось:
1. ⏳ Реализовать другие каналы (MAX, Telegram)
2. ⏳ Тестирование стабильности WakeLock

---

*Последнее обновление: 2025-12-24 16:15 MSK*
