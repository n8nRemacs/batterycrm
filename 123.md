# Eldoleado — Session Report 2025-12-25

## Обзор сессии

Исследование Avito Official API и mcp-avito-camoufox. Выяснено что webhook требует платную подписку.

---

## 1. Avito Official API — Результаты

### Credentials
```
Client_id: MS0TjX2bwNcLapoX7YCc
Client_secret: QrhNXcvAzZexWOaFE99kMiRPDSE1hTZwkUYX4RFN
User ID: 157920214 (РемАкс)
```

### Что бесплатно

| Endpoint | Статус |
|----------|--------|
| `POST /token` | ✅ OAuth токен |
| `GET /core/v1/accounts/self` | ✅ Профиль |
| `GET /messenger/v2/.../chats` | ✅ Список чатов + last_message |
| `POST /messenger/v3/webhook` | ✅ Создать подписку |
| `POST /messenger/v1/subscriptions` | ✅ Список подписок |

### Что платно (402)

| Endpoint | Ошибка |
|----------|--------|
| `GET /messenger/v3/.../messages` | 402 "Нужна подписка" |
| `POST /messenger/v1/.../messages` | 402 "Нужна подписка" |
| **Webhook от Avito** | Не приходит |

### Вывод

Webhook подписка **создаётся** бесплатно, но Avito **не отправляет** webhooks без платной подписки.

---

## 2. Решение — Polling

Вместо webhook используем polling:

```
Каждые 15 секунд:
  GET /chats?unread_only=true
    ↓
  Сравнить с предыдущим
    ↓
  Новые → Redis Queue
```

### Workflow

Создан файл для импорта в n8n:
```
NEW/MVP/MCP/mcp-avito-camoufox/n8n-avito-polling.json
```

---

## 3. mcp-avito-camoufox

### Что работает

| Функция | Статус |
|---------|--------|
| Логин (телефон + пароль) | ✅ |
| SMS авторизация | ✅ |
| Сохранение сессии | ✅ |
| Список чатов (DOM) | ✅ |
| IP: 217.114.14.17 (SNAT) | ✅ |

### Что не работает

| Функция | Проблема |
|---------|----------|
| WebSocket | Avito закрывает соединение |
| Internal API | 403 "Неизвестный ключ" |
| Отправка сообщений | Использует internal API → 403 |

### Нужно доработать

Отправка сообщений через browser automation:
1. Навигация на чат по chat_id
2. Ввод текста в input
3. Клик на кнопку отправки

---

## 4. Инфраструктура

| Сервер | IP | Сервисы |
|--------|-----|---------|
| **Messenger** | 155.212.221.189 | mcp-avito-camoufox :8793 |
| **n8n** | 185.221.214.83 | n8n, PostgreSQL, Redis |

### iptables для Avito

```bash
iptables -t nat -I POSTROUTING 1 -s 172.20.0.2 -j SNAT --to-source 217.114.14.17
```

---

## 5. Гибридный подход

```
┌─────────────────────────────────────────────┐
│  Official API (бесплатно)                   │
│  GET /chats каждые 15 сек                   │
│  → Получаем chat_id + last_message          │
└─────────────────┬───────────────────────────┘
                  ↓
┌─────────────────────────────────────────────┐
│  Camoufox (browser)                         │
│  → Открыть чат                              │
│  → Отправить ответ через UI                 │
└─────────────────────────────────────────────┘
```

---

## 6. Файлы

```
NEW/MVP/MCP/mcp-avito-camoufox/
├── AVITO_RESEARCH.md          # Полная документация
├── n8n-avito-polling.json     # Workflow для импорта
├── server.py                  # REST API :8793
├── avito_channel.py           # Browser automation
├── session_manager.py         # Сессии
└── docker-compose.yml
```

---

## 7. Следующие шаги

1. [ ] Импортировать n8n-avito-polling.json в n8n
2. [ ] Реализовать отправку через browser automation
3. [ ] Тестировать polling → обработка → ответ

---

*Последнее обновление: 2025-12-25*
