# Eldoleado — Session Report 2025-12-25

## Обзор сессии

Сессия посвящена созданию серверного решения для мессенджеров (Avito, WhatsApp, MAX) с обходом антибот-защиты.

---

## 1. Проблема

QRATOR (антибот Avito) блокирует подключения если:
1. TLS fingerprint не соответствует браузеру
2. Неправильные cookies/headers
3. Подозрительная последовательность запросов

**Ключевой инсайт:** Люди используют Avito из офисов — проблема НЕ в IP, а в TLS fingerprint.

---

## 2. Решение: Browser Service

Headless Chromium как микросервис с изоляцией по тенантам.

### Архитектура

```
Browser Service :8792 (на сервере 155.212.221.189)
│
├── Chromium (headless, 1 instance)
│   │
│   ├── Tenant "remaks" (BrowserContext 1)
│   │   ├── Fingerprint: Chrome/120, 1920x1080, Moscow
│   │   ├── Avito Page → WebSocket listener
│   │   ├── WhatsApp Page → QR login
│   │   └── Session: /data/remaks/session.json
│   │
│   ├── Tenant "autoservice" (BrowserContext 2)
│   │   ├── Fingerprint: Chrome/122, 1366x768, Samara
│   │   └── Avito Page
│   │
│   └── ... до 100 тенантов
│
└── REST API
    ├── POST /session/{tenant}/create
    ├── POST /session/{tenant}/channel/{ch}/open
    ├── GET /session/{tenant}/channel/{ch}/chats
    └── POST /session/{tenant}/channel/{ch}/send
```

### Изоляция fingerprint

Каждый тенант получает уникальный (но детерминистичный) fingerprint:

```python
# fingerprint.py
def generate_fingerprint(tenant_id: str):
    seed = hash(tenant_id)  # Детерминистично
    return {
        "user_agent": f"Chrome/{random_version}",
        "viewport": random_resolution,
        "timezone_id": random_timezone,
        "locale": "ru-RU",
    }
```

### Ресурсы

| Тенантов | RAM |
|----------|-----|
| 1-10 | ~500MB |
| 10-50 | ~2GB |
| 50-100 | ~4GB |

---

## 3. Созданные папки

### mcp-Browser-Service/ (главное)

```
mcp-Browser-Service/
├── server.py           # FastAPI :8792
├── browser_manager.py  # Управление контекстами
├── fingerprint.py      # Генерация fingerprints
├── channels.py         # Avito, WhatsApp, MAX handlers
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
└── README.md
```

### mcp-Avito-Server-Mix/

curl_cffi подход (альтернатива):

```
mcp-Avito-Server-Mix/
├── avito_browser.py    # HTTP с Chrome TLS fingerprint
├── avito_ws.py         # WebSocket
├── cookie_extractor.py # Playwright для cookies
└── config.json
```

### Другие Avito папки

| Папка | Подход |
|-------|--------|
| `mcp-avito-user/` | Реверсный API (старый) |
| `Avito-Official-Api/` | Официальный API |
| `MCP-Avito-Mix/` | Mix Official + Reverse |

---

## 4. Инфраструктура

### Серверы

| Сервер | IP | Сервисы |
|--------|-----|---------|
| **Messenger** | 155.212.221.189 (alt: 217.114.14.17) | Все MCP, Redis |
| **n8n** | 185.221.214.83 | n8n, PostgreSQL, Redis |

### SSH

```bash
ssh root@155.212.221.189  # Mi31415926pSss!
ssh root@185.221.214.83   # Mi31415926pS
```

---

## 5. API Browser Service

### Создать сессию

```bash
POST /session/{tenant_id}/create
```

### Открыть канал

```bash
POST /session/{tenant_id}/channel/{channel}/open
# channel: avito, whatsapp, max
```

### Логин

```bash
# Для Avito — ввод логин/пароль в headless браузере
POST /session/{tenant_id}/channel/avito/login

# Для WhatsApp/MAX — получить QR
GET /session/{tenant_id}/channel/whatsapp/qr
```

### Чаты и сообщения

```bash
GET /session/{tenant_id}/channel/{channel}/chats
GET /session/{tenant_id}/channel/{channel}/messages/{chat_id}
POST /session/{tenant_id}/channel/{channel}/send
  {"chat_id": "...", "text": "..."}
```

---

## 6. Деплой

```bash
# На сервере 155.212.221.189
mkdir -p /opt/mcp-browser-service
cd /opt/mcp-browser-service

# Скопировать файлы или git pull
docker-compose up -d

# Проверка
curl http://localhost:8792/health
```

---

## 7. Следующие шаги

1. **Деплой Browser Service** на 155.212.221.189
2. **Тест Avito** — проверить что QRATOR не блокирует
3. **Интеграция с n8n** — webhook для входящих сообщений
4. **Добавить WhatsApp/MAX** — QR авторизация

---

## 8. Итоги

| Что | Статус |
|-----|--------|
| Очистка старых IP | ✅ |
| Browser Service | ✅ Создан |
| mcp-Avito-Server-Mix | ✅ Создан |
| Avito Official API | ✅ Создан |
| Документация | ✅ |

---

*Последнее обновление: 2025-12-25*
