# Eldoleado — Session Report 2025-12-26

## Telegram Bot Integration — Проблемы и Решения

---

## Текущий статус

Telegram Bot (@remacsbot) подключен через Android приложение, MCP сервер работает и пересылает сообщения в n8n. Однако обработка сообщений не завершается из-за проблем в workflow.

---

## Проблема 1: Неактивный Tenant Resolver

### Описание
`ELO_In_Telegram_Bot` вызывает workflow `BAT_Tenant_Resolver` (ID: `rRO6sxLqiCdgvLZz`), но этот workflow **неактивен**.

### Симптомы
- Сообщения доходят до n8n (200 OK)
- Дальнейшая обработка не происходит
- Redis кеш для tenant не заполняется

### Варианты решения

**Вариант A: Активировать BAT_Tenant_Resolver**
1. Открыть https://n8n.n8nsrv.ru
2. Найти workflow `BAT_Tenant_Resolver`
3. Активировать (toggle в правом верхнем углу)

**Вариант B: Изменить ELO_In_Telegram_Bot**
1. Открыть `ELO_In_Telegram_Bot`
2. Найти ноду "Execute Tenant Resolver"
3. Изменить вызываемый workflow на `ELO_Client_Resolve` (ID: `OHjjTQDguN2G6xin`)
4. Сохранить

**Рекомендация:** Вариант B предпочтительнее, т.к. `ELO_Client_Resolve` — актуальный resolver.

---

## Проблема 2: Отсутствие channel_id в кеше

### Описание
Redis кеш tenant содержит неполные данные — отсутствует `channel_id`.

### Пример проблемного кеша
```json
{"tenant_id":"11111111-...","channel_account_id":"bf70bea8-..."}
```

### Ожидаемый формат
```json
{"tenant_id":"11111111-...","channel_account_id":"bf70bea8-...","channel_id":1,"domain_id":null}
```

### Решение
Кеш очищен:
```bash
docker exec n8n-redis redis-cli DEL "cache:tenant:telegram:6939426823:AAEEvJCRUvZh5F_ihH1AzJTbiWntARqseIY"
```

---

## Проблема 3: WhatsApp маппинг credential

### Описание
`Validate Input` в `ELO_Client_Resolve` ищет credential для WhatsApp так:
```javascript
case 'whatsapp': credential = input.profile_id || input.meta?.raw?.sessionId; break;
```

Но `ELO_In_WhatsApp` передаёт `session_id` напрямую.

### Решение
Добавить `input.session_id` в маппинг:
```javascript
case 'whatsapp': credential = input.session_id || input.profile_id || input.meta?.raw?.sessionId; break;
```

---

## Исправления сделанные в этой сессии

1. **MCP webhook URL** — исправлен с `telegram-incoming` на `telegram-in`
2. **Android TelegramSetupActivity** — добавлена регистрация бота в MCP
3. **ChannelRegistrationService** — исправлено поле `token` → `bot_token`
4. **HTTPS Gateway** — настроен nginx + Let's Encrypt на msg.eldoleado.ru
5. **Документация** — создан `NEW/DOCS/NEW_Channel_Add.md`

---

## Инфраструктура

| Компонент | Статус | Детали |
|-----------|--------|--------|
| MCP Telegram Server | ✅ | http://155.212.221.189:8761 |
| HTTPS Gateway | ✅ | https://msg.eldoleado.ru/telegram/ |
| Bot Webhook | ✅ | @remacsbot зарегистрирован |
| MCP → n8n | ✅ | POST telegram-in = 200 |
| ELO_In_Telegram_Bot | ✅ | Active |
| ELO_Client_Resolve | ✅ | Active |
| BAT_Tenant_Resolver | ❌ | Inactive — **нужно исправить!** |

---

## Данные в БД

```sql
-- Channel Account Telegram
session_id: 6939426823:AAEEvJCRUvZh5F_ihH1AzJTbiWntARqseIY
channel_id: 1 (telegram)

-- Channels справочник
1 | telegram | Telegram
2 | whatsapp | WhatsApp
3 | avito    | Avito
```

---

## Следующие шаги

1. [ ] **Активировать resolver** — вариант A или B
2. [ ] Тест сообщение @remacsbot
3. [ ] Проверить кеш с channel_id
4. [ ] Проверить WhatsApp

---

## Полезные команды

```bash
# Логи MCP Telegram
ssh root@155.212.221.189 "docker logs telegram-bot-api --tail 50"

# Redis кеш
ssh root@185.221.214.83 "docker exec n8n-redis redis-cli KEYS 'cache:tenant:*'"

# Перерегистрировать бота
curl -X POST "http://155.212.221.189:8761/setup?base_url=https://msg.eldoleado.ru/telegram" \
  -H "X-API-Key: eldoleado_mcp_2024" \
  -H "Content-Type: application/json" \
  -d '{"token": "BOT_TOKEN"}'
```

---

*Последнее обновление: 2025-12-26*
