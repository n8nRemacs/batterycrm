{
  "name": "ELO_API_Android_Register_Channel",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "android/channels/register",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "android-register-channel"
    },
    {
      "parameters": {
        "jsCode": "// Validate input and extract session token\nconst headers = $input.first().json.headers;\nconst body = $input.first().json.body;\n\n// Get session token from header\nconst sessionToken = headers['x-session-token'] || headers['X-Session-Token'];\n\nif (!sessionToken) {\n  throw new Error('Missing X-Session-Token header');\n}\n\n// Validate required fields\nconst required = ['channel', 'session_id', 'account_id'];\nfor (const field of required) {\n  if (!body[field]) {\n    throw new Error(`Missing required field: ${field}`);\n  }\n}\n\n// Map channel name to channel_id\nconst channelMap = {\n  'telegram': 1,\n  'whatsapp': 2,\n  'avito': 3,\n  'vk': 4,\n  'max': 5,\n  'form': 6,\n  'phone': 7\n};\n\nconst channelId = channelMap[body.channel.toLowerCase()];\nif (!channelId) {\n  throw new Error(`Unknown channel: ${body.channel}`);\n}\n\nreturn {\n  session_token: sessionToken,\n  channel: body.channel.toLowerCase(),\n  channel_id: channelId,\n  session_id: body.session_id,\n  account_id: body.account_id,\n  account_name: body.account_name || null,\n  credentials: body.credentials || {},\n  is_official: body.is_official || false\n};"
      },
      "id": "validate-001",
      "name": "Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  od.operator_id,\n  od.tenant_id,\n  o.name as operator_name\nFROM elo_t_operator_devices od\nJOIN elo_t_operators o ON o.id = od.operator_id\nWHERE od.session_token = '{{ $json.session_token }}'\n  AND od.is_active = true\nLIMIT 1;",
        "options": {}
      },
      "id": "get-operator-001",
      "name": "Get Operator by Token",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [440, 0],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "operator-found",
              "leftValue": "={{ $json.tenant_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-operator-001",
      "name": "Operator Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id,\n  tenant_id,\n  session_id,\n  session_status\nFROM elo_t_channel_accounts\nWHERE channel_id = {{ $('Validate Input').first().json.channel_id }}\n  AND account_id = '{{ $('Validate Input').first().json.account_id }}'\nLIMIT 1;",
        "options": {}
      },
      "id": "check-existing-001",
      "name": "Check Existing Channel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [880, -100],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Check ownership and decide action\nconst input = $('Validate Input').first().json;\nconst operator = $('Get Operator by Token').first().json;\nconst existing = $('Check Existing Channel').first().json;\n\nconst tenantId = operator.tenant_id;\nconst operatorId = operator.operator_id;\n\n// Check if channel already exists\nif (existing && existing.id) {\n  // Channel exists\n  if (existing.tenant_id === tenantId) {\n    // Same tenant - allow update\n    return {\n      action: 'update',\n      channel_account_id: existing.id,\n      tenant_id: tenantId,\n      operator_id: operatorId,\n      ...input\n    };\n  } else {\n    // Different tenant - REJECT\n    return {\n      action: 'reject',\n      error: 'CHANNEL_ALREADY_REGISTERED',\n      message: 'Этот канал уже зарегистрирован другой компанией'\n    };\n  }\n} else {\n  // New channel - allow insert\n  return {\n    action: 'insert',\n    tenant_id: tenantId,\n    operator_id: operatorId,\n    ...input\n  };\n}"
      },
      "id": "decide-action-001",
      "name": "Decide Action",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, -100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-reject",
              "leftValue": "={{ $json.action }}",
              "rightValue": "reject",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "switch-action-001",
      "name": "Is Rejected?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1320, -100]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: $json.error, message: $json.message }) }}",
        "options": {
          "responseCode": 409
        }
      },
      "id": "respond-reject-001",
      "name": "Respond Reject",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1540, -200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-insert",
              "leftValue": "={{ $json.action }}",
              "rightValue": "insert",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "switch-insert-update-001",
      "name": "Insert or Update?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1540, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elo_t_channel_accounts (\n  tenant_id,\n  channel_id,\n  account_id,\n  account_name,\n  session_id,\n  session_status,\n  credentials,\n  is_official,\n  is_active\n) VALUES (\n  '{{ $json.tenant_id }}',\n  {{ $json.channel_id }},\n  '{{ $json.account_id }}',\n  {{ $json.account_name ? \"'\" + $json.account_name + \"'\" : 'NULL' }},\n  '{{ $json.session_id }}',\n  'connected',\n  '{{ JSON.stringify($json.credentials) }}'::jsonb,\n  {{ $json.is_official }},\n  true\n)\nRETURNING id, tenant_id, channel_id, session_id;",
        "options": {}
      },
      "id": "insert-channel-001",
      "name": "Insert Channel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1760, -100],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE elo_t_channel_accounts SET\n  session_id = '{{ $json.session_id }}',\n  session_status = 'connected',\n  account_name = {{ $json.account_name ? \"'\" + $json.account_name + \"'\" : 'account_name' }},\n  credentials = '{{ JSON.stringify($json.credentials) }}'::jsonb,\n  is_official = {{ $json.is_official }},\n  is_active = true,\n  updated_at = NOW()\nWHERE id = '{{ $json.channel_account_id }}'\nRETURNING id, tenant_id, channel_id, session_id;",
        "options": {}
      },
      "id": "update-channel-001",
      "name": "Update Channel",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1760, 100],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare cache data\nconst result = $input.first().json;\nconst input = $('Decide Action').first().json;\n\nconst cacheKey = `cache:tenant:${input.channel}:${input.session_id}`;\nconst cacheValue = JSON.stringify({\n  tenant_id: result.tenant_id,\n  channel_account_id: result.id\n});\n\nreturn {\n  cache_key: cacheKey,\n  cache_value: cacheValue,\n  channel_account_id: result.id,\n  tenant_id: result.tenant_id,\n  channel: input.channel,\n  session_id: input.session_id,\n  account_id: input.account_id\n};"
      },
      "id": "prepare-cache-001",
      "name": "Prepare Cache",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 0]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.cache_key }}",
        "value": "={{ $json.cache_value }}",
        "expire": true,
        "ttl": 86400,
        "options": {}
      },
      "id": "cache-tenant-001",
      "name": "Cache Tenant",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2200, 0],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, channel_account_id: $('Prepare Cache').first().json.channel_account_id, tenant_id: $('Prepare Cache').first().json.tenant_id }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-success-001",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2420, 0]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, error: 'UNAUTHORIZED', message: 'Invalid session token' }) }}",
        "options": {
          "responseCode": 401
        }
      },
      "id": "respond-unauthorized-001",
      "name": "Respond Unauthorized",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 100]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{ "node": "Validate Input", "type": "main", "index": 0 }]]
    },
    "Validate Input": {
      "main": [[{ "node": "Get Operator by Token", "type": "main", "index": 0 }]]
    },
    "Get Operator by Token": {
      "main": [[{ "node": "Operator Found?", "type": "main", "index": 0 }]]
    },
    "Operator Found?": {
      "main": [
        [{ "node": "Check Existing Channel", "type": "main", "index": 0 }],
        [{ "node": "Respond Unauthorized", "type": "main", "index": 0 }]
      ]
    },
    "Check Existing Channel": {
      "main": [[{ "node": "Decide Action", "type": "main", "index": 0 }]]
    },
    "Decide Action": {
      "main": [[{ "node": "Is Rejected?", "type": "main", "index": 0 }]]
    },
    "Is Rejected?": {
      "main": [
        [{ "node": "Respond Reject", "type": "main", "index": 0 }],
        [{ "node": "Insert or Update?", "type": "main", "index": 0 }]
      ]
    },
    "Insert or Update?": {
      "main": [
        [{ "node": "Insert Channel", "type": "main", "index": 0 }],
        [{ "node": "Update Channel", "type": "main", "index": 0 }]
      ]
    },
    "Insert Channel": {
      "main": [[{ "node": "Prepare Cache", "type": "main", "index": 0 }]]
    },
    "Update Channel": {
      "main": [[{ "node": "Prepare Cache", "type": "main", "index": 0 }]]
    },
    "Prepare Cache": {
      "main": [[{ "node": "Cache Tenant", "type": "main", "index": 0 }]]
    },
    "Cache Tenant": {
      "main": [[{ "node": "Respond Success", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    { "name": "API" },
    { "name": "Android" },
    { "name": "Channels" }
  ],
  "triggerCount": 1,
  "active": false
}
