{
  "updatedAt": "2025-12-29T05:28:47.860Z",
  "createdAt": "2025-12-18T10:23:46.134Z",
  "id": "FKTNL7yNqFGfRrv3",
  "name": "ELO_API_Android_Auth",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "v1/auth/login",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "dc18bf24-fa16-4fc0-9500-7129b919d050",
      "name": "Webhook - Auth Login",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1520,
        112
      ],
      "webhookId": "android-auth-login"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, tenant_id, name, email, phone, password_hash, is_active\nFROM elo_t_operators\nWHERE (email = '{{ $json.body.login }}' OR phone = '{{ $json.body.login }}')\nAND is_active = true\nLIMIT 1;",
        "options": {
          "queryBatching": "independently"
        }
      },
      "id": "d6f5550f-a325-4d1d-8e0e-eec17be7bd88",
      "name": "Postgres - Find Operator",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1296,
        112
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "operator-found",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "operator-active",
              "leftValue": "={{ $json.is_active }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a297de72-68b1-4d58-bfa1-5ef78a9a2401",
      "name": "IF - Operator Exists & Active",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1072,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "password-valid",
              "leftValue": "={{ $json.password_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "7fe2a14f-8f7b-43b8-bf1f-e3979f07e817",
      "name": "IF - Password Valid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -608,
        16
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"operator_id\": \"{{ $json.operator_id }}\",\n  \"tenant_id\": \"{{ $json.tenant_id }}\",\n  \"name\": \"{{ $json.name }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"session_token\": \"{{ $json.session_token }}\",\n  \"app_mode\": \"{{ $json.app_mode }}\",\n  \"tunnel_url\": {{ $json.tunnel_url ? '\"' + $json.tunnel_url + '\"' : 'null' }},\n  \"tunnel_secret\": {{ $json.tunnel_secret ? '\"' + $json.tunnel_secret + '\"' : 'null' }}\n}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "957f6ce9-e2ca-42f8-b8c0-16d8a1266c66",
      "name": "Response - Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        640,
        -96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"invalid_password\"\n}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "9879ba27-b19e-4c6f-8885-5c096fb0e579",
      "name": "Response - Invalid Password",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -384,
        112
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"operator_not_found_or_inactive\"\n}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "9e0aa641-86bd-47b8-8773-c7bc243ea7b7",
      "name": "Response - Not Found",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -864,
        208
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  '{{ $('Postgres - Find Operator').item.json.id }}' as operator_id,\n  '{{ $('Postgres - Find Operator').item.json.tenant_id }}' as tenant_id,\n  '{{ $('Postgres - Find Operator').item.json.name }}' as name,\n  '{{ $('Postgres - Find Operator').item.json.email }}' as email,\n  (password_hash = crypt('{{ $('Webhook - Auth Login').item.json.body.password }}', password_hash)) as password_valid\nFROM elo_t_operators\nWHERE id = '{{ $('Postgres - Find Operator').item.json.id }}'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -864,
        16
      ],
      "id": "00e1c7ec-4b7b-484c-818c-d35b1bd02468",
      "name": "Postgres - Verify Password",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const body = $('Webhook - Auth Login').first().json.body || {};\nconst operatorData = $input.first().json;\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\n// Get app_mode from request, default to 'client'\nconst appMode = body.app_mode || 'client';\n\nreturn {\n  ...operatorData,\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson,\n  app_mode: appMode\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        -96
      ],
      "id": "4a48cef5-5cae-4ea7-8201-8f49ce6ab4ae",
      "name": "Parse Device Info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM elo_t_operator_devices \nWHERE operator_id = '{{ $json.operator_id }}'::uuid\n  AND device_type = 'mobile'\n  AND tenant_id = '{{ $json.tenant_id }}'::uuid;\n\nSELECT \n  '{{ $json.operator_id }}' as operator_id,\n  '{{ $json.tenant_id }}' as tenant_id,\n  '{{ $json.name }}' as name,\n  '{{ $json.email }}' as email,\n  '{{ $json.device_id }}' as device_id,\n  '{{ $json.device_info_json }}' as device_info_json,\n  '{{ $json.app_mode }}' as app_mode;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -192,
        -96
      ],
      "id": "b863844e-e3c5-48e6-9496-82575e271c84",
      "name": "Delete Old Mobile Session",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first().json;\nconst crypto = require('crypto');\nconst sessionToken = crypto.randomUUID();\n\n// Generate tunnel secret for server/both modes\nlet tunnelSecret = null;\nif (inputData.app_mode === 'server' || inputData.app_mode === 'both') {\n  tunnelSecret = crypto.randomUUID().replace(/-/g, '');\n}\n\nreturn {\n  operator_id: inputData.operator_id,\n  tenant_id: inputData.tenant_id,\n  name: inputData.name,\n  email: inputData.email,\n  device_id: inputData.device_id,\n  device_info_json: inputData.device_info_json,\n  session_token: sessionToken,\n  app_mode: inputData.app_mode,\n  tunnel_secret: tunnelSecret\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        -96
      ],
      "id": "e37b2cad-b927-4aa1-ad3a-778f99bea013",
      "name": "Generate Session Token"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elo_t_operator_devices (\n  operator_id,\n  tenant_id,\n  device_type,\n  session_token,\n  device_id,\n  device_info,\n  app_mode,\n  tunnel_secret,\n  created_at,\n  last_active_at,\n  updated_at\n) VALUES (\n  '{{ $json.operator_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  'mobile',\n  '{{ $json.session_token }}',\n  {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"NULL\" }},\n  {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"'{}'::jsonb\" }},\n  '{{ $json.app_mode }}',\n  {{ $json.tunnel_secret ? \"'\" + $json.tunnel_secret + \"'\" : \"NULL\" }},\n  NOW(),\n  NOW(),\n  NOW()\n) RETURNING id, tunnel_url;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        224,
        -96
      ],
      "id": "76f9b0b7-b366-4908-8b9d-49e316d3798a",
      "name": "Insert into elo_t_operator_devices",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const operatorData = $('Parse Device Info').first().json;\nconst sessionData = $('Generate Session Token').first().json;\nconst insertResult = $input.first().json;\n\n// Get tunnel_url from tenant config or generate based on session\nlet tunnelUrl = null;\nif (sessionData.app_mode === 'server' || sessionData.app_mode === 'both') {\n  // Tunnel URL format: https://tunnel.eldoleado.ru/{session_token}\n  tunnelUrl = `https://tunnel.eldoleado.ru/${sessionData.session_token}`;\n}\n\nreturn {\n  operator_id: operatorData.operator_id,\n  tenant_id: operatorData.tenant_id,\n  name: operatorData.name,\n  email: operatorData.email,\n  session_token: sessionData.session_token,\n  app_mode: sessionData.app_mode,\n  tunnel_url: tunnelUrl,\n  tunnel_secret: sessionData.tunnel_secret\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        -96
      ],
      "id": "9b75623c-d0bc-4826-8272-25343e86905e",
      "name": "Prepare Response Data"
    }
  ],
  "connections": {
    "Webhook - Auth Login": {
      "main": [
        [
          {
            "node": "Postgres - Find Operator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Find Operator": {
      "main": [
        [
          {
            "node": "IF - Operator Exists & Active",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Operator Exists & Active": {
      "main": [
        [
          {
            "node": "Postgres - Verify Password",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response - Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Password Valid": {
      "main": [
        [
          {
            "node": "Parse Device Info",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response - Invalid Password",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Verify Password": {
      "main": [
        [
          {
            "node": "IF - Password Valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Device Info": {
      "main": [
        [
          {
            "node": "Delete Old Mobile Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old Mobile Session": {
      "main": [
        [
          {
            "node": "Generate Session Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Session Token": {
      "main": [
        [
          {
            "node": "Insert into elo_t_operator_devices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert into elo_t_operator_devices": {
      "main": [
        [
          {
            "node": "Prepare Response Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response Data": {
      "main": [
        [
          {
            "node": "Response - Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "f6452a9d-34c3-4135-8934-fd20197b8d21",
  "activeVersionId": "f6452a9d-34c3-4135-8934-fd20197b8d21",
  "versionCounter": 11,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-18T10:23:46.141Z",
      "createdAt": "2025-12-18T10:23:46.141Z",
      "role": "workflow:owner",
      "workflowId": "FKTNL7yNqFGfRrv3",
      "projectId": "x7frUSUEowDAk8Dt",
      "project": {
        "updatedAt": "2025-08-25T18:57:22.218Z",
        "createdAt": "2025-08-25T08:16:18.805Z",
        "id": "x7frUSUEowDAk8Dt",
        "name": "Dmitriy Remacs <dk@n8nsrv.ru>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-08-25T08:16:18.805Z",
            "createdAt": "2025-08-25T08:16:18.805Z",
            "userId": "1d5222a1-8f53-4940-b7de-93daeae04393",
            "projectId": "x7frUSUEowDAk8Dt",
            "user": {
              "updatedAt": "2025-12-31T08:56:11.000Z",
              "createdAt": "2025-08-25T08:16:17.784Z",
              "id": "1d5222a1-8f53-4940-b7de-93daeae04393",
              "email": "dk@n8nsrv.ru",
              "firstName": "Dmitriy",
              "lastName": "Remacs",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "RbSUhceYc7q41M5j",
                "userActivatedAt": 1756286438389
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-12-30",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-11-23T03:58:34.844Z",
      "createdAt": "2025-11-23T03:58:34.844Z",
      "id": "0yzk30hhaSzkl8bF",
      "name": "API"
    },
    {
      "updatedAt": "2025-12-09T18:50:08.518Z",
      "createdAt": "2025-12-09T18:50:08.518Z",
      "id": "tMSCjbvPU3xrNUqz",
      "name": "ELO"
    }
  ],
  "activeVersion": {
    "updatedAt": "2025-12-29T05:28:47.861Z",
    "createdAt": "2025-12-29T05:28:47.861Z",
    "versionId": "f6452a9d-34c3-4135-8934-fd20197b8d21",
    "workflowId": "FKTNL7yNqFGfRrv3",
    "nodes": [
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "v1/auth/login",
          "responseMode": "responseNode",
          "options": {
            "allowedOrigins": "*"
          }
        },
        "id": "dc18bf24-fa16-4fc0-9500-7129b919d050",
        "name": "Webhook - Auth Login",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -1520,
          112
        ],
        "webhookId": "android-auth-login"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "SELECT id, tenant_id, name, email, phone, password_hash, is_active\nFROM elo_t_operators\nWHERE (email = '{{ $json.body.login }}' OR phone = '{{ $json.body.login }}')\nAND is_active = true\nLIMIT 1;",
          "options": {
            "queryBatching": "independently"
          }
        },
        "id": "d6f5550f-a325-4d1d-8e0e-eec17be7bd88",
        "name": "Postgres - Find Operator",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.4,
        "position": [
          -1296,
          112
        ],
        "alwaysOutputData": true,
        "credentials": {
          "postgres": {
            "id": "n2SyhP9QhMnp1ryk",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "operator-found",
                "leftValue": "={{ $json.id }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              },
              {
                "id": "operator-active",
                "leftValue": "={{ $json.is_active }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "a297de72-68b1-4d58-bfa1-5ef78a9a2401",
        "name": "IF - Operator Exists & Active",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -1072,
          112
        ]
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "password-valid",
                "leftValue": "={{ $json.password_valid }}",
                "rightValue": true,
                "operator": {
                  "type": "boolean",
                  "operation": "equals"
                }
              }
            ]
          },
          "options": {}
        },
        "id": "7fe2a14f-8f7b-43b8-bf1f-e3979f07e817",
        "name": "IF - Password Valid",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          -608,
          16
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"success\": true,\n  \"operator_id\": \"{{ $json.operator_id }}\",\n  \"tenant_id\": \"{{ $json.tenant_id }}\",\n  \"name\": \"{{ $json.name }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"session_token\": \"{{ $json.session_token }}\",\n  \"app_mode\": \"{{ $json.app_mode }}\",\n  \"tunnel_url\": {{ $json.tunnel_url ? '\"' + $json.tunnel_url + '\"' : 'null' }},\n  \"tunnel_secret\": {{ $json.tunnel_secret ? '\"' + $json.tunnel_secret + '\"' : 'null' }}\n}",
          "options": {
            "responseCode": 200,
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/json"
                },
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                }
              ]
            }
          }
        },
        "id": "957f6ce9-e2ca-42f8-b8c0-16d8a1266c66",
        "name": "Response - Success",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          640,
          -96
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"success\": false,\n  \"error\": \"invalid_password\"\n}",
          "options": {
            "responseCode": 401,
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/json"
                },
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                }
              ]
            }
          }
        },
        "id": "9879ba27-b19e-4c6f-8885-5c096fb0e579",
        "name": "Response - Invalid Password",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          -384,
          112
        ]
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={\n  \"success\": false,\n  \"error\": \"operator_not_found_or_inactive\"\n}",
          "options": {
            "responseCode": 401,
            "responseHeaders": {
              "entries": [
                {
                  "name": "Content-Type",
                  "value": "application/json"
                },
                {
                  "name": "Access-Control-Allow-Origin",
                  "value": "*"
                }
              ]
            }
          }
        },
        "id": "9e0aa641-86bd-47b8-8773-c7bc243ea7b7",
        "name": "Response - Not Found",
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.1,
        "position": [
          -864,
          208
        ]
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "SELECT \n  '{{ $('Postgres - Find Operator').item.json.id }}' as operator_id,\n  '{{ $('Postgres - Find Operator').item.json.tenant_id }}' as tenant_id,\n  '{{ $('Postgres - Find Operator').item.json.name }}' as name,\n  '{{ $('Postgres - Find Operator').item.json.email }}' as email,\n  (password_hash = crypt('{{ $('Webhook - Auth Login').item.json.body.password }}', password_hash)) as password_valid\nFROM elo_t_operators\nWHERE id = '{{ $('Postgres - Find Operator').item.json.id }}'\nLIMIT 1;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -864,
          16
        ],
        "id": "00e1c7ec-4b7b-484c-818c-d35b1bd02468",
        "name": "Postgres - Verify Password",
        "credentials": {
          "postgres": {
            "id": "n2SyhP9QhMnp1ryk",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const body = $('Webhook - Auth Login').first().json.body || {};\nconst operatorData = $input.first().json;\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\n// Get app_mode from request, default to 'client'\nconst appMode = body.app_mode || 'client';\n\nreturn {\n  ...operatorData,\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson,\n  app_mode: appMode\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -400,
          -96
        ],
        "id": "4a48cef5-5cae-4ea7-8201-8f49ce6ab4ae",
        "name": "Parse Device Info"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "DELETE FROM elo_t_operator_devices \nWHERE operator_id = '{{ $json.operator_id }}'::uuid\n  AND device_type = 'mobile'\n  AND tenant_id = '{{ $json.tenant_id }}'::uuid;\n\nSELECT \n  '{{ $json.operator_id }}' as operator_id,\n  '{{ $json.tenant_id }}' as tenant_id,\n  '{{ $json.name }}' as name,\n  '{{ $json.email }}' as email,\n  '{{ $json.device_id }}' as device_id,\n  '{{ $json.device_info_json }}' as device_info_json,\n  '{{ $json.app_mode }}' as app_mode;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          -192,
          -96
        ],
        "id": "b863844e-e3c5-48e6-9496-82575e271c84",
        "name": "Delete Old Mobile Session",
        "credentials": {
          "postgres": {
            "id": "n2SyhP9QhMnp1ryk",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const inputData = $input.first().json;\nconst crypto = require('crypto');\nconst sessionToken = crypto.randomUUID();\n\n// Generate tunnel secret for server/both modes\nlet tunnelSecret = null;\nif (inputData.app_mode === 'server' || inputData.app_mode === 'both') {\n  tunnelSecret = crypto.randomUUID().replace(/-/g, '');\n}\n\nreturn {\n  operator_id: inputData.operator_id,\n  tenant_id: inputData.tenant_id,\n  name: inputData.name,\n  email: inputData.email,\n  device_id: inputData.device_id,\n  device_info_json: inputData.device_info_json,\n  session_token: sessionToken,\n  app_mode: inputData.app_mode,\n  tunnel_secret: tunnelSecret\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          16,
          -96
        ],
        "id": "e37b2cad-b927-4aa1-ad3a-778f99bea013",
        "name": "Generate Session Token"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "INSERT INTO elo_t_operator_devices (\n  operator_id,\n  tenant_id,\n  device_type,\n  session_token,\n  device_id,\n  device_info,\n  app_mode,\n  tunnel_secret,\n  created_at,\n  last_active_at,\n  updated_at\n) VALUES (\n  '{{ $json.operator_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  'mobile',\n  '{{ $json.session_token }}',\n  {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"NULL\" }},\n  {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"'{}'::jsonb\" }},\n  '{{ $json.app_mode }}',\n  {{ $json.tunnel_secret ? \"'\" + $json.tunnel_secret + \"'\" : \"NULL\" }},\n  NOW(),\n  NOW(),\n  NOW()\n) RETURNING id, tunnel_url;",
          "options": {}
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          224,
          -96
        ],
        "id": "76f9b0b7-b366-4908-8b9d-49e316d3798a",
        "name": "Insert into elo_t_operator_devices",
        "credentials": {
          "postgres": {
            "id": "n2SyhP9QhMnp1ryk",
            "name": "Postgres account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const operatorData = $('Parse Device Info').first().json;\nconst sessionData = $('Generate Session Token').first().json;\nconst insertResult = $input.first().json;\n\n// Get tunnel_url from tenant config or generate based on session\nlet tunnelUrl = null;\nif (sessionData.app_mode === 'server' || sessionData.app_mode === 'both') {\n  // Tunnel URL format: https://tunnel.eldoleado.ru/{session_token}\n  tunnelUrl = `https://tunnel.eldoleado.ru/${sessionData.session_token}`;\n}\n\nreturn {\n  operator_id: operatorData.operator_id,\n  tenant_id: operatorData.tenant_id,\n  name: operatorData.name,\n  email: operatorData.email,\n  session_token: sessionData.session_token,\n  app_mode: sessionData.app_mode,\n  tunnel_url: tunnelUrl,\n  tunnel_secret: sessionData.tunnel_secret\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          432,
          -96
        ],
        "id": "9b75623c-d0bc-4826-8272-25343e86905e",
        "name": "Prepare Response Data"
      }
    ],
    "connections": {
      "Webhook - Auth Login": {
        "main": [
          [
            {
              "node": "Postgres - Find Operator",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Postgres - Find Operator": {
        "main": [
          [
            {
              "node": "IF - Operator Exists & Active",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF - Operator Exists & Active": {
        "main": [
          [
            {
              "node": "Postgres - Verify Password",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Response - Not Found",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IF - Password Valid": {
        "main": [
          [
            {
              "node": "Parse Device Info",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Response - Invalid Password",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Postgres - Verify Password": {
        "main": [
          [
            {
              "node": "IF - Password Valid",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Device Info": {
        "main": [
          [
            {
              "node": "Delete Old Mobile Session",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Delete Old Mobile Session": {
        "main": [
          [
            {
              "node": "Generate Session Token",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Generate Session Token": {
        "main": [
          [
            {
              "node": "Insert into elo_t_operator_devices",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Insert into elo_t_operator_devices": {
        "main": [
          [
            {
              "node": "Prepare Response Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Prepare Response Data": {
        "main": [
          [
            {
              "node": "Response - Success",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Dmitriy Remacs",
    "name": null,
    "description": null
  }
}