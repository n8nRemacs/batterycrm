{
  "updatedAt": "2025-12-20T17:11:48.809Z",
  "createdAt": "2025-12-11T17:08:59.805Z",
  "id": "peUaEixC2W6l75s5",
  "name": "ELO_Input_Ingest",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "elo-input-ingest",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5fdb7a74-cf31-499c-b640-4392a46351a7",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1184,
        160
      ],
      "webhookId": "elo-input-ingest-001"
    },
    {
      "parameters": {
        "jsCode": "// Validate and normalize input\nconst input = $input.first().json;\nconst now = Date.now();\nconst rand = Math.random().toString(36).slice(2, 10);\n\n// Required fields validation\nconst errors = [];\nif (!input.channel) errors.push('channel is required');\nif (!input.external_chat_id && !input.external_user_id) {\n  errors.push('external_chat_id or external_user_id is required');\n}\n\nif (errors.length > 0) {\n  return [{\n    json: {\n      valid: false,\n      error: errors.join('; '),\n      received_at: new Date().toISOString()\n    }\n  }];\n}\n\n// Generate IDs if not provided\nconst message_id = input.message_id || `msg_${now}_${rand}`;\nconst trace_id = input.trace_id || `trace_${now}_${rand}`;\n\n// Normalize data\nreturn [{\n  json: {\n    valid: true,\n    // Core fields\n    channel: input.channel,\n    bot_token: input.bot_token || null,\n    external_user_id: input.external_user_id || input.external_chat_id,\n    external_chat_id: input.external_chat_id || input.external_user_id,\n    // Client info\n    client_name: input.client_name || null,\n    client_phone: input.client_phone || null,\n    // Message content\n    text: input.text || '',\n    media: input.media || {},\n    meta: input.meta || {},\n    // Timestamps and IDs\n    timestamp: input.timestamp || new Date().toISOString(),\n    received_at: new Date().toISOString(),\n    message_id: message_id,\n    trace_id: trace_id\n  }\n}];"
      },
      "id": "6efdf3ed-18f7-4587-af36-e8e51f37cf49",
      "name": "Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        160
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "valid-check",
              "leftValue": "={{$json.valid}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "06685e32-6657-468b-bd8e-28af5b83d2c1",
      "name": "If Valid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -752,
        160
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: false, error: $json.error, trace_id: $json.trace_id || null } }}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "047fb041-52c8-44d9-86a2-713de0661d11",
      "name": "Respond Invalid",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -528,
        48
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=dedup:{{$json.message_id}}",
        "options": {}
      },
      "id": "a1ac64a8-fbbe-41d2-9c78-25a1fc6ebeec",
      "name": "Check Duplicate",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -528,
        256
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Check if duplicate or Redis error\nconst result = $json;\nconst prevData = $('Validate Input').first().json;\n\n// Redis returned value = duplicate exists\nif (result.value) {\n  return [{ json: { ...prevData, is_duplicate: true } }];\n}\n\n// No value = not duplicate\nreturn [{ json: { ...prevData, is_duplicate: false } }];"
      },
      "id": "44aebfab-9281-475f-aa98-4f34c3d2af83",
      "name": "Check Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        256
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "dup-check",
              "leftValue": "={{$json.is_duplicate}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "a528d07b-5350-4aea-a8a7-fca69bd384c8",
      "name": "If Duplicate",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -96,
        256
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: true, duplicate: true, message_id: $json.message_id, trace_id: $json.trace_id } }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "2f9f14d3-1463-427e-b94e-a627ebc11925",
      "name": "Respond Duplicate",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        144,
        160
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=dedup:{{$json.message_id}}",
        "value": "1",
        "expire": true,
        "ttl": 86400
      },
      "id": "36237e25-d397-442d-8cda-1db023860748",
      "name": "Mark Processed",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        144,
        352
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "queue:incoming",
        "messageData": "={{ JSON.stringify($('Check Result').first().json) }}",
        "tail": true
      },
      "id": "ebe49292-2db3-4f64-84cf-66a28b8b367f",
      "name": "Enqueue",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        352,
        352
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Check if enqueue succeeded\nconst input = $('Check Result').first().json;\n\n// If we got here without error, success\nif ($json.error) {\n  return [{ json: { success: false, error: $json.error, ...input } }];\n}\n\nreturn [{ json: { success: true, ...input } }];"
      },
      "id": "b9e64042-d25d-4afd-93e2-b3e626fb3a73",
      "name": "Check Enqueue",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        576,
        352
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "success-check",
              "leftValue": "={{$json.success}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "c588cba1-479b-4fd1-839d-eb280521e2d1",
      "name": "If Enqueued",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        800,
        352
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: false, error: 'queue_error', message_id: $json.message_id, trace_id: $json.trace_id } }}",
        "options": {
          "responseCode": 503
        }
      },
      "id": "dcdf55e6-11db-489d-ba96-268772f73064",
      "name": "Respond Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1024,
        256
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: true, message_id: $json.message_id, trace_id: $json.trace_id } }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "e4a95e9d-5b63-413d-8d98-f518e0e1c3f3",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1024,
        448
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Input": {
      "main": [
        [
          {
            "node": "If Valid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid": {
      "main": [
        [
          {
            "node": "Respond Invalid",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Duplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Duplicate": {
      "main": [
        [
          {
            "node": "Check Result",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Result": {
      "main": [
        [
          {
            "node": "If Duplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Duplicate": {
      "main": [
        [
          {
            "node": "Respond Duplicate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mark Processed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Processed": {
      "main": [
        [
          {
            "node": "Enqueue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enqueue": {
      "main": [
        [
          {
            "node": "Check Enqueue",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Enqueue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Enqueue": {
      "main": [
        [
          {
            "node": "If Enqueued",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Enqueued": {
      "main": [
        [
          {
            "node": "Respond Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "2399cecc-5731-4a8c-831d-56c78d3e7417",
  "activeVersionId": null,
  "versionCounter": 11,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-12-11T17:08:59.812Z",
      "createdAt": "2025-12-11T17:08:59.812Z",
      "role": "workflow:owner",
      "workflowId": "peUaEixC2W6l75s5",
      "projectId": "x7frUSUEowDAk8Dt",
      "project": {
        "updatedAt": "2025-08-25T18:57:22.218Z",
        "createdAt": "2025-08-25T08:16:18.805Z",
        "id": "x7frUSUEowDAk8Dt",
        "name": "Dmitriy Remacs <dk@n8nsrv.ru>",
        "type": "personal",
        "icon": null,
        "description": null,
        "projectRelations": [
          {
            "updatedAt": "2025-08-25T08:16:18.805Z",
            "createdAt": "2025-08-25T08:16:18.805Z",
            "userId": "1d5222a1-8f53-4940-b7de-93daeae04393",
            "projectId": "x7frUSUEowDAk8Dt",
            "user": {
              "updatedAt": "2025-12-20T04:36:02.000Z",
              "createdAt": "2025-08-25T08:16:17.784Z",
              "id": "1d5222a1-8f53-4940-b7de-93daeae04393",
              "email": "dk@n8nsrv.ru",
              "firstName": "Dmitriy",
              "lastName": "Remacs",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "RbSUhceYc7q41M5j",
                "userActivatedAt": 1756286438389
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-12-19",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-12-20T17:11:33.502Z",
      "createdAt": "2025-12-20T17:11:33.502Z",
      "id": "cuxaBKwkHf1KFGXh",
      "name": "InputCore"
    },
    {
      "updatedAt": "2025-12-09T18:50:08.518Z",
      "createdAt": "2025-12-09T18:50:08.518Z",
      "id": "tMSCjbvPU3xrNUqz",
      "name": "ELO"
    }
  ],
  "activeVersion": null
}