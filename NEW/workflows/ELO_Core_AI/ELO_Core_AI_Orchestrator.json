{
  "name": "ELO_Core_AI_Orchestrator",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "path": "elo-core-ai-orchestrator",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "elo-core-ai-orchestrator"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\n// Validate required fields\nconst required = ['tenant_id', 'client_id', 'dialog_id', 'text'];\nfor (const field of required) {\n  if (!input[field]) {\n    throw new Error(`Missing required field: ${field}`);\n  }\n}\n\n// Load context from Redis (will be implemented via HTTP)\n// For now, create initial context structure\nlet context = {\n  tenant_id: input.tenant_id,\n  client_id: input.client_id,\n  dialog_id: input.dialog_id,\n  vertical_id: input.vertical_id || 1, // Default: phone_repair\n  channel_id: input.channel_id,\n  external_chat_id: input.external_chat_id,\n  current_stage: 'data_collection',\n  stage_entered_at: new Date().toISOString(),\n  \n  lines: [],\n  focus_line_id: null,\n  completed_lines: [],\n  \n  client: input.client || {\n    name: input.client_name,\n    phone: input.client_phone\n  },\n  \n  booking: {\n    date: null,\n    time: null,\n    name: input.client?.name || input.client_name || null,\n    phone: input.client?.phone || input.client_phone || null\n  },\n  \n  message: {\n    text: input.text,\n    timestamp: input.timestamp || new Date().toISOString()\n  },\n  \n  trace_id: input.trace_id || `trace_${Date.now()}`\n};\n\nreturn {\n  input: input,\n  context: context,\n  is_new_context: true\n};"
      },
      "id": "load-context",
      "name": "Load Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-ai-extract",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  message: $json.context.message.text,\n  context: {\n    client: $json.context.client,\n    vertical_id: $json.context.vertical_id,\n    existing_lines: $json.context.lines\n  },\n  extraction_schema: {\n    entities: ['device', 'symptom', 'owner', 'intent'],\n    multi_entity: true\n  }\n}) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "ai-extract",
      "name": "AI Extract",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-lines-analyzer",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $('Load Context').first().json.context,\n  extractions: $json\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "lines-analyzer",
      "name": "Lines Analyzer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [910, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-ai-derive",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $json.context,\n  lines_to_derive: $json.context.lines.filter(l => l.slots?.symptom && !l.slots?.diagnosis).map(l => l.id)\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "ai-derive",
      "name": "AI Derive",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1130, 300]
    },
    {
      "parameters": {
        "jsCode": "const context = $('Lines Analyzer').first().json.context;\nconst derivations = $json.derivations || [];\n\n// Apply derived values to lines\nfor (const deriv of derivations) {\n  const line = context.lines.find(l => l.id === deriv.line_id);\n  if (line && deriv.derived) {\n    // Merge derived values into slots\n    if (deriv.derived.symptom_type && !line.slots.symptom_type) {\n      line.slots.symptom_type = deriv.derived.symptom_type;\n    }\n    if (deriv.derived.diagnosis && !line.slots.diagnosis) {\n      line.slots.diagnosis = deriv.derived.diagnosis;\n      line.cursor = Math.max(line.cursor, 3); // Move past diagnosis\n    }\n    if (deriv.derived.repair_type && !line.slots.repair_type) {\n      line.slots.repair_type = deriv.derived.repair_type;\n      line.cursor = Math.max(line.cursor, 4); // Move past repair_type\n    }\n    if (deriv.derived.price && !line.slots.price) {\n      line.slots.price = deriv.derived.price;\n      line.cursor = Math.max(line.cursor, 5); // Move past price\n    }\n  }\n}\n\nreturn { context };"
      },
      "id": "apply-derivations",
      "name": "Apply Derivations",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1350, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-triggers-checker",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $json.context,\n  stage: $json.context.current_stage\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "triggers-checker",
      "name": "Triggers Checker",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1570, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-stage-manager",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $('Apply Derivations').first().json.context\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "stage-manager",
      "name": "Stage Manager",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1790, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-response-generator",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $json.context,\n  triggers_fired: $('Triggers Checker').first().json.triggers_fired || []\n}) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "response-generator",
      "name": "Response Generator",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2010, 300]
    },
    {
      "parameters": {
        "jsCode": "const context = $('Stage Manager').first().json.context;\nconst response = $json.response;\nconst input = $('Load Context').first().json.input;\n\n// Prepare output for Channel OUT\nreturn {\n  tenant_id: context.tenant_id,\n  dialog_id: context.dialog_id,\n  channel_id: context.channel_id || input.channel_id,\n  external_chat_id: context.external_chat_id || input.external_chat_id,\n  message: response,\n  context_updated: true,\n  trace_id: context.trace_id\n};"
      },
      "id": "prepare-output",
      "name": "Prepare Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2230, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.n8nsrv.ru/webhook/elo-core-graph-writer",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  context: $('Stage Manager').first().json.context,\n  write_mode: 'incremental'\n}) }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "graph-writer",
      "name": "Graph Writer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2230, 500]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2450, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Load Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Context": {
      "main": [
        [
          {
            "node": "AI Extract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Extract": {
      "main": [
        [
          {
            "node": "Lines Analyzer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lines Analyzer": {
      "main": [
        [
          {
            "node": "AI Derive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Derive": {
      "main": [
        [
          {
            "node": "Apply Derivations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Derivations": {
      "main": [
        [
          {
            "node": "Triggers Checker",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Triggers Checker": {
      "main": [
        [
          {
            "node": "Stage Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Stage Manager": {
      "main": [
        [
          {
            "node": "Response Generator",
            "type": "main",
            "index": 0
          },
          {
            "node": "Graph Writer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response Generator": {
      "main": [
        [
          {
            "node": "Prepare Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Output": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "",
  "meta": {
    "instanceId": ""
  },
  "tags": [
    {
      "name": "ELO_Core_AI"
    }
  ]
}
