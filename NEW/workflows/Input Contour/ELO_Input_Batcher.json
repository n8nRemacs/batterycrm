{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 3
            }
          ]
        }
      },
      "id": "d87a59a2-7fe9-471a-afb3-d74b02627e8a",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1216,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// === CONFIG ===\nconst DEBOUNCE_MS = 10000;  // 10 сек тишины\nconst MAX_WAIT_MS = 40000;  // 40 сек максимум\n\nreturn [{\n  json: {\n    config: {\n      debounce_ms: DEBOUNCE_MS,\n      max_wait_ms: MAX_WAIT_MS\n    },\n    now: Date.now()\n  }\n}];"
      },
      "id": "bb398205-8f2e-4421-90fb-286557c07e59",
      "name": "Config",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        80
      ]
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "queue:incoming",
        "options": {}
      },
      "id": "530738d2-9847-4725-bf27-3af8f494d72f",
      "name": "Pop Message",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -816,
        80
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Парсим сообщение из Redis\nconst config = $('Config').first().json.config;\nconst now = $('Config').first().json.now;\n\n// Redis POP возвращает данные в разных форматах\nlet raw = $json.value;\nlet message = null;\n\nif ($json.propertyName && typeof $json.propertyName === 'object') {\n  message = $json.propertyName;\n  raw = JSON.stringify(message);\n} else if (raw && raw !== 'null' && raw !== '') {\n  try {\n    message = JSON.parse(raw);\n  } catch (e) {\n    return [{ json: { is_empty: true, config, now } }];\n  }\n}\n\nif (!message) {\n  return [{ json: { is_empty: true, config, now } }];\n}\n\nconst batch_key = `${message.channel || 'unknown'}:${message.external_chat_id || 'unknown'}`;\n\nreturn [{\n  json: {\n    is_empty: false,\n    message,\n    batch_key,\n    message_json: raw,\n    config,\n    now\n  }\n}];"
      },
      "id": "c1aaf3c9-4d64-4fd9-956d-d3483e0c2af7",
      "name": "Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        80
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "empty-check",
              "leftValue": "={{ $json.is_empty }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7bd20349-c441-4d9b-90a4-75b45a7f47d7",
      "name": "If Empty",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -416,
        80
      ]
    },
    {
      "parameters": {},
      "id": "4152a3f4-fcd9-4ce8-ba45-f1740235d11b",
      "name": "End (Empty)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -208,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=first_seen:{{ $json.batch_key }}",
        "options": {}
      },
      "id": "9c225f11-5d1e-4c51-9c60-d5609296d920",
      "name": "Get First Seen",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -208,
        176
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Вычисляем deadline\nconst prev = $('Parse Message').first().json;\nconst config = prev.config;\nconst now = prev.now;\nconst batch_key = prev.batch_key;\n\n// Получаем first_seen (может быть в value или в ключе объекта)\nlet first_seen_raw = $json.value;\nif (!first_seen_raw) {\n  const keys = Object.keys($json);\n  for (const k of keys) {\n    if (k.startsWith('first_seen:')) {\n      first_seen_raw = $json[k];\n      break;\n    }\n  }\n}\n\nlet first_seen = first_seen_raw ? parseInt(first_seen_raw, 10) : null;\nconst is_new_batch = !first_seen;\n\nif (is_new_batch) {\n  first_seen = now;\n}\n\n// deadline = min(first_seen + max_wait, now + debounce)\n// Это значит: \"обработать через 10 сек тишины, но не позже 40 сек от первого\"\nconst max_deadline = first_seen + config.max_wait_ms;\nconst debounce_deadline = now + config.debounce_ms;\nconst deadline = Math.min(max_deadline, debounce_deadline);\n\nreturn [{\n  json: {\n    batch_key,\n    message_json: prev.message_json,\n    first_seen,\n    is_new_batch,\n    deadline,\n    now\n  }\n}];"
      },
      "id": "29c3e06f-dc84-41ba-a419-abc17823b0a8",
      "name": "Calc Deadline",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        176
      ]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=batch:{{ $json.batch_key }}",
        "messageData": "={{ $json.message_json }}",
        "tail": true
      },
      "id": "51a76815-47d7-42d6-a481-06da59c5c1aa",
      "name": "Push To Batch",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        192,
        176
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "new-batch-check",
              "leftValue": "={{ $('Calc Deadline').first().json.is_new_batch }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e4e87e93-8df3-4ae9-a8f8-78e2cec05c44",
      "name": "If New Batch",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        176
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=first_seen:{{ $('Calc Deadline').first().json.batch_key }}",
        "value": "={{ String($('Calc Deadline').first().json.first_seen) }}",
        "expire": true,
        "ttl": 120
      },
      "id": "93b081c2-8179-471a-87e2-42882bceebf5",
      "name": "Set First Seen",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        592,
        80
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=deadline:{{ $('Calc Deadline').first().json.batch_key }}",
        "value": "={{ String($('Calc Deadline').first().json.deadline) }}",
        "expire": true,
        "ttl": 120
      },
      "id": "aadcb720-a625-4534-9295-3b14eb61b45d",
      "name": "Set Deadline",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        800,
        176
      ],
      "credentials": {
        "redis": {
          "id": "7FQcEivUY94atW24",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {},
      "id": "be8d5320-afec-4640-ba8c-437ff3bb52d9",
      "name": "End (Done)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        992,
        176
      ]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Pop Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pop Message": {
      "main": [
        [
          {
            "node": "Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Message": {
      "main": [
        [
          {
            "node": "If Empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Empty": {
      "main": [
        [
          {
            "node": "End (Empty)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get First Seen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get First Seen": {
      "main": [
        [
          {
            "node": "Calc Deadline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calc Deadline": {
      "main": [
        [
          {
            "node": "Push To Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push To Batch": {
      "main": [
        [
          {
            "node": "If New Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If New Batch": {
      "main": [
        [
          {
            "node": "Set First Seen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Deadline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set First Seen": {
      "main": [
        [
          {
            "node": "Set Deadline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Deadline": {
      "main": [
        [
          {
            "node": "End (Done)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "8ae77ca901b15c37bb42b26ea9b5a21b78217dd557a563108d875a64964c49bb"
  }
}