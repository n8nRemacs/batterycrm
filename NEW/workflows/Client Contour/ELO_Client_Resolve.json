{
  "name": "ELO_Client_Resolve",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "elo-client-resolve",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "Webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 400],
      "webhookId": "elo-client-resolve-001"
    },
    {
      "parameters": {
        "jsCode": "// Config - mirrors MCP config.py\nconst CONFIG = {\n  CACHE_TTL_TENANT: 86400,  // 24 hours\n  CACHE_TTL_CLIENT: 3600,   // 1 hour\n  CACHE_TTL_DIALOG: 1800,   // 30 min\n  CORE_URL: 'https://n8n.n8nsrv.ru/webhook/elo-core-ingest',\n  GRAPH_URL: 'http://45.144.177.128:8773/query'\n};\n\nconst input = $input.first().json;\n\n// Required fields check\nconst required = ['channel', 'external_chat_id', 'text'];\nfor (const field of required) {\n  if (!input[field]) {\n    throw new Error(`Missing required field: ${field}`);\n  }\n}\n\n// Extract credential based on channel\nlet credential = null;\nswitch (input.channel) {\n  case 'telegram': credential = input.bot_token; break;\n  case 'whatsapp': credential = input.profile_id; break;\n  case 'vk': credential = input.group_id; break;\n  case 'avito': credential = input.user_id; break;\n  case 'max': credential = input.bot_id; break;\n}\n\n// Generate trace_id if not provided\nconst trace_id = input.trace_id || `trace_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n// Cache keys - mirrors MCP resolvers\nconst tenant_cache_key = `cache:tenant:${input.channel}:${credential}`;\nconst client_cache_key_template = (channel_id, external_id) => `cache:client:${channel_id}:${external_id}`;\nconst dialog_cache_key_template = (client_id, channel_id) => `cache:dialog:${client_id}:${channel_id}`;\n\nreturn {\n  ...input,\n  credential,\n  trace_id,\n  tenant_cache_key,\n  config: CONFIG,\n  received_at: new Date().toISOString()\n};"
      },
      "id": "Validate Input",
      "name": "Validate Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 400]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.tenant_cache_key }}"
      },
      "id": "Cache Get Tenant",
      "name": "Cache Get Tenant",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [640, 400],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "cache-hit", "leftValue": "={{ $json.value }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Tenant Cache Hit?",
      "name": "Tenant Cache Hit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [860, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse cached tenant\nconst cached = JSON.parse($json.value);\nconst input = $('Validate Input').first().json;\n\nreturn {\n  ...input,\n  tenant_id: cached.tenant_id,\n  domain_id: cached.domain_id,\n  channel_id: cached.channel_id,\n  channel_account_id: cached.channel_account_id,\n  tenant_from_cache: true\n};"
      },
      "id": "Parse Cached Tenant",
      "name": "Parse Cached Tenant",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1080, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  t.id as tenant_id,\n  t.domain_id,\n  ca.id as channel_account_id,\n  ca.channel_id\nFROM elo_tenants t\nJOIN elo_channel_accounts ca ON ca.tenant_id = t.id\nWHERE ca.credential = '{{ $('Validate Input').first().json.credential }}'\n  AND ca.channel_code = '{{ $('Validate Input').first().json.channel }}'\n  AND ca.is_active = true\n  AND t.is_active = true\nLIMIT 1;",
        "options": {}
      },
      "id": "DB Get Tenant",
      "name": "DB Get Tenant",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1080, 500],
      "credentials": {"postgres": {"id": "ELO_PostgreSQL", "name": "ELO_PostgreSQL"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "tenant-found", "leftValue": "={{ $json.tenant_id }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Tenant Found?",
      "name": "Tenant Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 500]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $('Validate Input').first().json.tenant_cache_key }}",
        "value": "={{ JSON.stringify({ tenant_id: String($json.tenant_id), domain_id: $json.domain_id, channel_id: $json.channel_id, channel_account_id: $json.channel_account_id }) }}",
        "expire": true,
        "ttl": "={{ $('Validate Input').first().json.config.CACHE_TTL_TENANT }}"
      },
      "id": "Cache Set Tenant",
      "name": "Cache Set Tenant",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1520, 400],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "jsCode": "// Merge tenant from DB\nconst input = $('Validate Input').first().json;\nconst tenant = $('DB Get Tenant').first().json;\n\nreturn {\n  ...input,\n  tenant_id: String(tenant.tenant_id),\n  domain_id: tenant.domain_id,\n  channel_id: tenant.channel_id,\n  channel_account_id: tenant.channel_account_id,\n  tenant_from_cache: false\n};"
      },
      "id": "Merge Tenant",
      "name": "Merge Tenant",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1740, 400]
    },
    {
      "parameters": {
        "jsCode": "// DLQ for unknown tenant\nconst input = $('Validate Input').first().json;\n\nreturn {\n  error: 'unknown_tenant',\n  channel: input.channel,\n  credential: input.credential,\n  external_chat_id: input.external_chat_id,\n  trace_id: input.trace_id,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "Prepare DLQ Tenant",
      "name": "Prepare DLQ Tenant",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1520, 600]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "dlq:unknown_tenant",
        "tail": true,
        "messageData": "={{ JSON.stringify($json) }}"
      },
      "id": "Push DLQ Tenant",
      "name": "Push DLQ Tenant",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1740, 600],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: false, reason: 'unknown_tenant', trace_id: $('Validate Input').first().json.trace_id } }}",
        "options": {"responseCode": 404}
      },
      "id": "Respond Unknown Tenant",
      "name": "Respond Unknown Tenant",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1960, 600]
    },
    {
      "parameters": {
        "jsCode": "// Generate client cache key\nconst data = $json;\nconst cache_key = `cache:client:${data.channel_id}:${data.external_chat_id}`;\nreturn { ...data, client_cache_key: cache_key };"
      },
      "id": "Prepare Client Cache Key",
      "name": "Prepare Client Cache Key",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1960, 400]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.client_cache_key }}"
      },
      "id": "Cache Get Client",
      "name": "Cache Get Client",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [2180, 400],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "client-cache-hit", "leftValue": "={{ $json.value }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Client Cache Hit?",
      "name": "Client Cache Hit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2400, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse cached client\nconst cached = JSON.parse($json.value);\nconst data = $('Prepare Client Cache Key').first().json;\n\nreturn {\n  ...data,\n  client_id: cached.client_id,\n  client_name: cached.name,\n  client_phone: cached.phone,\n  is_new_client: false,\n  client_from_cache: true\n};"
      },
      "id": "Parse Cached Client",
      "name": "Parse Cached Client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2620, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.id as client_id, c.name, c.phone\nFROM elo_clients c\nJOIN elo_client_channels cc ON cc.client_id = c.id\nWHERE cc.channel_id = {{ $('Prepare Client Cache Key').first().json.channel_id }}\n  AND cc.external_id = '{{ $('Prepare Client Cache Key').first().json.external_chat_id }}'\n  AND c.tenant_id = '{{ $('Prepare Client Cache Key').first().json.tenant_id }}'::uuid\nLIMIT 1;",
        "options": {}
      },
      "id": "DB Get Client By External",
      "name": "DB Get Client By External",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [2620, 500],
      "credentials": {"postgres": {"id": "ELO_PostgreSQL", "name": "ELO_PostgreSQL"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "client-found", "leftValue": "={{ $json.client_id }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Client Found By External?",
      "name": "Client Found By External?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2840, 500]
    },
    {
      "parameters": {
        "jsCode": "// Merge client from DB + cache it\nconst data = $('Prepare Client Cache Key').first().json;\nconst client = $('DB Get Client By External').first().json;\n\nreturn {\n  ...data,\n  client_id: String(client.client_id),\n  client_name: client.name,\n  client_phone: client.phone,\n  is_new_client: false,\n  client_from_cache: false,\n  should_cache_client: true\n};"
      },
      "id": "Merge Existing Client",
      "name": "Merge Existing Client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3060, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH new_client AS (\n  INSERT INTO elo_clients (tenant_id, name, phone)\n  VALUES ('{{ $('Prepare Client Cache Key').first().json.tenant_id }}'::uuid, \n          {{ $('Prepare Client Cache Key').first().json.client_name ? \"'\" + $('Prepare Client Cache Key').first().json.client_name + \"'\" : 'NULL' }}, \n          {{ $('Prepare Client Cache Key').first().json.client_phone ? \"'\" + $('Prepare Client Cache Key').first().json.client_phone + \"'\" : 'NULL' }})\n  RETURNING id as client_id, name, phone\n),\nlink AS (\n  INSERT INTO elo_client_channels (client_id, channel_id, external_id)\n  SELECT client_id, {{ $('Prepare Client Cache Key').first().json.channel_id }}, '{{ $('Prepare Client Cache Key').first().json.external_chat_id }}'\n  FROM new_client\n)\nSELECT * FROM new_client;",
        "options": {}
      },
      "id": "DB Create Client",
      "name": "DB Create Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [3060, 600],
      "credentials": {"postgres": {"id": "ELO_PostgreSQL", "name": "ELO_PostgreSQL"}}
    },
    {
      "parameters": {
        "jsCode": "// Merge new client\nconst data = $('Prepare Client Cache Key').first().json;\nconst client = $('DB Create Client').first().json;\n\nreturn {\n  ...data,\n  client_id: String(client.client_id),\n  client_name: client.name,\n  client_phone: client.phone,\n  is_new_client: true,\n  client_from_cache: false,\n  should_cache_client: true\n};"
      },
      "id": "Merge New Client",
      "name": "Merge New Client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3280, 600]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.client_cache_key }}",
        "value": "={{ JSON.stringify({ client_id: $json.client_id, name: $json.client_name, phone: $json.client_phone, is_new: false }) }}",
        "expire": true,
        "ttl": "={{ $('Validate Input').first().json.config.CACHE_TTL_CLIENT }}"
      },
      "id": "Cache Set Client",
      "name": "Cache Set Client",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [3500, 500],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "jsCode": "// Prepare for dialog resolution\nconst data = $json;\nconst dialog_cache_key = `cache:dialog:${data.client_id}:${data.channel_id}`;\nreturn { ...data, dialog_cache_key };"
      },
      "id": "Prepare Dialog Cache Key",
      "name": "Prepare Dialog Cache Key",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3720, 400]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{ $json.dialog_cache_key }}"
      },
      "id": "Cache Get Dialog",
      "name": "Cache Get Dialog",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [3940, 400],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "dialog-cache-hit", "leftValue": "={{ $json.value }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Dialog Cache Hit?",
      "name": "Dialog Cache Hit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4160, 400]
    },
    {
      "parameters": {
        "jsCode": "// Parse cached dialog\nconst cached = JSON.parse($json.value);\nconst data = $('Prepare Dialog Cache Key').first().json;\n\n// Only use cache if dialog is still active\nif (cached.status === 'active' || cached.status === 'waiting') {\n  return {\n    ...data,\n    dialog_id: cached.dialog_id,\n    dialog_status: cached.status,\n    is_new_dialog: false,\n    dialog_from_cache: true\n  };\n}\n\n// Cache is stale, need to query DB\nreturn { ...data, dialog_from_cache: false, need_dialog_query: true };"
      },
      "id": "Parse Cached Dialog",
      "name": "Parse Cached Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4380, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id as dialog_id, status, vertical_id\nFROM elo_dialogs\nWHERE client_id = '{{ $('Prepare Dialog Cache Key').first().json.client_id }}'::uuid\n  AND channel_id = {{ $('Prepare Dialog Cache Key').first().json.channel_id }}\n  AND status IN ('active', 'waiting')\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "DB Get Dialog",
      "name": "DB Get Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [4380, 500],
      "credentials": {"postgres": {"id": "ELO_PostgreSQL", "name": "ELO_PostgreSQL"}}
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [
            {"id": "dialog-found", "leftValue": "={{ $json.dialog_id }}", "rightValue": "", "operator": {"type": "string", "operation": "exists", "singleValue": true}}
          ]
        }
      },
      "id": "Dialog Found?",
      "name": "Dialog Found?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4600, 500]
    },
    {
      "parameters": {
        "jsCode": "// Merge existing dialog\nconst data = $('Prepare Dialog Cache Key').first().json;\nconst dialog = $('DB Get Dialog').first().json;\n\nreturn {\n  ...data,\n  dialog_id: String(dialog.dialog_id),\n  dialog_status: dialog.status,\n  is_new_dialog: false,\n  dialog_from_cache: false,\n  should_cache_dialog: true\n};"
      },
      "id": "Merge Existing Dialog",
      "name": "Merge Existing Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4820, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elo_dialogs (tenant_id, client_id, channel_id, status)\nVALUES ('{{ $('Prepare Dialog Cache Key').first().json.tenant_id }}'::uuid, \n        '{{ $('Prepare Dialog Cache Key').first().json.client_id }}'::uuid, \n        {{ $('Prepare Dialog Cache Key').first().json.channel_id }}, \n        'active')\nRETURNING id as dialog_id;",
        "options": {}
      },
      "id": "DB Create Dialog",
      "name": "DB Create Dialog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [4820, 600],
      "credentials": {"postgres": {"id": "ELO_PostgreSQL", "name": "ELO_PostgreSQL"}}
    },
    {
      "parameters": {
        "jsCode": "// Merge new dialog\nconst data = $('Prepare Dialog Cache Key').first().json;\nconst dialog = $('DB Create Dialog').first().json;\n\nreturn {\n  ...data,\n  dialog_id: String(dialog.dialog_id),\n  dialog_status: 'active',\n  is_new_dialog: true,\n  dialog_from_cache: false,\n  should_cache_dialog: true\n};"
      },
      "id": "Merge New Dialog",
      "name": "Merge New Dialog",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5040, 600]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.dialog_cache_key }}",
        "value": "={{ JSON.stringify({ dialog_id: $json.dialog_id, status: $json.dialog_status || 'active', vertical_id: null, is_new: false }) }}",
        "expire": true,
        "ttl": "={{ $('Validate Input').first().json.config.CACHE_TTL_DIALOG }}"
      },
      "id": "Cache Set Dialog",
      "name": "Cache Set Dialog",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [5260, 500],
      "credentials": {"redis": {"id": "1", "name": "ELO_Redis"}}
    },
    {
      "parameters": {
        "jsCode": "// Build final output - mirrors MCP main.py\nconst data = $json;\n\nreturn {\n  tenant_id: data.tenant_id,\n  domain_id: data.domain_id,\n  client_id: data.client_id,\n  dialog_id: data.dialog_id,\n  channel_id: data.channel_id,\n  external_chat_id: data.external_chat_id,\n  text: data.text,\n  timestamp: data.timestamp,\n  message_ids: data.message_ids || [],\n  trace_id: data.trace_id,\n  media: data.media || {},\n  meta: {\n    ...(data.meta || {}),\n    is_new_client: data.is_new_client || false,\n    is_new_dialog: data.is_new_dialog || false,\n    tenant_from_cache: data.tenant_from_cache || false,\n    client_from_cache: data.client_from_cache || false,\n    dialog_from_cache: data.dialog_from_cache || false\n  },\n  client: {\n    id: data.client_id,\n    name: data.client_name,\n    phone: data.client_phone\n  }\n};"
      },
      "id": "Build Output",
      "name": "Build Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5480, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Validate Input').first().json.config.CORE_URL }}",
        "sendHeaders": true,
        "headerParameters": {"parameters": [{"name": "Content-Type", "value": "application/json"}]},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {"timeout": 10000}
      },
      "id": "Forward to Core",
      "name": "Forward to Core",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5700, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { accepted: true, tenant_id: $json.tenant_id, client_id: $json.client_id, dialog_id: $json.dialog_id, trace_id: $json.trace_id } }}",
        "options": {}
      },
      "id": "Respond Success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [5700, 500]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Validate Input", "type": "main", "index": 0}]]
    },
    "Validate Input": {
      "main": [[{"node": "Cache Get Tenant", "type": "main", "index": 0}]]
    },
    "Cache Get Tenant": {
      "main": [[{"node": "Tenant Cache Hit?", "type": "main", "index": 0}]]
    },
    "Tenant Cache Hit?": {
      "main": [
        [{"node": "Parse Cached Tenant", "type": "main", "index": 0}],
        [{"node": "DB Get Tenant", "type": "main", "index": 0}]
      ]
    },
    "Parse Cached Tenant": {
      "main": [[{"node": "Prepare Client Cache Key", "type": "main", "index": 0}]]
    },
    "DB Get Tenant": {
      "main": [[{"node": "Tenant Found?", "type": "main", "index": 0}]]
    },
    "Tenant Found?": {
      "main": [
        [{"node": "Cache Set Tenant", "type": "main", "index": 0}],
        [{"node": "Prepare DLQ Tenant", "type": "main", "index": 0}]
      ]
    },
    "Cache Set Tenant": {
      "main": [[{"node": "Merge Tenant", "type": "main", "index": 0}]]
    },
    "Merge Tenant": {
      "main": [[{"node": "Prepare Client Cache Key", "type": "main", "index": 0}]]
    },
    "Prepare DLQ Tenant": {
      "main": [[{"node": "Push DLQ Tenant", "type": "main", "index": 0}]]
    },
    "Push DLQ Tenant": {
      "main": [[{"node": "Respond Unknown Tenant", "type": "main", "index": 0}]]
    },
    "Prepare Client Cache Key": {
      "main": [[{"node": "Cache Get Client", "type": "main", "index": 0}]]
    },
    "Cache Get Client": {
      "main": [[{"node": "Client Cache Hit?", "type": "main", "index": 0}]]
    },
    "Client Cache Hit?": {
      "main": [
        [{"node": "Parse Cached Client", "type": "main", "index": 0}],
        [{"node": "DB Get Client By External", "type": "main", "index": 0}]
      ]
    },
    "Parse Cached Client": {
      "main": [[{"node": "Prepare Dialog Cache Key", "type": "main", "index": 0}]]
    },
    "DB Get Client By External": {
      "main": [[{"node": "Client Found By External?", "type": "main", "index": 0}]]
    },
    "Client Found By External?": {
      "main": [
        [{"node": "Merge Existing Client", "type": "main", "index": 0}],
        [{"node": "DB Create Client", "type": "main", "index": 0}]
      ]
    },
    "Merge Existing Client": {
      "main": [[{"node": "Cache Set Client", "type": "main", "index": 0}]]
    },
    "DB Create Client": {
      "main": [[{"node": "Merge New Client", "type": "main", "index": 0}]]
    },
    "Merge New Client": {
      "main": [[{"node": "Cache Set Client", "type": "main", "index": 0}]]
    },
    "Cache Set Client": {
      "main": [[{"node": "Prepare Dialog Cache Key", "type": "main", "index": 0}]]
    },
    "Prepare Dialog Cache Key": {
      "main": [[{"node": "Cache Get Dialog", "type": "main", "index": 0}]]
    },
    "Cache Get Dialog": {
      "main": [[{"node": "Dialog Cache Hit?", "type": "main", "index": 0}]]
    },
    "Dialog Cache Hit?": {
      "main": [
        [{"node": "Parse Cached Dialog", "type": "main", "index": 0}],
        [{"node": "DB Get Dialog", "type": "main", "index": 0}]
      ]
    },
    "Parse Cached Dialog": {
      "main": [[{"node": "Build Output", "type": "main", "index": 0}]]
    },
    "DB Get Dialog": {
      "main": [[{"node": "Dialog Found?", "type": "main", "index": 0}]]
    },
    "Dialog Found?": {
      "main": [
        [{"node": "Merge Existing Dialog", "type": "main", "index": 0}],
        [{"node": "DB Create Dialog", "type": "main", "index": 0}]
      ]
    },
    "Merge Existing Dialog": {
      "main": [[{"node": "Cache Set Dialog", "type": "main", "index": 0}]]
    },
    "DB Create Dialog": {
      "main": [[{"node": "Merge New Dialog", "type": "main", "index": 0}]]
    },
    "Merge New Dialog": {
      "main": [[{"node": "Cache Set Dialog", "type": "main", "index": 0}]]
    },
    "Cache Set Dialog": {
      "main": [[{"node": "Build Output", "type": "main", "index": 0}]]
    },
    "Build Output": {
      "main": [
        [{"node": "Forward to Core", "type": "main", "index": 0}],
        [{"node": "Respond Success", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
