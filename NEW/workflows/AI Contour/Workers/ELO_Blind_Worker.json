{
  "name": "ELO_Blind_Worker",
  "description": "Universal blind worker: polls Redis, executes tasks (LLM, HTTP, Webhook), returns results. Model is dynamic from config.",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{"field": "seconds", "secondsInterval": 2}]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-1312, 64]
    },
    {
      "parameters": {
        "operation": "pop",
        "list": "elo:tasks:pending",
        "tail": true,
        "options": {}
      },
      "id": "redis-pop",
      "name": "Redis Pop Task",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [-1088, 64],
      "credentials": {
        "redis": {"id": "7FQcEivUY94atW24", "name": "Redis account"}
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "loose"},
          "conditions": [{
            "id": "check-exists",
            "leftValue": "={{ $json.data }}",
            "rightValue": "",
            "operator": {"type": "string", "operation": "isNotEmpty"}
          }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "task-exists",
      "name": "Task Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-864, 64]
    },
    {
      "parameters": {
        "jsCode": "const taskJson = $input.first().json.data;\nconst task = JSON.parse(taskJson);\n\nreturn {\n  task_id: task.task_id,\n  trace_id: task.trace_id,\n  task_type: task.task_type,\n  config: task.config,\n  meta: task.meta,\n  callback: task.callback,\n  _start_time: Date.now()\n};"
      },
      "id": "parse-task",
      "name": "Parse Task",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-608, 64]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
                "conditions": [{"leftValue": "={{ $json.task_type }}", "rightValue": "llm_extraction", "operator": {"type": "string", "operation": "equals"}}],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "llm_extraction"
            },
            {
              "conditions": {
                "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
                "conditions": [{"leftValue": "={{ $json.task_type }}", "rightValue": "llm_generation", "operator": {"type": "string", "operation": "equals"}}],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "llm_generation"
            },
            {
              "conditions": {
                "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
                "conditions": [{"leftValue": "={{ $json.task_type }}", "rightValue": "http_request", "operator": {"type": "string", "operation": "equals"}}],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "http_request"
            },
            {
              "conditions": {
                "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
                "conditions": [{"leftValue": "={{ $json.task_type }}", "rightValue": "webhook_call", "operator": {"type": "string", "operation": "equals"}}],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "webhook_call"
            }
          ]
        },
        "options": {"fallbackOutput": "extra"}
      },
      "id": "task-router",
      "name": "Task Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [-384, 64]
    },
    {
      "parameters": {
        "jsCode": "const task = $('Parse Task').first().json;\nconst config = task.config;\n\n// Agent Tiers mapping (hardcoded for speed)\nconst AGENT_TIERS = {\n  nano: 'qwen/qwen3-4b:free',\n  small: 'qwen/qwen3-8b',\n  optima: 'anthropic/claude-3-haiku',\n  pro: 'openai/gpt-4o-mini',\n  expert: 'anthropic/claude-3-5-sonnet'\n};\n\n// Get model: agent_tier -> model -> default\nlet model;\nif (config.agent_tier && AGENT_TIERS[config.agent_tier]) {\n  model = AGENT_TIERS[config.agent_tier];\n} else {\n  model = config.model || 'qwen/qwen3-4b:free';\n}\n\n// Build system prompt\nlet systemPrompt = config.system_prompt || 'You are an entity extraction assistant. Return ONLY valid JSON.';\n\n// Build user prompt\nlet userPrompt = config.prompt || '';\nif (config.message) {\n  userPrompt = userPrompt.replace('{{message}}', config.message);\n}\n\n// Add output schema if provided\nif (config.output_schema) {\n  const schema = typeof config.output_schema === 'string' ? config.output_schema : JSON.stringify(config.output_schema);\n  systemPrompt += `\\n\\nExpected output schema: ${schema}`;\n}\n\n// Add examples if provided\nif (config.examples && config.examples.length > 0) {\n  userPrompt += '\\n\\nExamples:\\n';\n  for (const ex of config.examples) {\n    userPrompt += `Input: \"${ex.input}\"\\nOutput: ${JSON.stringify(ex.output)}\\n\\n`;\n  }\n}\n\n// Final message\nif (config.message) {\n  userPrompt += `\\n\\nNow extract from: \"${config.message}\"\\nReturn JSON only:`;\n}\n\nreturn {\n  model: model,\n  system_prompt: systemPrompt,\n  user_prompt: userPrompt,\n  temperature: config.temperature || 0.1,\n  max_tokens: config.max_tokens || 500,\n  task: task\n};"
      },
      "id": "build-llm-prompt",
      "name": "Build LLM Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-96, -100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  model: $json.model,\n  messages: [\n    { role: 'system', content: $json.system_prompt },\n    { role: 'user', content: $json.user_prompt }\n  ],\n  temperature: $json.temperature,\n  max_tokens: $json.max_tokens\n}) }}",
        "options": {"timeout": 60000}
      },
      "id": "call-openrouter",
      "name": "Call OpenRouter (Dynamic)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [160, -100],
      "credentials": {
        "httpHeaderAuth": {"id": "openrouter-header", "name": "OpenRouter API Key"}
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Parse LLM response\nconst response = $json;\nconst promptData = $('Build LLM Prompt').first().json;\nconst task = promptData.task;\n\nlet result = null;\nlet error = null;\nlet rawContent = '';\n\ntry {\n  rawContent = response.choices?.[0]?.message?.content || '';\n  \n  // Clean up response\n  let content = rawContent.trim();\n  \n  // Remove thinking tags if present (Qwen3)\n  content = content.replace(/<think>[\\s\\S]*?<\\/think>/g, '').trim();\n  \n  // Extract JSON from response\n  const jsonMatch = content.match(/[\\[\\{][\\s\\S]*[\\]\\}]/);\n  if (jsonMatch) {\n    result = JSON.parse(jsonMatch[0]);\n  } else {\n    // Try to parse as-is\n    result = JSON.parse(content);\n  }\n} catch (e) {\n  error = e.message;\n  result = { raw: rawContent, parse_error: e.message };\n}\n\n// Extract usage details\nconst usage = response.usage || {};\n\nreturn {\n  task_id: task.task_id,\n  trace_id: task.trace_id,\n  code: task.meta?.code,\n  level: task.meta?.level,\n  result: result,\n  model_used: response.model || promptData.model,\n  agent_tier: task.config?.agent_tier || null,\n  prompt_tokens: usage.prompt_tokens || 0,\n  completion_tokens: usage.completion_tokens || 0,\n  tokens_used: usage.total_tokens || 0,\n  raw_response: rawContent,\n  duration_ms: Date.now() - task._start_time,\n  error: error,\n  callback: task.callback,\n  meta: task.meta,\n  tenant_id: task.meta?.tenant_id || null\n};"
      },
      "id": "parse-llm-response",
      "name": "Parse LLM Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [416, -100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Task').first().json.config.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{"name": "Content-Type", "value": "application/json"}]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Parse Task').first().json.config.body }}",
        "options": {"timeout": 30000}
      },
      "id": "http-request",
      "name": "HTTP Request",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [0, 100],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Parse Task').first().json.config.webhook_url }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('Parse Task').first().json.config.payload) }}",
        "options": {"timeout": 30000}
      },
      "id": "webhook-call",
      "name": "Webhook Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [0, 260],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Format result from HTTP/Webhook handlers\nconst task = $('Parse Task').first().json;\nconst response = $input.first().json;\n\nreturn {\n  task_id: task.task_id,\n  trace_id: task.trace_id,\n  code: task.meta?.code,\n  level: task.meta?.level,\n  result: response,\n  duration_ms: Date.now() - task._start_time,\n  error: response.error || null,\n  callback: task.callback,\n  meta: task.meta\n};"
      },
      "id": "format-http-result",
      "name": "Format HTTP Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [256, 180]
    },
    {
      "parameters": {
        "jsCode": "// Handle unknown task types\nconst task = $('Parse Task').first().json;\n\nreturn {\n  task_id: task.task_id,\n  trace_id: task.trace_id,\n  code: task.meta?.code,\n  level: task.meta?.level,\n  result: null,\n  duration_ms: Date.now() - task._start_time,\n  error: `Unknown task_type: ${task.task_type}`,\n  callback: task.callback,\n  meta: task.meta\n};"
      },
      "id": "handle-unknown",
      "name": "Handle Unknown",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [0, 420]
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $json.callback?.result_key || 'elo:results:unknown' }}",
        "messageData": "={{ JSON.stringify({\n  task_id: $json.task_id,\n  code: $json.code,\n  level: $json.level,\n  result: $json.result,\n  model_used: $json.model_used,\n  tokens_used: $json.tokens_used,\n  duration_ms: $json.duration_ms,\n  error: $json.error\n}) }}"
      },
      "id": "redis-push-result",
      "name": "Redis Push Result",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [672, 100],
      "credentials": {
        "redis": {"id": "7FQcEivUY94atW24", "name": "Redis account"}
      }
    },
    {
      "parameters": {
        "operation": "incr",
        "key": "={{ $('Parse LLM Response').first()?.json?.callback?.counter_key || $('Format HTTP Result').first()?.json?.callback?.counter_key || $('Handle Unknown').first()?.json?.callback?.counter_key || 'elo:counter:unknown' }}"
      },
      "id": "redis-incr-counter",
      "name": "Redis Incr Counter",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [896, 100],
      "credentials": {
        "redis": {"id": "7FQcEivUY94atW24", "name": "Redis account"}
      }
    },
    {
      "parameters": {
        "jsCode": "// Check if all tasks complete\nconst counter = parseInt($json.data || '0');\nconst meta = $('Parse LLM Response').first()?.json?.meta || \n             $('Format HTTP Result').first()?.json?.meta || \n             $('Handle Unknown').first()?.json?.meta || {};\n             \nconst callback = $('Parse LLM Response').first()?.json?.callback || \n                 $('Format HTTP Result').first()?.json?.callback || \n                 $('Handle Unknown').first()?.json?.callback || {};\n\nconst totalTasks = meta.total_tasks || 1;\nconst isComplete = counter >= totalTasks;\n\nreturn {\n  counter: counter,\n  total_tasks: totalTasks,\n  is_complete: isComplete,\n  status_key: callback.status_key,\n  notify_webhook: callback.notify_webhook\n};"
      },
      "id": "check-completion",
      "name": "Check Completion",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {"caseSensitive": true, "leftValue": "", "typeValidation": "strict"},
          "conditions": [{
            "id": "is-complete",
            "leftValue": "={{ $json.is_complete }}",
            "rightValue": true,
            "operator": {"type": "boolean", "operation": "equals"}
          }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-complete",
      "name": "All Complete?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1344, 100]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.status_key }}",
        "value": "complete",
        "expire": true,
        "ttl": 3600
      },
      "id": "set-status-complete",
      "name": "Set Status Complete",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1568, 0],
      "credentials": {
        "redis": {"id": "7FQcEivUY94atW24", "name": "Redis account"}
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Check Completion').first().json.notify_webhook }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  status: 'complete',\n  trace_id: $('Parse Task').first().json.trace_id,\n  counter: $('Check Completion').first().json.counter,\n  total_tasks: $('Check Completion').first().json.total_tasks\n}) }}",
        "options": {"timeout": 5000}
      },
      "id": "notify-complete",
      "name": "Notify Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1792, 0],
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO elo_t_token_usage (tenant_id, trace_id, task_id, model_id, agent_tier, prompt_tokens, completion_tokens, total_tokens, cost_usd, task_type, context_type_code) SELECT $1::uuid, $2, $3, $4, $5, $6::int, $7::int, $8::int, COALESCE((SELECT ($6 * input_cost_per_1m + $7 * output_cost_per_1m) / 1000000.0 FROM elo_model_pricing WHERE model_id = $4), 0), $9, $10 WHERE $1 IS NOT NULL AND $1 != '';",
        "options": {
          "queryReplacement": "={{ [$json.tenant_id || '', $json.trace_id || '', $json.task_id || '', $json.model_used || '', $json.agent_tier || '', $json.prompt_tokens || 0, $json.completion_tokens || 0, $json.tokens_used || 0, $('Parse Task').first().json.task_type || 'llm_extraction', $json.code || ''] }}"
        }
      },
      "id": "log-token-usage",
      "name": "Log Token Usage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [640, -100],
      "credentials": {
        "postgres": {"id": "n2SyhP9QhMnp1ryk", "name": "Postgres account"}
      },
      "continueOnFail": true
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [[{"node": "Redis Pop Task", "type": "main", "index": 0}]]
    },
    "Redis Pop Task": {
      "main": [[{"node": "Task Exists?", "type": "main", "index": 0}]]
    },
    "Task Exists?": {
      "main": [
        [{"node": "Parse Task", "type": "main", "index": 0}],
        []
      ]
    },
    "Parse Task": {
      "main": [[{"node": "Task Router", "type": "main", "index": 0}]]
    },
    "Task Router": {
      "main": [
        [{"node": "Build LLM Prompt", "type": "main", "index": 0}],
        [{"node": "Build LLM Prompt", "type": "main", "index": 0}],
        [{"node": "HTTP Request", "type": "main", "index": 0}],
        [{"node": "Webhook Call", "type": "main", "index": 0}],
        [{"node": "Handle Unknown", "type": "main", "index": 0}]
      ]
    },
    "Build LLM Prompt": {
      "main": [[{"node": "Call OpenRouter (Dynamic)", "type": "main", "index": 0}]]
    },
    "Call OpenRouter (Dynamic)": {
      "main": [[{"node": "Parse LLM Response", "type": "main", "index": 0}]]
    },
    "Parse LLM Response": {
      "main": [[
        {"node": "Log Token Usage", "type": "main", "index": 0},
        {"node": "Redis Push Result", "type": "main", "index": 0}
      ]]
    },
    "HTTP Request": {
      "main": [[{"node": "Format HTTP Result", "type": "main", "index": 0}]]
    },
    "Webhook Call": {
      "main": [[{"node": "Format HTTP Result", "type": "main", "index": 0}]]
    },
    "Format HTTP Result": {
      "main": [[{"node": "Redis Push Result", "type": "main", "index": 0}]]
    },
    "Handle Unknown": {
      "main": [[{"node": "Redis Push Result", "type": "main", "index": 0}]]
    },
    "Redis Push Result": {
      "main": [[{"node": "Redis Incr Counter", "type": "main", "index": 0}]]
    },
    "Redis Incr Counter": {
      "main": [[{"node": "Check Completion", "type": "main", "index": 0}]]
    },
    "Check Completion": {
      "main": [[{"node": "All Complete?", "type": "main", "index": 0}]]
    },
    "All Complete?": {
      "main": [
        [{"node": "Set Status Complete", "type": "main", "index": 0}],
        []
      ]
    },
    "Set Status Complete": {
      "main": [[{"node": "Notify Complete", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "tags": [
    {"id": "8dihLRJvdhkW2kZ1", "name": "AI"},
    {"id": "tMSCjbvPU3xrNUqz", "name": "ELO"}
  ],
  "meta": {"templateCredsSetupCompleted": true}
}
