{
  "id": "OUjTFzd7k4tdoAjh",
  "name": "BAT Client Resolver",
  "active": false,
  "nodes": [
    {
      "parameters": {},
      "id": "7d6beef3-4094-4b58-9dc7-1c9a461d2256",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -864,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH potential_clients AS (\n  SELECT * FROM clients \n  WHERE tenant_id = '{{ $json.tenant_id }}'\n    AND (\n      (phone IS NOT NULL AND phone = '{{ $json.client_phone }}')\n      OR (telegram_id IS NOT NULL AND telegram_id = '{{ $json.external_user_id }}' AND '{{ $json.channel }}' = 'telegram')\n      OR (vk_id IS NOT NULL AND vk_id = '{{ $json.external_user_id }}' AND '{{ $json.channel }}' = 'vk')\n      OR (whatsapp_id IS NOT NULL AND whatsapp_id = '{{ $json.external_user_id }}' AND '{{ $json.channel }}' = 'whatsapp')\n      OR (avito_id IS NOT NULL AND avito_id = '{{ $json.external_user_id }}' AND '{{ $json.channel }}' = 'avito')\n    )\n  LIMIT 1\n),\nresolved_client AS (\n  SELECT \n    COALESCE(master.id, pc.id) as id,\n    COALESCE(master.phone, pc.phone) as phone,\n    COALESCE(master.name, pc.name) as name,\n    COALESCE(master.telegram_id, pc.telegram_id) as telegram_id,\n    COALESCE(master.vk_id, pc.vk_id) as vk_id,\n    COALESCE(master.whatsapp_id, pc.whatsapp_id) as whatsapp_id,\n    COALESCE(master.avito_id, pc.avito_id) as avito_id,\n    CASE WHEN cm.id IS NOT NULL THEN true ELSE false END as was_merged\n  FROM potential_clients pc\n  LEFT JOIN client_merges cm ON pc.id = cm.merged_client_id\n  LEFT JOIN clients master ON cm.master_client_id = master.id\n)\nSELECT * FROM resolved_client;",
        "options": {}
      },
      "id": "f19d7308-5f7a-4d1f-84bb-b99bd69799ef",
      "name": "Find Client",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -624,
        -96
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.client_found }}",
              "value2": true
            }
          ]
        }
      },
      "id": "69b5413c-8b69-4855-80ff-24d0c72edc2f",
      "name": "Client Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        80,
        -96
      ]
    },
    {
      "parameters": {
        "jsCode": "// ИСПРАВЛЕНО: Используем данные из $input напрямую\n// Prepare Contract уже подготовил client объект\n\nconst inputData = $input.first().json;\n\nconsole.log('═══ MERGE FOUND CLIENT ═══');\nconsole.log('Input keys:', Object.keys(inputData || {}));\nconsole.log('Has client?', !!inputData?.client);\nconsole.log('Client ID:', inputData?.client?.id);\n\n// Данные клиента уже есть в input.client (от Prepare Contract)\nconst client = inputData?.client;\n\n// Проверка что клиент найден\nif (!client || !client.id) {\n  console.error('❌ Client data not found in input!');\n  console.error('Input:', JSON.stringify(inputData, null, 2));\n  throw new Error('❌ Client not found in input! Check Prepare Contract output.');\n}\n\nconsole.log('✅ Client found! ID:', client.id);\n\n// Формируем выход - пробрасываем все данные\nreturn {\n  ...inputData,\n  client: {\n    id: client.id,\n    phone: client.phone,\n    name: client.name,\n    telegram_id: client.telegram_id,\n    vk_id: client.vk_id,\n    whatsapp_id: client.whatsapp_id,\n    avito_id: client.avito_id,\n    was_merged: client.was_merged || false\n  },\n  client_found: true\n};"
      },
      "id": "4c303c86-30dd-4585-a155-e08373da0cd0",
      "name": "Merge Found Client",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -192
      ]
    },
    {
      "parameters": {
        "workflowId": "=vkQwat1iZhJJj7C9",
        "options": {}
      },
      "id": "2c492cfe-24a0-4829-98df-8a66e8aa5458",
      "name": "Execute Client Creator",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        464,
        16
      ]
    },
    {
      "parameters": {
        "workflowId": "=L2pYPcv7r8j5XFU3",
        "options": {}
      },
      "id": "4fe0aee9-6f53-4f66-8f47-34fd9152688e",
      "name": "Execute Appeal Manager",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        752,
        -96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"client_id\": $json.client.id } }}",
        "options": {}
      },
      "id": "1c68e105-a68a-49d5-b398-b4d6e2c139b3",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        976,
        -96
      ]
    },
    {
      "parameters": {
        "jsCode": "// Безопасный доступ к данным нод\nfunction fromNode(name) {\n  try {\n    const arr = $items(name);\n    return (arr && arr.length > 0) ? (arr[0].json || null) : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst input = fromNode('Execute Workflow Trigger') || $input.first()?.json || {};\nconst sqlResult = $input.first()?.json; // Результат SQL\n\nconsole.log('=== PREPARE CONTRACT DEBUG ===');\nconsole.log('SQL Result type:', typeof sqlResult);\nconsole.log('SQL Result is array:', Array.isArray(sqlResult));\nconsole.log('SQL Result:', JSON.stringify(sqlResult, null, 2));\n\nfunction pick(existing, ...cands) {\n  if (existing !== undefined && existing !== null && `${existing}` !== '') return existing;\n  for (const c of cands) {\n    if (c !== undefined && c !== null && `${c}` !== '') return c;\n  }\n  return existing ?? null;\n}\n\n// КРИТИЧНО: Правильная обработка результата SQL\nlet clientRow = null;\n\nif (sqlResult) {\n  if (Array.isArray(sqlResult)) {\n    // Если массив - берем первый элемент (если есть)\n    if (sqlResult.length > 0) {\n      clientRow = sqlResult[0];\n      console.log('✅ Client found in array:', clientRow.id);\n    } else {\n      console.log('⚠️ SQL returned empty array - client not found');\n    }\n  } else if (sqlResult.id) {\n    // Если объект с id\n    clientRow = sqlResult;\n    console.log('✅ Client found as object:', clientRow.id);\n  }\n}\n\n// Сохраняем все входные данные\nconst src = input;\nconst prop = src.propertyName || {};\nconst meta = prop.meta || {};\nconst raw = meta.raw || {};\n\n// Базовые поля из входных данных\nconst channel = pick(src.channel, prop.channel, meta.ad_channel);\nconst external_chat_id = pick(src.external_chat_id, prop.external_chat_id, raw.chat?.id?.toString());\nconst external_user_id = pick(src.external_user_id, prop.external_user_id, raw.from?.id?.toString());\nconst external_message_id = pick(src.external_message_id, prop.external_message_id, meta.external_message_id, raw.message_id?.toString());\nconst timestamp = pick(src.timestamp, prop.timestamp, meta.timestamp, raw.date ? new Date(raw.date * 1000).toISOString() : null);\nconst text = pick(src.text, prop.text, raw.text);\n\n// Клиент из SQL результата\nconst client = clientRow && clientRow.id ? {\n  id: clientRow.id,\n  phone: clientRow.phone,\n  name: clientRow.name,\n  telegram_id: clientRow.telegram_id,\n  vk_id: clientRow.vk_id,\n  whatsapp_id: clientRow.whatsapp_id,\n  avito_id: clientRow.avito_id,\n  was_merged: clientRow.was_merged || false\n} : {};\n\nconsole.log('Client object:', JSON.stringify(client, null, 2));\nconsole.log('Client found:', !!clientRow && !!clientRow.id);\n\n// Appeal (пробрасываем если был)\nconst appealSrc = src.appeal || {};\nconst appeal = appealSrc.id ? {\n  id: appealSrc.id,\n  stage: appealSrc.stage,\n  phone_model: appealSrc.phone_model,\n  model_id: appealSrc.model_id,\n  problem_description: appealSrc.problem_description,\n  operation_mode: appealSrc.operation_mode,\n  is_new: appealSrc.is_new,\n  estimated_cost: appealSrc.estimated_cost,\n  estimated_time: appealSrc.estimated_time\n} : null;\n\n// Итог\nconst out = {\n  ...src,\n  ...(channel != null ? { channel } : {}),\n  ...(external_chat_id != null ? { external_chat_id } : {}),\n  ...(external_user_id != null ? { external_user_id } : {}),\n  ...(external_message_id != null ? { external_message_id } : {}),\n  ...(timestamp != null ? { timestamp } : {}),\n  ...(text ? { text } : {}),\n  client: client,\n  client_found: !!(clientRow && clientRow.id),\n  ...(appeal ? { appeal } : {})\n};\n\nif (out.success === undefined) out.success = true;\n\nconsole.log('=== OUTPUT ===');\nconsole.log('client_found:', out.client_found);\nconsole.log('client.id:', out.client?.id);\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        -96
      ],
      "id": "54b6b023-83bd-4f41-a240-0b5703b7ef3f",
      "name": "Prepare Contract"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Find Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Client": {
      "main": [
        [
          {
            "node": "Prepare Contract",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Exists?": {
      "main": [
        [
          {
            "node": "Merge Found Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Client Creator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Found Client": {
      "main": [
        [
          {
            "node": "Execute Appeal Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Client Creator": {
      "main": [
        [
          {
            "node": "Execute Appeal Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Appeal Manager": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Contract": {
      "main": [
        [
          {
            "node": "Client Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "updatedAt": "2025-11-23T03:59:12.594Z",
      "createdAt": "2025-11-23T03:59:12.594Z",
      "id": "8zD9sDD78ytgu5T2",
      "name": "BattCRM"
    },
    {
      "updatedAt": "2025-11-23T04:04:01.292Z",
      "createdAt": "2025-11-23T04:04:01.292Z",
      "id": "eiI07cPEeFxzR69p",
      "name": "Core"
    }
  ],
  "updatedAt": "2025-11-27T11:14:53.000Z",
  "createdAt": "2025-10-14T06:53:23.781Z"
}