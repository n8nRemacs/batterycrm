{
  "name": "ELO_In_App",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "in-app",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "in-app-webhook"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body || $input.item.json;\n\nreturn {\n  json: {\n    ...body,\n    needs_transcription: !!(body.has_audio && body.audio_url),\n    needs_media_download: !!(body.has_media && body.media_url)\n  }\n};"
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000002",
      "name": "Prepare",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_transcription }}",
              "value2": true
            }
          ]
        }
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000003",
      "name": "Has Audio?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.audio_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000004",
      "name": "Download Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 180]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/audio/transcriptions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "parameterType": "formBinaryData",
              "inputDataFieldName": "data"
            },
            {
              "name": "model",
              "value": "whisper-1"
            },
            {
              "name": "language",
              "value": "ru"
            }
          ]
        },
        "options": {}
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000005",
      "name": "Whisper",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 180]
    },
    {
      "parameters": {
        "jsCode": "const prepare = $('Prepare').item.json;\nconst transcription = $input.item.json.text || '';\n\nlet text = prepare.text || '';\nif (transcription) {\n  text = text ? `${text}\\n[Voice]: ${transcription}` : transcription;\n}\n\nreturn {\n  json: {\n    ...prepare,\n    text: text,\n    transcription: transcription\n  }\n};"
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000006",
      "name": "Add Transcription",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 180]
    },
    {
      "parameters": {
        "jsCode": "return $input.item;"
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000007",
      "name": "No Audio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 420]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_media_download }}",
              "value2": true
            }
          ]
        }
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000008",
      "name": "Has Media?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://155.212.221.189:8800/api/proxy/fetch",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tenant_id\": \"{{ $json.tenant_id || 'default' }}\",\n  \"url\": \"{{ $json.media_url }}\",\n  \"method\": \"GET\",\n  \"timeout\": 60,\n  \"server_id\": \"{{ $json.server_id }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          },
          "timeout": 90000
        }
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000009",
      "name": "Proxy Fetch Media",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 180]
    },
    {
      "parameters": {
        "operation": "write",
        "fileName": "={{ '/tmp/media_' + $('Prepare').item.json.id + '.' + ($('Prepare').item.json.media_type || 'bin').split('/').pop() }}",
        "options": {}
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000010",
      "name": "Save Media",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [2000, 180]
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Has Media?').item.json;\nconst savedFile = $input.item.json;\n\nreturn {\n  json: {\n    ...prev,\n    media_local_path: savedFile.fileName,\n    media_downloaded: true\n  }\n};"
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000011",
      "name": "Add Media Path",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 180]
    },
    {
      "parameters": {
        "jsCode": "return $input.item;"
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000012",
      "name": "No Media",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 420]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "id": "b2c3d4e5-0001-4000-8000-000000000013",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Prepare",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare": {
      "main": [
        [
          {
            "node": "Has Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Audio?": {
      "main": [
        [
          {
            "node": "Download Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Audio": {
      "main": [
        [
          {
            "node": "Whisper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Whisper": {
      "main": [
        [
          {
            "node": "Add Transcription",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Transcription": {
      "main": [
        [
          {
            "node": "Has Media?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Audio": {
      "main": [
        [
          {
            "node": "Has Media?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Media?": {
      "main": [
        [
          {
            "node": "Proxy Fetch Media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proxy Fetch Media": {
      "main": [
        [
          {
            "node": "Save Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Media": {
      "main": [
        [
          {
            "node": "Add Media Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add Media Path": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Media": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2024-12-17T12:00:00.000Z",
  "versionId": "1"
}
