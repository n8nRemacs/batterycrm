version: '3.8'

services:
  tunnel-server:
    build: .
    container_name: tunnel-server
    restart: unless-stopped
    ports:
      - "8800:8800"
    environment:
      - HOST=0.0.0.0
      - PORT=8800
      - LOG_LEVEL=INFO
      # PostgreSQL
      - POSTGRES_HOST=${POSTGRES_HOST:-185.221.214.83}
      - POSTGRES_PORT=${POSTGRES_PORT:-6544}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-supabase_admin}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      # Neo4j
      - NEO4J_URI=${NEO4J_URI:-bolt+ssc://45.144.177.128:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-45.144.177.128}
      - REDIS_PORT=${REDIS_PORT:-6379}
      # n8n
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://n8n.n8nsrv.ru/webhook/incoming}
    volumes:
      - ./logs:/app/logs
    networks:
      - eldoleado
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8800/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  eldoleado:
    external: true
