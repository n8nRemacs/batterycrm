# –ü–ª–∞–Ω –ø–µ—Ä–µ—Ö–æ–¥–∞: Android API + –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ò–ò

**–î–∞—Ç–∞:** 2025-11-21 08:00 (UTC+4)  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** 146,000 / 190,000 —Ç–æ–∫–µ–Ω–æ–≤ (77%)  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Android API, –ø–µ—Ä–µ—Ö–æ–¥ –∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ

---

## ‚úÖ –ß–¢–û –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–û

### 1. Android API Endpoints - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

**–í—Å–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç:**

| Endpoint | URL | Status | Test Result |
|----------|-----|--------|-------------|
| **Auth** | `POST /webhook/android/auth/login` | ‚úÖ Working | Session token generated |
| **Appeals List** | `GET /webhook/api/operator/appeals/list` | ‚úÖ Working | Returns 20 appeals |
| **Appeal Detail** | `GET /webhook/.../api/operator/appeals/:id` | ‚úÖ Working | Returns appeal + meta |
| **Take Appeal** | `POST /webhook/.../api/operator/appeals/:id/take` | ‚úÖ Working | Appeal taken successfully |
| **Send Response** | `POST /webhook/.../api/operator/appeals/:id/send` | ‚úÖ Working | Message sent (TG error due to test data) |

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ —Å `operators.session_token` –Ω–∞ `operator_devices.session_token`
- ‚úÖ –í—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `operator_devices` –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ Multi-tenant –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ `tenant_id` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Session token –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ header `x-session-token`

**–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```powershell
# Auth
login: "testoperator"
password: "password123"
session_token: "4e9afe35-6901-4655-8226-5976e3dc4dd7"

# Test tenant
tenant_id: "a0000000-0000-0000-0000-000000000001"
operator_id: "7b3aac9e-80c5-4787-b29f-f90fd763183a"

# Test appeal
appeal_id: "5dcf855d-1049-4882-924b-ead254f01175"
```

### 2. Meta API –¥–ª—è Appeal Detail - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

**–°–æ–∑–¥–∞–Ω workflow `Tool - Build Appeal Meta` (WiDRlsmHntaD6PM0):**

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- Execute Workflow Trigger ‚Üí –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `appeal_id`, `tenant_id`
- Fetch Appeal Data ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ appeal —Å JOIN
- Fetch Meta Config ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- Build Meta Array ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
1. `appeal_meta_config` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (15 —Å—Ç—Ä–æ–∫)
2. `appeal_meta_visibility` - –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø—É —Å–¥–µ–ª–∫–∏ (15 —Å—Ç—Ä–æ–∫)

**–¢–∏–ø—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `text` - –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
- `date` - —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY
- `duration` - "X –º–∏–Ω—É—Ç"
- `currency` - "X XXX ‚ÇΩ"
- `boolean` - —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ ("Telegram, WhatsApp, –¢–µ–ª–µ—Ñ–æ–Ω")

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ meta:**
```
appeal:  stage, deal_type, sales_channel, lead_source, repair_type, 
         parts_owner, estimated_cost, estimated_time, created_at
client:  client_name, client_phone, client_channels
device:  brand_model, issue_type, issue
```

**–õ–æ–≥–∏–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏:**
- –ï—Å–ª–∏ `appeal_meta_visibility` –ø—É—Å—Ç–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ ‚Üí —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ `is_visible`
- –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (`null`) –Ω–µ –≤–∫–ª—é—á–∞—é—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤ `meta`

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–∏–ø–æ–≤ —Å–¥–µ–ª–æ–∫:**
- **–°–ø–∞–º**: —Å–∫—Ä—ã—Ç—ã issue_type, issue, repair_type, parts_owner, brand_model
- **–ü–æ–∫—É–ø–∫–∞/–ü—Ä–æ–¥–∞–∂–∞**: —Å–∫—Ä—ã—Ç—ã issue_type, issue, repair_type, parts_owner, estimated_time
- **–†–µ–º–æ–Ω—Ç**: –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–¥–∞ `Tool - Build Appeal Meta` –≤ `API_Operator_Appeal_Detail`
- `waitForSubWorkflow: true` - –∂–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç –º–µ—Ä–∂–∏—Ç—Å—è —Å appeal data —á–µ—Ä–µ–∑ `Merge Meta` (Append mode)
- Meta –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `Format Response` ‚Üí `appeal.meta`

**–†–µ–∑—É–ª—å—Ç–∞—Ç API:**
```json
{
  "success": true,
  "appeal": {
    "id": "...",
    "stage": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç",
    "meta": [
      {"id": "stage", "label": "–°—Ç–∞–¥–∏—è", "value": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç", "group": "appeal", "order": "100"},
      {"id": "created_at", "label": "–°–æ–∑–¥–∞–Ω–æ", "value": "02.10.2025", "group": "appeal", "order": "500"}
    ]
  }
}
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ workflows

**API_Operator_Appeal_Detail:**
- ‚úÖ SQL –≤ `Get Tenant` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `operator_devices`
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω `Tool - Build Appeal Meta`
- ‚úÖ `waitForSubWorkflow: true` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**API_Operator_Take_Appeal:**
- ‚úÖ `Parse Params` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç session_token –∏–∑ headers
- ‚úÖ `Get Operator` SQL ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `operator_devices`

**API_Operator_Send_Response:**
- ‚úÖ `Parse Params` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç session_token –∏ message_text
- ‚úÖ `Get Context` SQL ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `operator_devices`
- ‚úÖ `Normalize` ‚Üí –ø–µ—Ä–µ–¥–∞–µ—Ç response_text

**Tool - Build Appeal Meta:**
- ‚úÖ `Fetch Appeal Data` SQL ‚Üí —É–±—Ä–∞–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è (sales_channel_id, lead_source_id, issue_type_id)
- ‚úÖ `Fetch Meta Config` SQL ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ deal_type —á–µ—Ä–µ–∑ `appeal_meta_visibility`
- ‚úÖ `Merge Data` ‚Üí —Ä–µ–∂–∏–º Append
- ‚úÖ `Build Meta Array` ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–∞–∫ appeal data

**BAT OUT Telegram:**
- ‚úÖ `Merge Context` ‚Üí –ø–µ—Ä–µ–¥–∞–µ—Ç message_text –∏–∑ Prepare Context

### 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –∏–∑–º–µ–Ω–µ–Ω–∏—è

**Constraint –æ–±–Ω–æ–≤–ª–µ–Ω:**
```sql
ALTER TABLE appeal_meta_config 
ADD CONSTRAINT appeal_meta_config_format_type_check 
CHECK (format_type IN ('text', 'date', 'duration', 'currency', 'boolean'));
```

**–î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã:**
- `appeal_meta_config`: 15 —Å—Ç—Ä–æ–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `appeal_meta_visibility`: 15 —Å—Ç—Ä–æ–∫ –ø—Ä–∞–≤–∏–ª –¥–ª—è –°–ø–∞–º/–ü–æ–∫—É–ø–∫–∞/–ü—Ä–æ–¥–∞–∂–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î:** 37 —Ç–∞–±–ª–∏—Ü (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## üîç –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (minor)

### 1. –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –≤ Appeals List
**–ü—Ä–æ–±–ª–µ–º–∞:** `problem` –ø–æ–ª–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "√ê‚Äî√ê¬∞√ê¬ø√ë‚Ä°√ê¬∞√ë√ë‚Äö√ë≈í: –Ω–∞—à–∞" –≤–º–µ—Å—Ç–æ "–ó–∞–ø—á–∞—Å—Ç—å: –Ω–∞—à–∞"
**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥–∏—Ä–æ–≤–∫–∞ UTF-8 –≤ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** Low (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### 2. `last_message: "undefined"` –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö appeals
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ appeals –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "undefined" –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞
**–ü—Ä–∏—á–∏–Ω–∞:** SQL –≤ `API_Operator_Appeals_List` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NULL –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** Low (–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞)

### 3. Telegram chat not found
**–ü—Ä–æ–±–ª–µ–º–∞:** Send Response –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "chat not found"
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º telegram_id
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–µ –ø—Ä–æ–±–ª–µ–º–∞ (–Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

## üìã –ó–ê–î–ê–ß–ò –ù–ê –¢–ï–ö–£–©–ò–ô –ú–û–ú–ï–ù–¢

### –ü–†–ò–û–†–ò–¢–ï–¢ 0: –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å Frontend

**–í–æ–ø—Ä–æ—Å—ã –¥–ª—è Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**

1. **–ö–∞–∫–∏–µ —ç–∫—Ä–∞–Ω—ã Android app –≥–æ—Ç–æ–≤—ã?**
   - Login screen?
   - Appeals list?
   - Appeal detail?
   - Chat/messaging?

2. **–ö–∞–∫–∏–µ API endpoints —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã?**
   - Auth —Ä–∞–±–æ—Ç–∞–µ—Ç?
   - Appeals List –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è?
   - Take Appeal —Ä–∞–±–æ—Ç–∞–µ—Ç?
   - Send Response —Ä–∞–±–æ—Ç–∞–µ—Ç?

3. **–ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ Frontend?**
   - –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ API?
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö?
   - –ù—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ API?

4. **–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –≤ API –¥–ª—è Frontend?**
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ endpoints?
   - –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç response?
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã?

**–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏.**

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ò–ò - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞

### –ü—Ä–æ–±–ª–µ–º–∞
**–ò–ò —Ç–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞.**

–°–µ–π—á–∞—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
- –ò–ò –Ω–µ –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã appeal –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è
- –î–∏–∞–ª–æ–≥ —Ä–∞–∑–æ—Ä–≤–∞–Ω, –Ω–µ—Ç —Å–≤—è–∑–Ω–æ—Å—Ç–∏

### –†–µ—à–µ–Ω–∏–µ: Context Management System

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
1. –•—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤ –ø–∞–º—è—Ç–∏ –ò–ò
2. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
4. –û–±–Ω–æ–≤–ª—è—Ç—å appeal –ø–æ –º–µ—Ä–µ —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Client Message
     ‚Üì
[BAT Message Router]
     ‚Üì
[BAT AI Appeal Router]
     ‚Üì
[Build Context from DB] ‚Üê –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π + —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã appeal
     ‚Üì
[Claude API Request] ‚Üê –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
     ‚Üì
[Extract Parameters] ‚Üê brand, model, issue, etc.
     ‚Üì
[Update Appeal in DB] ‚Üê –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
     ‚Üì
[Generate Response]
     ‚Üì
[Send to Client]
```

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**

#### 1. –°–æ–∑–¥–∞—Ç—å Workflow: `Tool - Build AI Context`

**Input:**
- `appeal_id`
- `tenant_id`

**Output:**
```json
{
  "conversation_history": [
    {"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç, —Ö–æ—á—É –∑–∞–º–µ–Ω–∏—Ç—å –±–∞—Ç–∞—Ä–µ—é"},
    {"role": "assistant", "content": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ù–∞ –∫–∞–∫–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ?"},
    {"role": "user", "content": "iPhone 14"},
    {"role": "assistant", "content": "–û—Ç–ª–∏—á–Ω–æ! –ö–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–æ?"}
  ],
  "current_parameters": {
    "brand": "Apple",
    "model": "iPhone 14",
    "issue_type": "–ó–∞–º–µ–Ω–∞ –±–∞—Ç–∞—Ä–µ–∏",
    "parts_owner": null,
    "estimated_cost": null
  },
  "missing_parameters": ["parts_owner", "appointment_time"],
  "stage": "–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. Fetch –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ `messages_history`
2. Fetch —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `appeals`
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã
4. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å
5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è Claude API

#### 2. –û–±–Ω–æ–≤–∏—Ç—å `BAT AI Appeal Router`

**–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ):**
```javascript
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
const response = await claudeAPI({
  messages: [{ role: "user", content: currentMessage }]
});
```

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
```javascript
// 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
const context = await executeWorkflow('Tool - Build AI Context', {
  appeal_id: appealId,
  tenant_id: tenantId
});

// 2. –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
const systemPrompt = `
–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ —Ä–µ–º–æ–Ω—Ç—É —Ç–µ—Ö–Ω–∏–∫–∏.

–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞—â–µ–Ω–∏—è:
${JSON.stringify(context.current_parameters, null, 2)}

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å:
${context.missing_parameters.join(', ')}

–°—Ç–∞–¥–∏—è: ${context.stage}

–í–µ–¥–∏ –¥–∏–∞–ª–æ–≥ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å–æ–±–∏—Ä–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, 
–Ω–µ –∑–∞–¥–∞–≤–∞–π –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å—Ä–∞–∑—É. –û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
`;

// 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
const response = await claudeAPI({
  system: systemPrompt,
  messages: [
    ...context.conversation_history,
    { role: "user", content: currentMessage }
  ]
});

// 4. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
const extracted = extractParameters(response);

// 5. –û–±–Ω–æ–≤–ª—è–µ–º appeal
await updateAppeal(appealId, extracted);
```

#### 3. –°–æ–∑–¥–∞—Ç—å `Tool - Extract Parameters`

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Claude –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
```javascript
const extractionPrompt = `
–ò–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –∏–∑–≤–ª–µ–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–º–æ–Ω—Ç–∞:

${conversationHistory}

–í–µ—Ä–Ω–∏ JSON:
{
  "brand": "–Ω–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –∏–ª–∏ null",
  "model": "–º–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ null",
  "issue_type": "—Ç–∏–ø –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ null",
  "issue": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ null",
  "parts_owner": "–Ω–∞—à–∞/–∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ null",
  "estimated_time": "–≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö –∏–ª–∏ null"
}

–í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ JSON, –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ.
`;

const result = await claudeAPI({
  messages: [{ role: "user", content: extractionPrompt }],
  max_tokens: 500
});

const params = JSON.parse(result.content[0].text);
```

#### 4. –û–±–Ω–æ–≤–∏—Ç—å `appeals` –ø–æ –º–µ—Ä–µ —Å–±–æ—Ä–∞

**SQL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
```sql
UPDATE appeals 
SET 
  brand_id = COALESCE($1, brand_id),
  model_id = COALESCE($2, model_id),
  repair_type_id = COALESCE($3, repair_type_id),
  parts_owner = COALESCE($4, parts_owner),
  estimated_time = COALESCE($5, estimated_time),
  estimated_cost = COALESCE($6, estimated_cost),
  stage = CASE 
    WHEN –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–±—Ä–∞–Ω—ã THEN '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ'
    ELSE '–°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'
  END,
  updated_at = NOW()
WHERE id = $7 AND tenant_id = $8;
```

**–õ–æ–≥–∏–∫–∞:** –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω—ã (–Ω–µ NULL).

### –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (5-7 —á–∞—Å–æ–≤):

**–®–∞–≥ 1: Tool - Build AI Context (1-2 —á–∞—Å–∞)**
- –°–æ–∑–¥–∞—Ç—å workflow
- SQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- SQL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ appeal
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Claude API
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–®–∞–≥ 2: Tool - Extract Parameters (1 —á–∞—Å)**
- –°–æ–∑–¥–∞—Ç—å workflow
- –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ü–∞—Ä—Å–∏–Ω–≥ JSON response
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å BAT AI Appeal Router (2-3 —á–∞—Å–∞)**
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Tool - Build AI Context
- –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç —Å–∏—Å—Ç–µ–º—ã
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è appeal
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏

**–®–∞–≥ 4: –õ–æ–≥–∏–∫–∞ —Å—Ç–∞–¥–∏–π (1 —á–∞—Å)**
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –≤ "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ stage –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 —á–∞—Å–∞)**
- –¢–µ—Å—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 2: –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ Appeal Detail –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ:
- –¢—Ä–∞—Ç–∏—Ç —Ç—Ä–∞—Ñ–∏–∫
- –ó–∞–º–µ–¥–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É
- –ó–∞–Ω–∏–º–∞–µ—Ç –ø–∞–º—è—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ "—Å–≤–µ–∂–∏–µ" (–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) –∏ "–∞—Ä—Ö–∏–≤–Ω—ã–µ" (–º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö).

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–°–≤–µ–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30-50):**
```json
{
  "id": "msg-123",
  "created_at": "2025-11-20T10:00:00Z",
  "message_type": "client",
  "message_text": "–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...",
  "media_url": "https://...",
  "media_type": "image",
  "operator_name": "–ò–≤–∞–Ω",
  "is_edited": false
}
```

**–ê—Ä—Ö–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π –∏–ª–∏ >50 –≤ –¥–∏–∞–ª–æ–≥–µ):**
```json
{
  "id": "msg-001",
  "created_at": "2025-10-15T10:00:00Z",
  "preview": "–ü–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞...",
  "has_media": true
}
```

### API –∏–∑–º–µ–Ω–µ–Ω–∏—è

**Endpoint:** `GET /api/operator/appeals/:id`

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `?mode=compact` (default) - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –ø–æ–ª–Ω—ã–µ + —Å—Ç–∞—Ä—ã–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ
- `?mode=full` - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- `?load_message=msg-001` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

**Response format:**
```json
{
  "success": true,
  "appeal": { ... },
  "history": {
    "recent": [
      { /* –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å–æ–æ–±—â–µ–Ω–∏–π */ }
    ],
    "archived": [
      { "id": "msg-001", "created_at": "...", "preview": "..." }
    ],
    "total_count": 156,
    "archived_count": 106
  }
}
```

### Android –ª–æ–≥–∏–∫–∞

**SQLite –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:**
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  appeal_id TEXT,
  created_at DATETIME,
  message_type TEXT,
  message_text TEXT NULL,  -- NULL –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö
  preview TEXT,
  is_archived BOOLEAN DEFAULT FALSE,
  media_url TEXT NULL,
  operator_name TEXT NULL
);
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ó–∞–≥—Ä—É–∂–∞–µ–º appeal —Å `mode=compact`
2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤–µ–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ —Ç–æ–ª—å–∫–æ id+date+preview
4. –ü—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –≤–≤–µ—Ä—Ö –∫ –∞—Ä—Ö–∏–≤–Ω—ã–º ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ `?load_message=X`
5. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (—Ä–∞–∑ –≤ –¥–µ–Ω—å) –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

**–ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:**
- –°–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π ‚Üí —É–¥–∞–ª–∏—Ç—å `message_text`, –æ—Å—Ç–∞–≤–∏—Ç—å `preview`
- Completed appeals —Å—Ç–∞—Ä—à–µ 14 –¥–Ω–µ–π ‚Üí —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –•—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Å–∏–º—É–º 500 —Å–≤–µ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ

### –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (3-4 —á–∞—Å–∞):

**–®–∞–≥ 1: SQL –∏–∑–º–µ–Ω–µ–Ω–∏—è (30 –º–∏–Ω)**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ preview
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —Å –ª–∏–º–∏—Ç–∞–º–∏

**–®–∞–≥ 2: API –∏–∑–º–µ–Ω–µ–Ω–∏—è (1 —á–∞—Å)**
- –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `mode` –≤ Appeal Detail
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É compact/full
- –ù–æ–≤—ã–π endpoint –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

**–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API (30 –º–∏–Ω)**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å compact mode
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É archived —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò–∑–º–µ—Ä–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏—é —Ç—Ä–∞—Ñ–∏–∫–∞

**–®–∞–≥ 4: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å Frontend (1-2 —á–∞—Å–∞)**
- –û–±—ä—è—Å–Ω–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- –ü–æ–º–æ—á—å —Å SQLite —Å—Ö–µ–º–æ–π
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ß–∏—Å—Ç–∫–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–Ω—ã—Ö appeals

### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** Appeals –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, —Å—Ç–∞—Ä—ã–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ.

**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è/—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º.

### –ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:**
1. Stage = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" –ò –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 14+ –¥–Ω–µ–π
2. Stage = "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç" –ò –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π 14+ –¥–Ω–µ–π
3. Stage = "–°–ø–∞–º" –ò —Å–æ–∑–¥–∞–Ω–æ 7+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏:**
- Appeal –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –ë–î
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ñ–ª–∞–≥ `is_archived = true`
- –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ Appeals List –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ú–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ—Ä–µ–∑ `?include_archived=true`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:**
- Stage = "–°–ø–∞–º" –ò —Å–æ–∑–¥–∞–Ω–æ 90+ –¥–Ω–µ–π –Ω–∞–∑–∞–¥
- Stage = "–ó–∞–≤–µ—Ä—à–µ–Ω–æ" –ò –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 180+ –¥–Ω–µ–π
- –£–¥–∞–ª—è—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (CASCADE)

### –¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```sql
ALTER TABLE appeals 
ADD COLUMN is_archived BOOLEAN DEFAULT FALSE,
ADD COLUMN archived_at TIMESTAMPTZ NULL;

CREATE INDEX idx_appeals_archived ON appeals(tenant_id, is_archived, updated_at);
```

### Workflow: `Tool - Archive Old Appeals`

**–ó–∞–ø—É—Å–∫:** Cron job —Ä–∞–∑ –≤ –¥–µ–Ω—å (03:00 UTC)

**–õ–æ–≥–∏–∫–∞:**
```sql
-- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
UPDATE appeals 
SET is_archived = TRUE, archived_at = NOW()
WHERE stage = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' 
  AND updated_at < NOW() - INTERVAL '14 days'
  AND is_archived = FALSE;

-- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ
UPDATE appeals 
SET is_archived = TRUE, archived_at = NOW()
WHERE stage = '–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç' 
  AND updated_at < NOW() - INTERVAL '14 days'
  AND is_archived = FALSE;

-- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∞–º
UPDATE appeals 
SET is_archived = TRUE, archived_at = NOW()
WHERE stage = '–°–ø–∞–º' 
  AND created_at < NOW() - INTERVAL '7 days'
  AND is_archived = FALSE;

-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Å–ø–∞–º
DELETE FROM appeals 
WHERE stage = '–°–ø–∞–º' 
  AND created_at < NOW() - INTERVAL '90 days';

-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
DELETE FROM appeals 
WHERE stage = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' 
  AND updated_at < NOW() - INTERVAL '180 days';
```

### Appeals List –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `?include_archived=false` (default) - —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
- `?include_archived=true` - –≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤–Ω—ã–µ
- `?archived_only=true` - —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤–Ω—ã–µ

### –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (2 —á–∞—Å–∞):

**–®–∞–≥ 1: –ë–î –∏–∑–º–µ–Ω–µ–Ω–∏—è (30 –º–∏–Ω)**
- ALTER TABLE –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è
- –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å

**–®–∞–≥ 2: Workflow –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ (1 —á–∞—Å)**
- –°–æ–∑–¥–∞—Ç—å Tool - Archive Old Appeals
- SQL –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
- SQL –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron

**–®–∞–≥ 3: Appeals List –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (30 –º–∏–Ω)**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ is_archived
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìä –°–¢–ê–¢–£–° –ü–†–û–ï–ö–¢–ê

**–í–µ—Ä—Å–∏—è –ë–î:** 5.1  
**n8n –≤–µ—Ä—Å–∏—è:** 1.103.3  
**–¢–∞–±–ª–∏—Ü –≤ –ë–î:** 37  
**Workflows:** 34 (–≤–∫–ª—é—á–∞—è Tool - Build Appeal Meta)

**–§–∞–∑–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** Android API Ready ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –ò–ò

**Android Endpoints —Å—Ç–∞—Ç—É—Å:**
- ‚úÖ Auth
- ‚úÖ Appeals List  
- ‚úÖ Appeal Detail (+ Meta API)
- ‚úÖ Take Appeal
- ‚úÖ Send Response
- ‚è≥ Normalize (–Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏)
- ‚è≥ Reject (–Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏)

**–°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã:**
1. –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å Frontend
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Context Management –¥–ª—è –ò–ò
3. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
4. –ê–≤—Ç–æ–∞—Ä—Ö–∏–≤–∞—Ü–∏—è appeals

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ë—ã–ª–æ:** `operators.session_token`
**–°—Ç–∞–ª–æ:** `operator_devices.session_token`

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ–¥–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å —Ä–∞–∑–ª–æ–≥–∏–Ω–æ–º –ø—Ä–∏ —Å–º–µ–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

**–¢–∞–±–ª–∏—Ü–∞ `operator_devices`:**
```sql
CREATE TABLE operator_devices (
  id UUID PRIMARY KEY,
  operator_id UUID REFERENCES operators(id),
  tenant_id UUID REFERENCES tenants(id),
  device_type VARCHAR(50), -- 'mobile', 'web', 'desktop'
  session_token VARCHAR(255) UNIQUE,
  fcm_token VARCHAR(255),
  device_id VARCHAR(255),
  device_info JSONB,
  created_at TIMESTAMPTZ,
  last_active_at TIMESTAMPTZ
);
```

**–õ–æ–≥–∏–∫–∞ Auth:**
1. User –≤–≤–æ–¥–∏—Ç login/password
2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ `device_type='mobile'` –¥–ª—è —ç—Ç–æ–≥–æ operator
3. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å –Ω–æ–≤—ã–º session_token
4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º session_token –∫–ª–∏–µ–Ω—Ç—É

**–í—Å–µ API endpoints –ø—Ä–æ–≤–µ—Ä—è—é—Ç:**
```sql
SELECT od.operator_id, od.tenant_id 
FROM operator_devices od
JOIN operators o ON o.id = od.operator_id
WHERE od.session_token = '...'
  AND od.device_type = 'mobile'
  AND o.is_active = true
LIMIT 1;
```

### Workflows –∏–∑–º–µ–Ω–µ–Ω–∏—è summary

**–û–±–Ω–æ–≤–ª–µ–Ω—ã SQL –∑–∞–ø—Ä–æ—Å—ã –≤:**
- API_Operator_Appeal_Detail ‚Üí Get Tenant
- API_Operator_Appeals_List ‚Üí Get Tenant –ø–æ operator_id
- API_Operator_Take_Appeal ‚Üí Get Operator
- API_Operator_Send_Response ‚Üí Get Context

**–í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω:**
```sql
FROM operator_devices od
JOIN operators o ON o.id = od.operator_id
WHERE od.session_token = '{{ $json.session_token }}'
```

---

## üìù –í–ê–ñ–ù–´–ï –§–ê–ô–õ–´

**–û–±–Ω–æ–≤–ª–µ–Ω—ã:**
- `/mnt/project/Database_Structure_BatteryCRM_COMPLETE.md` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ 37 (appeal_meta_visibility)
- `/mnt/project/API_Operator_Appeal_Detail.json` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è meta
- `/home/claude/Tool_Build_Appeal_Meta.json` - –Ω–æ–≤—ã–π workflow

**–°–æ–∑–¥–∞–Ω—ã:**
- `TRANSITION_PLAN_2025-11-21_08-00.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

**–¢—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
- `Webhook_Android_API.txt` - –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å URL endpoints
- `ANDROID_ENDPOINTS_WORK_PLAN.md` - –ø–æ–º–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã:

1. **–£—Ç–æ—á–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å Frontend** (30 –º–∏–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä–∞)
   - –ö–∞–∫–∏–µ —ç–∫—Ä–∞–Ω—ã –≥–æ—Ç–æ–≤—ã
   - –ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –µ—Å—Ç—å
   - –ß—Ç–æ –Ω—É–∂–Ω–æ –≤ API

2. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á–∏** (15 –º–∏–Ω)
   - –ß—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è Frontend
   - –ß—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

3. **–ù–∞—á–∞—Ç—å —Å Context Management** (–µ—Å–ª–∏ Frontend –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é)
   - –≠—Ç–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-—Ñ–∏—á–∞
   - –£–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤
   - –î–∞—Å—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

4. **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** (–µ—Å–ª–∏ Frontend –ø—Ä–æ—Å–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é)
   - –°–Ω–∏–∑–∏—Ç —Ç—Ä–∞—Ñ–∏–∫
   - –£—Å–∫–æ—Ä–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É
   - –£–ª—É—á—à–∏—Ç UX

### –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –∫–æ–Ω—á–∞—é—Ç—Å—è:

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
2. –°–æ–∑–¥–∞—Ç—å transition plan
3. –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é —Å —á—Ç–µ–Ω–∏—è transition plan
4. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞ –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å

---

## üöÄ –° –ß–ï–ì–û –ù–ê–ß–ê–¢–¨ –í –ù–û–í–û–ú –û–ö–ù–ï

### –í–∞—Ä–∏–∞–Ω—Ç A: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç transition plan
2. –°–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ —Å—Ç–∞—Ç—É—Å Frontend
3. –ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é Context Management:
   - –°–æ–∑–¥–∞—Ç—å `Tool - Build AI Context`
   - –û–±–Ω–æ–≤–∏—Ç—å `BAT AI Appeal Router`
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –í–∞—Ä–∏–∞–Ω—Ç B: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å —Å Frontend

1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç transition plan
2. –°–æ–∑–≤–æ–Ω–∏—Ç—å—Å—è —Å Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
4. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å
5. –ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç C: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ endpoints

1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ—Ç transition plan
2. –°–ø–∏—Å–æ–∫ —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å (–æ—Ç Frontend)
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ —Å–ø–∏—Å–∫—É
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
5. –ü–µ—Ä–µ–¥–∞—Ç—å Frontend –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

---

## END OF TRANSITION PLAN

**–°–æ–∑–¥–∞–Ω:** 2025-11-21 08:00 (UTC+4)  
**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** 146,000 / 190,000 —Ç–æ–∫–µ–Ω–æ–≤ (77%)  
**–°–ª–µ–¥—É—é—â–∞—è —Å–µ—Å—Å–∏—è:** –£—Ç–æ—á–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å Frontend ‚Üí Context Management